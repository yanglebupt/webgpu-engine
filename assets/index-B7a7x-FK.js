var qm=Object.defineProperty;var $m=(ke,C,I)=>C in ke?qm(ke,C,{enumerable:!0,configurable:!0,writable:!0,value:I}):ke[C]=I;var Hm=(ke,C)=>()=>(C||ke((C={exports:{}}).exports,C),C.exports);var w=(ke,C,I)=>($m(ke,typeof C!="symbol"?C+"":C,I),I);var Ym=Hm((Ce,Pe)=>{(async()=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();const ke=t=>t*Math.PI/180;let C=1e-6,I=Float32Array;function Pa(t){const e=I;return I=t,e}function ft(t=0,e=0){const r=new I(2);return t!==void 0&&(r[0]=t,e!==void 0&&(r[1]=e)),r}let N=Float32Array;function Oa(t){const e=N;return N=t,e}function re(t,e,r){const n=new N(3);return t!==void 0&&(n[0]=t,e!==void 0&&(n[1]=e,r!==void 0&&(n[2]=r))),n}const Ba=ft;function Na(t,e,r){return r=r||new I(2),r[0]=t,r[1]=e,r}function La(t,e){return e=e||new I(2),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function Ia(t,e){return e=e||new I(2),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function za(t,e){return e=e||new I(2),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function Ua(t,e=0,r=1,n){return n=n||new I(2),n[0]=Math.min(r,Math.max(e,t[0])),n[1]=Math.min(r,Math.max(e,t[1])),n}function Ga(t,e,r){return r=r||new I(2),r[0]=t[0]+e[0],r[1]=t[1]+e[1],r}function Fa(t,e,r,n){return n=n||new I(2),n[0]=t[0]+e[0]*r,n[1]=t[1]+e[1]*r,n}function Ra(t,e){const r=t[0],n=t[1],i=t[0],s=t[1],a=Math.sqrt(r*r+n*n),o=Math.sqrt(i*i+s*s),u=a*o,c=u&&bn(t,e)/u;return Math.acos(c)}function gn(t,e,r){return r=r||new I(2),r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}const Da=gn;function Va(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C}function ja(t,e){return t[0]===e[0]&&t[1]===e[1]}function vn(t,e,r,n){return n=n||new I(2),n[0]=t[0]+r*(e[0]-t[0]),n[1]=t[1]+r*(e[1]-t[1]),n}function qa(t,e,r,n){return n=n||new I(2),n[0]=t[0]+r[0]*(e[0]-t[0]),n[1]=t[1]+r[1]*(e[1]-t[1]),n}function $a(t,e,r){return r=r||new I(2),r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r}function Ha(t,e,r){return r=r||new I(2),r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r}function pr(t,e,r){return r=r||new I(2),r[0]=t[0]*e,r[1]=t[1]*e,r}const Ya=pr;function Wa(t,e,r){return r=r||new I(2),r[0]=t[0]/e,r[1]=t[1]/e,r}function yn(t,e){return e=e||new I(2),e[0]=1/t[0],e[1]=1/t[1],e}const Xa=yn;function Ja(t,e,r){r=r||new N(3);const n=t[0]*e[1]-t[1]*e[0];return r[0]=0,r[1]=0,r[2]=n,r}function bn(t,e){return t[0]*e[0]+t[1]*e[1]}function fr(t){const e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}const Ka=fr;function wn(t){const e=t[0],r=t[1];return e*e+r*r}const Qa=wn;function xn(t,e){const r=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(r*r+n*n)}const Za=xn;function kn(t,e){const r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n}const eo=kn;function Sn(t,e){e=e||new I(2);const r=t[0],n=t[1],i=Math.sqrt(r*r+n*n);return i>1e-5?(e[0]=r/i,e[1]=n/i):(e[0]=0,e[1]=0),e}function to(t,e){return e=e||new I(2),e[0]=-t[0],e[1]=-t[1],e}function mr(t,e){return e=e||new I(2),e[0]=t[0],e[1]=t[1],e}const ro=mr;function Tn(t,e,r){return r=r||new I(2),r[0]=t[0]*e[0],r[1]=t[1]*e[1],r}const no=Tn;function En(t,e,r){return r=r||new I(2),r[0]=t[0]/e[0],r[1]=t[1]/e[1],r}const io=En;function so(t=1,e){e=e||new I(2);const r=Math.random()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e}function ao(t){return t=t||new I(2),t[0]=0,t[1]=0,t}function oo(t,e,r){r=r||new I(2);const n=t[0],i=t[1];return r[0]=n*e[0]+i*e[4]+e[12],r[1]=n*e[1]+i*e[5]+e[13],r}function uo(t,e,r){r=r||new I(2);const n=t[0],i=t[1];return r[0]=e[0]*n+e[4]*i+e[8],r[1]=e[1]*n+e[5]*i+e[9],r}function co(t,e,r,n){n=n||new I(2);const i=t[0]-e[0],s=t[1]-e[1],a=Math.sin(r),o=Math.cos(r);return n[0]=i*o-s*a+e[0],n[1]=i*a+s*o+e[1],n}function Mn(t,e,r){return r=r||new I(2),Sn(t,r),pr(r,e,r)}function lo(t,e,r){return r=r||new I(2),fr(t)>e?Mn(t,e,r):mr(t,r)}function ho(t,e,r){return r=r||new I(2),vn(t,e,.5,r)}var K=Object.freeze({__proto__:null,add:Ga,addScaled:Fa,angle:Ra,ceil:La,clamp:Ua,clone:ro,copy:mr,create:ft,cross:Ja,dist:Za,distSq:eo,distance:xn,distanceSq:kn,div:io,divScalar:Wa,divide:En,dot:bn,equals:ja,equalsApproximately:Va,floor:Ia,fromValues:Ba,inverse:yn,invert:Xa,len:Ka,lenSq:Qa,length:fr,lengthSq:wn,lerp:vn,lerpV:qa,max:$a,midpoint:ho,min:Ha,mul:no,mulScalar:pr,multiply:Tn,negate:to,normalize:Sn,random:so,rotate:co,round:za,scale:Ya,set:Na,setDefaultType:Pa,setLength:Mn,sub:Da,subtract:gn,transformMat3:uo,transformMat4:oo,truncate:lo,zero:ao});let An=Float32Array;const Cn=new Map([[Float32Array,()=>new Float32Array(12)],[Float64Array,()=>new Float64Array(12)],[Array,()=>new Array(12).fill(0)]]);let ee=Cn.get(Float32Array);function po(t){const e=An;return An=t,ee=Cn.get(t),e}function fo(t,e,r,n,i,s,a,o,u){const c=ee();return c[3]=0,c[7]=0,c[11]=0,t!==void 0&&(c[0]=t,e!==void 0&&(c[1]=e,r!==void 0&&(c[2]=r,n!==void 0&&(c[4]=n,i!==void 0&&(c[5]=i,s!==void 0&&(c[6]=s,a!==void 0&&(c[8]=a,o!==void 0&&(c[9]=o,u!==void 0&&(c[10]=u))))))))),c}function mo(t,e,r,n,i,s,a,o,u,c){return c=c||ee(),c[0]=t,c[1]=e,c[2]=r,c[3]=0,c[4]=n,c[5]=i,c[6]=s,c[7]=0,c[8]=a,c[9]=o,c[10]=u,c[11]=0,c}function _o(t,e){return e=e||ee(),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e}function go(t,e){e=e||ee();const r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,o=n+n,u=i+i,c=r*a,l=n*a,d=n*o,p=i*a,f=i*o,y=i*u,v=s*a,g=s*o,S=s*u;return e[0]=1-d-y,e[1]=l+S,e[2]=p-g,e[3]=0,e[4]=l-S,e[5]=1-c-y,e[6]=f+v,e[7]=0,e[8]=p+g,e[9]=f-v,e[10]=1-c-d,e[11]=0,e}function vo(t,e){return e=e||ee(),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e}function _r(t,e){return e=e||ee(),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[8]=t[8],e[9]=t[9],e[10]=t[10],e}const yo=_r;function bo(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[4]-e[4])<C&&Math.abs(t[5]-e[5])<C&&Math.abs(t[6]-e[6])<C&&Math.abs(t[8]-e[8])<C&&Math.abs(t[9]-e[9])<C&&Math.abs(t[10]-e[10])<C}function wo(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]}function Pn(t){return t=t||ee(),t[0]=1,t[1]=0,t[2]=0,t[4]=0,t[5]=1,t[6]=0,t[8]=0,t[9]=0,t[10]=1,t}function xo(t,e){if(e=e||ee(),e===t){let d;return d=t[1],t[1]=t[4],t[4]=d,d=t[2],t[2]=t[8],t[8]=d,d=t[6],t[6]=t[9],t[9]=d,e}const r=t[0*4+0],n=t[0*4+1],i=t[0*4+2],s=t[1*4+0],a=t[1*4+1],o=t[1*4+2],u=t[2*4+0],c=t[2*4+1],l=t[2*4+2];return e[0]=r,e[1]=s,e[2]=u,e[4]=n,e[5]=a,e[6]=c,e[8]=i,e[9]=o,e[10]=l,e}function On(t,e){e=e||ee();const r=t[0*4+0],n=t[0*4+1],i=t[0*4+2],s=t[1*4+0],a=t[1*4+1],o=t[1*4+2],u=t[2*4+0],c=t[2*4+1],l=t[2*4+2],d=l*a-o*c,p=-l*s+o*u,f=c*s-a*u,y=1/(r*d+n*p+i*f);return e[0]=d*y,e[1]=(-l*n+i*c)*y,e[2]=(o*n-i*a)*y,e[4]=p*y,e[5]=(l*r-i*u)*y,e[6]=(-o*r+i*s)*y,e[8]=f*y,e[9]=(-c*r+n*u)*y,e[10]=(a*r-n*s)*y,e}function ko(t){const e=t[0],r=t[0*4+1],n=t[0*4+2],i=t[1*4+0],s=t[1*4+1],a=t[1*4+2],o=t[2*4+0],u=t[2*4+1],c=t[2*4+2];return e*(s*c-u*a)-i*(r*c-u*n)+o*(r*a-s*n)}const So=On;function Bn(t,e,r){r=r||ee();const n=t[0],i=t[1],s=t[2],a=t[4],o=t[5],u=t[6],c=t[8],l=t[9],d=t[10],p=e[0],f=e[1],y=e[2],v=e[4],g=e[5],S=e[6],T=e[8],E=e[9],M=e[10];return r[0]=n*p+a*f+c*y,r[1]=i*p+o*f+l*y,r[2]=s*p+u*f+d*y,r[4]=n*v+a*g+c*S,r[5]=i*v+o*g+l*S,r[6]=s*v+u*g+d*S,r[8]=n*T+a*E+c*M,r[9]=i*T+o*E+l*M,r[10]=s*T+u*E+d*M,r}const To=Bn;function Eo(t,e,r){return r=r||Pn(),t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[4]=t[4],r[5]=t[5],r[6]=t[6]),r[8]=e[0],r[9]=e[1],r[10]=1,r}function Mo(t,e){return e=e||ft(),e[0]=t[8],e[1]=t[9],e}function Ao(t,e,r){r=r||ft();const n=e*4;return r[0]=t[n+0],r[1]=t[n+1],r}function Co(t,e,r,n){n!==t&&(n=_r(t,n));const i=r*4;return n[i+0]=e[0],n[i+1]=e[1],n}function Po(t,e){e=e||ft();const r=t[0],n=t[1],i=t[4],s=t[5];return e[0]=Math.sqrt(r*r+n*n),e[1]=Math.sqrt(i*i+s*s),e}function Oo(t,e){return e=e||ee(),e[0]=1,e[1]=0,e[2]=0,e[4]=0,e[5]=1,e[6]=0,e[8]=t[0],e[9]=t[1],e[10]=1,e}function Bo(t,e,r){r=r||ee();const n=e[0],i=e[1],s=t[0],a=t[1],o=t[2],u=t[1*4+0],c=t[1*4+1],l=t[1*4+2],d=t[2*4+0],p=t[2*4+1],f=t[2*4+2];return t!==r&&(r[0]=s,r[1]=a,r[2]=o,r[4]=u,r[5]=c,r[6]=l),r[8]=s*n+u*i+d,r[9]=a*n+c*i+p,r[10]=o*n+l*i+f,r}function No(t,e){e=e||ee();const r=Math.cos(t),n=Math.sin(t);return e[0]=r,e[1]=n,e[2]=0,e[4]=-n,e[5]=r,e[6]=0,e[8]=0,e[9]=0,e[10]=1,e}function Lo(t,e,r){r=r||ee();const n=t[0*4+0],i=t[0*4+1],s=t[0*4+2],a=t[1*4+0],o=t[1*4+1],u=t[1*4+2],c=Math.cos(e),l=Math.sin(e);return r[0]=c*n+l*a,r[1]=c*i+l*o,r[2]=c*s+l*u,r[4]=c*a-l*n,r[5]=c*o-l*i,r[6]=c*u-l*s,t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10]),r}function Io(t,e){return e=e||ee(),e[0]=t[0],e[1]=0,e[2]=0,e[4]=0,e[5]=t[1],e[6]=0,e[8]=0,e[9]=0,e[10]=1,e}function zo(t,e,r){r=r||ee();const n=e[0],i=e[1];return r[0]=n*t[0*4+0],r[1]=n*t[0*4+1],r[2]=n*t[0*4+2],r[4]=i*t[1*4+0],r[5]=i*t[1*4+1],r[6]=i*t[1*4+2],t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10]),r}function Uo(t,e){return e=e||ee(),e[0]=t,e[1]=0,e[2]=0,e[4]=0,e[5]=t,e[6]=0,e[8]=0,e[9]=0,e[10]=1,e}function Go(t,e,r){return r=r||ee(),r[0]=e*t[0*4+0],r[1]=e*t[0*4+1],r[2]=e*t[0*4+2],r[4]=e*t[1*4+0],r[5]=e*t[1*4+1],r[6]=e*t[1*4+2],t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10]),r}var Nn=Object.freeze({__proto__:null,clone:yo,copy:_r,create:fo,determinant:ko,equals:wo,equalsApproximately:bo,fromMat4:_o,fromQuat:go,getAxis:Ao,getScaling:Po,getTranslation:Mo,identity:Pn,inverse:On,invert:So,mul:To,multiply:Bn,negate:vo,rotate:Lo,rotation:No,scale:zo,scaling:Io,set:mo,setAxis:Co,setDefaultType:po,setTranslation:Eo,translate:Bo,translation:Oo,transpose:xo,uniformScale:Go,uniformScaling:Uo});const Fo=re;function Ro(t,e,r,n){return n=n||new N(3),n[0]=t,n[1]=e,n[2]=r,n}function Do(t,e){return e=e||new N(3),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function Vo(t,e){return e=e||new N(3),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function jo(t,e){return e=e||new N(3),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function qo(t,e=0,r=1,n){return n=n||new N(3),n[0]=Math.min(r,Math.max(e,t[0])),n[1]=Math.min(r,Math.max(e,t[1])),n[2]=Math.min(r,Math.max(e,t[2])),n}function $o(t,e,r){return r=r||new N(3),r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}function Ho(t,e,r,n){return n=n||new N(3),n[0]=t[0]+e[0]*r,n[1]=t[1]+e[1]*r,n[2]=t[2]+e[2]*r,n}function Yo(t,e){const r=t[0],n=t[1],i=t[2],s=t[0],a=t[1],o=t[2],u=Math.sqrt(r*r+n*n+i*i),c=Math.sqrt(s*s+a*a+o*o),l=u*c,d=l&&vr(t,e)/l;return Math.acos(d)}function mt(t,e,r){return r=r||new N(3),r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}const Wo=mt;function Xo(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C}function Jo(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Ln(t,e,r,n){return n=n||new N(3),n[0]=t[0]+r*(e[0]-t[0]),n[1]=t[1]+r*(e[1]-t[1]),n[2]=t[2]+r*(e[2]-t[2]),n}function Ko(t,e,r,n){return n=n||new N(3),n[0]=t[0]+r[0]*(e[0]-t[0]),n[1]=t[1]+r[1]*(e[1]-t[1]),n[2]=t[2]+r[2]*(e[2]-t[2]),n}function Qo(t,e,r){return r=r||new N(3),r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r}function Zo(t,e,r){return r=r||new N(3),r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.min(t[2],e[2]),r}function gr(t,e,r){return r=r||new N(3),r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}const eu=gr;function tu(t,e,r){return r=r||new N(3),r[0]=t[0]/e,r[1]=t[1]/e,r[2]=t[2]/e,r}function In(t,e){return e=e||new N(3),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}const ru=In;function ge(t,e,r){r=r||new N(3);const n=t[2]*e[0]-t[0]*e[2],i=t[0]*e[1]-t[1]*e[0];return r[0]=t[1]*e[2]-t[2]*e[1],r[1]=n,r[2]=i,r}function vr(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function yr(t){const e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)}const zn=yr;function Un(t){const e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n}const nu=Un;function Gn(t,e){const r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)}const iu=Gn;function Fn(t,e){const r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}const su=Fn;function pe(t,e){e=e||new N(3);const r=t[0],n=t[1],i=t[2],s=Math.sqrt(r*r+n*n+i*i);return s>1e-5?(e[0]=r/s,e[1]=n/s,e[2]=i/s):(e[0]=0,e[1]=0,e[2]=0),e}function au(t,e){return e=e||new N(3),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function br(t,e){return e=e||new N(3),e[0]=t[0],e[1]=t[1],e[2]=t[2],e}const ou=br;function Rn(t,e,r){return r=r||new N(3),r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r}const uu=Rn;function Dn(t,e,r){return r=r||new N(3),r[0]=t[0]/e[0],r[1]=t[1]/e[1],r[2]=t[2]/e[2],r}const cu=Dn;function lu(t=1,e){e=e||new N(3);const r=Math.random()*2*Math.PI,n=Math.random()*2-1,i=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=n*t,e}function du(t){return t=t||new N(3),t[0]=0,t[1]=0,t[2]=0,t}function hu(t,e,r){r=r||new N(3);const n=t[0],i=t[1],s=t[2],a=e[3]*n+e[7]*i+e[11]*s+e[15]||1;return r[0]=(e[0]*n+e[4]*i+e[8]*s+e[12])/a,r[1]=(e[1]*n+e[5]*i+e[9]*s+e[13])/a,r[2]=(e[2]*n+e[6]*i+e[10]*s+e[14])/a,r}function pu(t,e,r){r=r||new N(3);const n=t[0],i=t[1],s=t[2];return r[0]=n*e[0*4+0]+i*e[1*4+0]+s*e[2*4+0],r[1]=n*e[0*4+1]+i*e[1*4+1]+s*e[2*4+1],r[2]=n*e[0*4+2]+i*e[1*4+2]+s*e[2*4+2],r}function fu(t,e,r){r=r||new N(3);const n=t[0],i=t[1],s=t[2];return r[0]=n*e[0]+i*e[4]+s*e[8],r[1]=n*e[1]+i*e[5]+s*e[9],r[2]=n*e[2]+i*e[6]+s*e[10],r}function mu(t,e,r){r=r||new N(3);const n=e[0],i=e[1],s=e[2],a=e[3]*2,o=t[0],u=t[1],c=t[2],l=i*c-s*u,d=s*o-n*c,p=n*u-i*o;return r[0]=o+l*a+(i*p-s*d)*2,r[1]=u+d*a+(s*l-n*p)*2,r[2]=c+p*a+(n*d-i*l)*2,r}function _u(t,e){return e=e||new N(3),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function gu(t,e,r){r=r||new N(3);const n=e*4;return r[0]=t[n+0],r[1]=t[n+1],r[2]=t[n+2],r}function vu(t,e){e=e||new N(3);const r=t[0],n=t[1],i=t[2],s=t[4],a=t[5],o=t[6],u=t[8],c=t[9],l=t[10];return e[0]=Math.sqrt(r*r+n*n+i*i),e[1]=Math.sqrt(s*s+a*a+o*o),e[2]=Math.sqrt(u*u+c*c+l*l),e}function yu(t,e,r,n){n=n||new N(3);const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0],s[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),s[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function bu(t,e,r,n){n=n||new N(3);const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),s[1]=i[1],s[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function wu(t,e,r,n){n=n||new N(3);const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),s[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),s[2]=i[2],n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function Vn(t,e,r){return r=r||new N(3),pe(t,r),gr(r,e,r)}function xu(t,e,r){return r=r||new N(3),yr(t)>e?Vn(t,e,r):br(t,r)}function ku(t,e,r){return r=r||new N(3),Ln(t,e,.5,r)}var Z=Object.freeze({__proto__:null,add:$o,addScaled:Ho,angle:Yo,ceil:Do,clamp:qo,clone:ou,copy:br,create:re,cross:ge,dist:iu,distSq:su,distance:Gn,distanceSq:Fn,div:cu,divScalar:tu,divide:Dn,dot:vr,equals:Jo,equalsApproximately:Xo,floor:Vo,fromValues:Fo,getAxis:gu,getScaling:vu,getTranslation:_u,inverse:In,invert:ru,len:zn,lenSq:nu,length:yr,lengthSq:Un,lerp:Ln,lerpV:Ko,max:Qo,midpoint:ku,min:Zo,mul:uu,mulScalar:gr,multiply:Rn,negate:au,normalize:pe,random:lu,rotateX:yu,rotateY:bu,rotateZ:wu,round:jo,scale:eu,set:Ro,setDefaultType:Oa,setLength:Vn,sub:Wo,subtract:mt,transformMat3:fu,transformMat4:hu,transformMat4Upper3x3:pu,transformQuat:mu,truncate:xu,zero:du});let U=Float32Array;function Su(t){const e=U;return U=t,e}function Tu(t,e,r,n,i,s,a,o,u,c,l,d,p,f,y,v){const g=new U(16);return t!==void 0&&(g[0]=t,e!==void 0&&(g[1]=e,r!==void 0&&(g[2]=r,n!==void 0&&(g[3]=n,i!==void 0&&(g[4]=i,s!==void 0&&(g[5]=s,a!==void 0&&(g[6]=a,o!==void 0&&(g[7]=o,u!==void 0&&(g[8]=u,c!==void 0&&(g[9]=c,l!==void 0&&(g[10]=l,d!==void 0&&(g[11]=d,p!==void 0&&(g[12]=p,f!==void 0&&(g[13]=f,y!==void 0&&(g[14]=y,v!==void 0&&(g[15]=v)))))))))))))))),g}function Eu(t,e,r,n,i,s,a,o,u,c,l,d,p,f,y,v,g){return g=g||new U(16),g[0]=t,g[1]=e,g[2]=r,g[3]=n,g[4]=i,g[5]=s,g[6]=a,g[7]=o,g[8]=u,g[9]=c,g[10]=l,g[11]=d,g[12]=p,g[13]=f,g[14]=y,g[15]=v,g}function Mu(t,e){return e=e||new U(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Au(t,e){e=e||new U(16);const r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,o=n+n,u=i+i,c=r*a,l=n*a,d=n*o,p=i*a,f=i*o,y=i*u,v=s*a,g=s*o,S=s*u;return e[0]=1-d-y,e[1]=l+S,e[2]=p-g,e[3]=0,e[4]=l-S,e[5]=1-c-y,e[6]=f+v,e[7]=0,e[8]=p+g,e[9]=f-v,e[10]=1-c-d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Cu(t,e){return e=e||new U(16),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e}function wr(t,e){return e=e||new U(16),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}const Pu=wr;function Ou(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[3]-e[3])<C&&Math.abs(t[4]-e[4])<C&&Math.abs(t[5]-e[5])<C&&Math.abs(t[6]-e[6])<C&&Math.abs(t[7]-e[7])<C&&Math.abs(t[8]-e[8])<C&&Math.abs(t[9]-e[9])<C&&Math.abs(t[10]-e[10])<C&&Math.abs(t[11]-e[11])<C&&Math.abs(t[12]-e[12])<C&&Math.abs(t[13]-e[13])<C&&Math.abs(t[14]-e[14])<C&&Math.abs(t[15]-e[15])<C}function Bu(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function jn(t){return t=t||new U(16),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Nu(t,e){if(e=e||new U(16),e===t){let T;return T=t[1],t[1]=t[4],t[4]=T,T=t[2],t[2]=t[8],t[8]=T,T=t[3],t[3]=t[12],t[12]=T,T=t[6],t[6]=t[9],t[9]=T,T=t[7],t[7]=t[13],t[13]=T,T=t[11],t[11]=t[14],t[14]=T,e}const r=t[0*4+0],n=t[0*4+1],i=t[0*4+2],s=t[0*4+3],a=t[1*4+0],o=t[1*4+1],u=t[1*4+2],c=t[1*4+3],l=t[2*4+0],d=t[2*4+1],p=t[2*4+2],f=t[2*4+3],y=t[3*4+0],v=t[3*4+1],g=t[3*4+2],S=t[3*4+3];return e[0]=r,e[1]=a,e[2]=l,e[3]=y,e[4]=n,e[5]=o,e[6]=d,e[7]=v,e[8]=i,e[9]=u,e[10]=p,e[11]=g,e[12]=s,e[13]=c,e[14]=f,e[15]=S,e}function qn(t,e){e=e||new U(16);const r=t[0*4+0],n=t[0*4+1],i=t[0*4+2],s=t[0*4+3],a=t[1*4+0],o=t[1*4+1],u=t[1*4+2],c=t[1*4+3],l=t[2*4+0],d=t[2*4+1],p=t[2*4+2],f=t[2*4+3],y=t[3*4+0],v=t[3*4+1],g=t[3*4+2],S=t[3*4+3],T=p*S,E=g*f,M=u*S,A=g*c,L=u*f,P=p*c,B=i*S,D=g*s,O=i*f,H=p*s,W=i*c,F=u*s,Q=l*v,se=y*d,ae=a*v,te=y*o,he=a*d,ar=l*o,or=r*v,ur=y*n,cr=r*d,lr=l*n,dr=r*o,hr=a*n,Ea=T*o+A*d+L*v-(E*o+M*d+P*v),Ma=E*n+B*d+H*v-(T*n+D*d+O*v),Aa=M*n+D*o+W*v-(A*n+B*o+F*v),Ca=P*n+O*o+F*d-(L*n+H*o+W*d),ue=1/(r*Ea+a*Ma+l*Aa+y*Ca);return e[0]=ue*Ea,e[1]=ue*Ma,e[2]=ue*Aa,e[3]=ue*Ca,e[4]=ue*(E*a+M*l+P*y-(T*a+A*l+L*y)),e[5]=ue*(T*r+D*l+O*y-(E*r+B*l+H*y)),e[6]=ue*(A*r+B*a+F*y-(M*r+D*a+W*y)),e[7]=ue*(L*r+H*a+W*l-(P*r+O*a+F*l)),e[8]=ue*(Q*c+te*f+he*S-(se*c+ae*f+ar*S)),e[9]=ue*(se*s+or*f+lr*S-(Q*s+ur*f+cr*S)),e[10]=ue*(ae*s+ur*c+dr*S-(te*s+or*c+hr*S)),e[11]=ue*(ar*s+cr*c+hr*f-(he*s+lr*c+dr*f)),e[12]=ue*(ae*p+ar*g+se*u-(he*g+Q*u+te*p)),e[13]=ue*(cr*g+Q*i+ur*p-(or*p+lr*g+se*i)),e[14]=ue*(or*u+hr*g+te*i-(dr*g+ae*i+ur*u)),e[15]=ue*(dr*p+he*i+lr*u-(cr*u+hr*p+ar*i)),e}function Lu(t){const e=t[0],r=t[0*4+1],n=t[0*4+2],i=t[0*4+3],s=t[1*4+0],a=t[1*4+1],o=t[1*4+2],u=t[1*4+3],c=t[2*4+0],l=t[2*4+1],d=t[2*4+2],p=t[2*4+3],f=t[3*4+0],y=t[3*4+1],v=t[3*4+2],g=t[3*4+3],S=d*g,T=v*p,E=o*g,M=v*u,A=o*p,L=d*u,P=n*g,B=v*i,D=n*p,O=d*i,H=n*u,W=o*i,F=S*a+M*l+A*y-(T*a+E*l+L*y),Q=T*r+P*l+O*y-(S*r+B*l+D*y),se=E*r+B*a+H*y-(M*r+P*a+W*y),ae=L*r+D*a+W*l-(A*r+O*a+H*l);return e*F+s*Q+c*se+f*ae}const Iu=qn;function $n(t,e,r){r=r||new U(16);const n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],c=t[6],l=t[7],d=t[8],p=t[9],f=t[10],y=t[11],v=t[12],g=t[13],S=t[14],T=t[15],E=e[0],M=e[1],A=e[2],L=e[3],P=e[4],B=e[5],D=e[6],O=e[7],H=e[8],W=e[9],F=e[10],Q=e[11],se=e[12],ae=e[13],te=e[14],he=e[15];return r[0]=n*E+o*M+d*A+v*L,r[1]=i*E+u*M+p*A+g*L,r[2]=s*E+c*M+f*A+S*L,r[3]=a*E+l*M+y*A+T*L,r[4]=n*P+o*B+d*D+v*O,r[5]=i*P+u*B+p*D+g*O,r[6]=s*P+c*B+f*D+S*O,r[7]=a*P+l*B+y*D+T*O,r[8]=n*H+o*W+d*F+v*Q,r[9]=i*H+u*W+p*F+g*Q,r[10]=s*H+c*W+f*F+S*Q,r[11]=a*H+l*W+y*F+T*Q,r[12]=n*se+o*ae+d*te+v*he,r[13]=i*se+u*ae+p*te+g*he,r[14]=s*se+c*ae+f*te+S*he,r[15]=a*se+l*ae+y*te+T*he,r}const zu=$n;function Uu(t,e,r){return r=r||jn(),t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11]),r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function Gu(t,e){return e=e||re(),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Fu(t,e,r){r=r||re();const n=e*4;return r[0]=t[n+0],r[1]=t[n+1],r[2]=t[n+2],r}function Ru(t,e,r,n){n!==t&&(n=wr(t,n));const i=r*4;return n[i+0]=e[0],n[i+1]=e[1],n[i+2]=e[2],n}function Du(t,e){e=e||re();const r=t[0],n=t[1],i=t[2],s=t[4],a=t[5],o=t[6],u=t[8],c=t[9],l=t[10];return e[0]=Math.sqrt(r*r+n*n+i*i),e[1]=Math.sqrt(s*s+a*a+o*o),e[2]=Math.sqrt(u*u+c*c+l*l),e}function Vu(t,e,r,n,i){i=i||new U(16);const s=Math.tan(Math.PI*.5-.5*t);if(i[0]=s/e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=s,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,n===1/0)i[10]=-1,i[14]=-r;else{const a=1/(r-n);i[10]=n*a,i[14]=n*r*a}return i}function ju(t,e,r,n,i,s,a){return a=a||new U(16),a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(n-r),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1/(i-s),a[11]=0,a[12]=(e+t)/(t-e),a[13]=(n+r)/(r-n),a[14]=i/(i-s),a[15]=1,a}function qu(t,e,r,n,i,s,a){a=a||new U(16);const o=e-t,u=n-r,c=i-s;return a[0]=2*i/o,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*i/u,a[6]=0,a[7]=0,a[8]=(t+e)/o,a[9]=(n+r)/u,a[10]=s/c,a[11]=-1,a[12]=0,a[13]=0,a[14]=i*s/c,a[15]=0,a}let V,X,G;function $u(t,e,r,n){return n=n||new U(16),V=V||re(),X=X||re(),G=G||re(),pe(mt(e,t,G),G),pe(ge(r,G,V),V),pe(ge(G,V,X),X),n[0]=V[0],n[1]=V[1],n[2]=V[2],n[3]=0,n[4]=X[0],n[5]=X[1],n[6]=X[2],n[7]=0,n[8]=G[0],n[9]=G[1],n[10]=G[2],n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function Hu(t,e,r,n){return n=n||new U(16),V=V||re(),X=X||re(),G=G||re(),pe(mt(t,e,G),G),pe(ge(r,G,V),V),pe(ge(G,V,X),X),n[0]=V[0],n[1]=V[1],n[2]=V[2],n[3]=0,n[4]=X[0],n[5]=X[1],n[6]=X[2],n[7]=0,n[8]=G[0],n[9]=G[1],n[10]=G[2],n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function Yu(t,e,r,n){return n=n||new U(16),V=V||re(),X=X||re(),G=G||re(),pe(mt(t,e,G),G),pe(ge(r,G,V),V),pe(ge(G,V,X),X),n[0]=V[0],n[1]=X[0],n[2]=G[0],n[3]=0,n[4]=V[1],n[5]=X[1],n[6]=G[1],n[7]=0,n[8]=V[2],n[9]=X[2],n[10]=G[2],n[11]=0,n[12]=-(V[0]*t[0]+V[1]*t[1]+V[2]*t[2]),n[13]=-(X[0]*t[0]+X[1]*t[1]+X[2]*t[2]),n[14]=-(G[0]*t[0]+G[1]*t[1]+G[2]*t[2]),n[15]=1,n}function Wu(t,e){return e=e||new U(16),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Xu(t,e,r){r=r||new U(16);const n=e[0],i=e[1],s=e[2],a=t[0],o=t[1],u=t[2],c=t[3],l=t[1*4+0],d=t[1*4+1],p=t[1*4+2],f=t[1*4+3],y=t[2*4+0],v=t[2*4+1],g=t[2*4+2],S=t[2*4+3],T=t[3*4+0],E=t[3*4+1],M=t[3*4+2],A=t[3*4+3];return t!==r&&(r[0]=a,r[1]=o,r[2]=u,r[3]=c,r[4]=l,r[5]=d,r[6]=p,r[7]=f,r[8]=y,r[9]=v,r[10]=g,r[11]=S),r[12]=a*n+l*i+y*s+T,r[13]=o*n+d*i+v*s+E,r[14]=u*n+p*i+g*s+M,r[15]=c*n+f*i+S*s+A,r}function Ju(t,e){e=e||new U(16);const r=Math.cos(t),n=Math.sin(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ku(t,e,r){r=r||new U(16);const n=t[4],i=t[5],s=t[6],a=t[7],o=t[8],u=t[9],c=t[10],l=t[11],d=Math.cos(e),p=Math.sin(e);return r[4]=d*n+p*o,r[5]=d*i+p*u,r[6]=d*s+p*c,r[7]=d*a+p*l,r[8]=d*o-p*n,r[9]=d*u-p*i,r[10]=d*c-p*s,r[11]=d*l-p*a,t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}function Qu(t,e){e=e||new U(16);const r=Math.cos(t),n=Math.sin(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Zu(t,e,r){r=r||new U(16);const n=t[0*4+0],i=t[0*4+1],s=t[0*4+2],a=t[0*4+3],o=t[2*4+0],u=t[2*4+1],c=t[2*4+2],l=t[2*4+3],d=Math.cos(e),p=Math.sin(e);return r[0]=d*n-p*o,r[1]=d*i-p*u,r[2]=d*s-p*c,r[3]=d*a-p*l,r[8]=d*o+p*n,r[9]=d*u+p*i,r[10]=d*c+p*s,r[11]=d*l+p*a,t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}function ec(t,e){e=e||new U(16);const r=Math.cos(t),n=Math.sin(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tc(t,e,r){r=r||new U(16);const n=t[0*4+0],i=t[0*4+1],s=t[0*4+2],a=t[0*4+3],o=t[1*4+0],u=t[1*4+1],c=t[1*4+2],l=t[1*4+3],d=Math.cos(e),p=Math.sin(e);return r[0]=d*n+p*o,r[1]=d*i+p*u,r[2]=d*s+p*c,r[3]=d*a+p*l,r[4]=d*o-p*n,r[5]=d*u-p*i,r[6]=d*c-p*s,r[7]=d*l-p*a,t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}function Hn(t,e,r){r=r||new U(16);let n=t[0],i=t[1],s=t[2];const a=Math.sqrt(n*n+i*i+s*s);n/=a,i/=a,s/=a;const o=n*n,u=i*i,c=s*s,l=Math.cos(e),d=Math.sin(e),p=1-l;return r[0]=o+(1-o)*l,r[1]=n*i*p+s*d,r[2]=n*s*p-i*d,r[3]=0,r[4]=n*i*p-s*d,r[5]=u+(1-u)*l,r[6]=i*s*p+n*d,r[7]=0,r[8]=n*s*p+i*d,r[9]=i*s*p-n*d,r[10]=c+(1-c)*l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}const rc=Hn;function Yn(t,e,r,n){n=n||new U(16);let i=e[0],s=e[1],a=e[2];const o=Math.sqrt(i*i+s*s+a*a);i/=o,s/=o,a/=o;const u=i*i,c=s*s,l=a*a,d=Math.cos(r),p=Math.sin(r),f=1-d,y=u+(1-u)*d,v=i*s*f+a*p,g=i*a*f-s*p,S=i*s*f-a*p,T=c+(1-c)*d,E=s*a*f+i*p,M=i*a*f+s*p,A=s*a*f-i*p,L=l+(1-l)*d,P=t[0],B=t[1],D=t[2],O=t[3],H=t[4],W=t[5],F=t[6],Q=t[7],se=t[8],ae=t[9],te=t[10],he=t[11];return n[0]=y*P+v*H+g*se,n[1]=y*B+v*W+g*ae,n[2]=y*D+v*F+g*te,n[3]=y*O+v*Q+g*he,n[4]=S*P+T*H+E*se,n[5]=S*B+T*W+E*ae,n[6]=S*D+T*F+E*te,n[7]=S*O+T*Q+E*he,n[8]=M*P+A*H+L*se,n[9]=M*B+A*W+L*ae,n[10]=M*D+A*F+L*te,n[11]=M*O+A*Q+L*he,t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n}const nc=Yn;function ic(t,e){return e=e||new U(16),e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function sc(t,e,r){r=r||new U(16);const n=e[0],i=e[1],s=e[2];return r[0]=n*t[0*4+0],r[1]=n*t[0*4+1],r[2]=n*t[0*4+2],r[3]=n*t[0*4+3],r[4]=i*t[1*4+0],r[5]=i*t[1*4+1],r[6]=i*t[1*4+2],r[7]=i*t[1*4+3],r[8]=s*t[2*4+0],r[9]=s*t[2*4+1],r[10]=s*t[2*4+2],r[11]=s*t[2*4+3],t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}function ac(t,e){return e=e||new U(16),e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function oc(t,e,r){return r=r||new U(16),r[0]=e*t[0*4+0],r[1]=e*t[0*4+1],r[2]=e*t[0*4+2],r[3]=e*t[0*4+3],r[4]=e*t[1*4+0],r[5]=e*t[1*4+1],r[6]=e*t[1*4+2],r[7]=e*t[1*4+3],r[8]=e*t[2*4+0],r[9]=e*t[2*4+1],r[10]=e*t[2*4+2],r[11]=e*t[2*4+3],t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r}var j=Object.freeze({__proto__:null,aim:$u,axisRotate:Yn,axisRotation:Hn,cameraAim:Hu,clone:Pu,copy:wr,create:Tu,determinant:Lu,equals:Bu,equalsApproximately:Ou,fromMat3:Mu,fromQuat:Au,frustum:qu,getAxis:Fu,getScaling:Du,getTranslation:Gu,identity:jn,inverse:qn,invert:Iu,lookAt:Yu,mul:zu,multiply:$n,negate:Cu,ortho:ju,perspective:Vu,rotate:nc,rotateX:Ku,rotateY:Zu,rotateZ:tc,rotation:rc,rotationX:Ju,rotationY:Qu,rotationZ:ec,scale:sc,scaling:ic,set:Eu,setAxis:Ru,setDefaultType:Su,setTranslation:Uu,translate:Xu,translation:Wu,transpose:Nu,uniformScale:oc,uniformScaling:ac});let q=Float32Array;function uc(t){const e=q;return q=t,e}function Wn(t,e,r,n){const i=new q(4);return t!==void 0&&(i[0]=t,e!==void 0&&(i[1]=e,r!==void 0&&(i[2]=r,n!==void 0&&(i[3]=n)))),i}const cc=Wn;function lc(t,e,r,n,i){return i=i||new q(4),i[0]=t,i[1]=e,i[2]=r,i[3]=n,i}function Xn(t,e,r){r=r||new q(4);const n=e*.5,i=Math.sin(n);return r[0]=i*t[0],r[1]=i*t[1],r[2]=i*t[2],r[3]=Math.cos(n),r}function dc(t,e){e=e||re(4);const r=Math.acos(t[3])*2,n=Math.sin(r*.5);return n>C?(e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n):(e[0]=1,e[1]=0,e[2]=0),{angle:r,axis:e}}function hc(t,e){const r=ei(t,e);return Math.acos(2*r*r-1)}function Jn(t,e,r){r=r||new q(4);const n=t[0],i=t[1],s=t[2],a=t[3],o=e[0],u=e[1],c=e[2],l=e[3];return r[0]=n*l+a*o+i*c-s*u,r[1]=i*l+a*u+s*o-n*c,r[2]=s*l+a*c+n*u-i*o,r[3]=a*l-n*o-i*u-s*c,r}const pc=Jn;function fc(t,e,r){r=r||new q(4);const n=e*.5,i=t[0],s=t[1],a=t[2],o=t[3],u=Math.sin(n),c=Math.cos(n);return r[0]=i*c+o*u,r[1]=s*c+a*u,r[2]=a*c-s*u,r[3]=o*c-i*u,r}function mc(t,e,r){r=r||new q(4);const n=e*.5,i=t[0],s=t[1],a=t[2],o=t[3],u=Math.sin(n),c=Math.cos(n);return r[0]=i*c-a*u,r[1]=s*c+o*u,r[2]=a*c+i*u,r[3]=o*c-s*u,r}function _c(t,e,r){r=r||new q(4);const n=e*.5,i=t[0],s=t[1],a=t[2],o=t[3],u=Math.sin(n),c=Math.cos(n);return r[0]=i*c+s*u,r[1]=s*c-i*u,r[2]=a*c+o*u,r[3]=o*c-a*u,r}function Ut(t,e,r,n){n=n||new q(4);const i=t[0],s=t[1],a=t[2],o=t[3];let u=e[0],c=e[1],l=e[2],d=e[3],p=i*u+s*c+a*l+o*d;p<0&&(p=-p,u=-u,c=-c,l=-l,d=-d);let f,y;if(1-p>C){const v=Math.acos(p),g=Math.sin(v);f=Math.sin((1-r)*v)/g,y=Math.sin(r*v)/g}else f=1-r,y=r;return n[0]=f*i+y*u,n[1]=f*s+y*c,n[2]=f*a+y*l,n[3]=f*o+y*d,n}function gc(t,e){e=e||new q(4);const r=t[0],n=t[1],i=t[2],s=t[3],a=r*r+n*n+i*i+s*s,o=a?1/a:0;return e[0]=-r*o,e[1]=-n*o,e[2]=-i*o,e[3]=s*o,e}function vc(t,e){return e=e||new q(4),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function yc(t,e){e=e||new q(4);const r=t[0]+t[5]+t[10];if(r>0){const n=Math.sqrt(r+1);e[3]=.5*n;const i=.5/n;e[0]=(t[6]-t[9])*i,e[1]=(t[8]-t[2])*i,e[2]=(t[1]-t[4])*i}else{let n=0;t[5]>t[0]&&(n=1),t[10]>t[n*4+n]&&(n=2);const i=(n+1)%3,s=(n+2)%3,a=Math.sqrt(t[n*4+n]-t[i*4+i]-t[s*4+s]+1);e[n]=.5*a;const o=.5/a;e[3]=(t[i*4+s]-t[s*4+i])*o,e[i]=(t[i*4+n]+t[n*4+i])*o,e[s]=(t[s*4+n]+t[n*4+s])*o}return e}function bc(t,e,r,n,i){i=i||new q(4);const s=t*.5,a=e*.5,o=r*.5,u=Math.sin(s),c=Math.cos(s),l=Math.sin(a),d=Math.cos(a),p=Math.sin(o),f=Math.cos(o);switch(n){case"xyz":i[0]=u*d*f+c*l*p,i[1]=c*l*f-u*d*p,i[2]=c*d*p+u*l*f,i[3]=c*d*f-u*l*p;break;case"xzy":i[0]=u*d*f-c*l*p,i[1]=c*l*f-u*d*p,i[2]=c*d*p+u*l*f,i[3]=c*d*f+u*l*p;break;case"yxz":i[0]=u*d*f+c*l*p,i[1]=c*l*f-u*d*p,i[2]=c*d*p-u*l*f,i[3]=c*d*f+u*l*p;break;case"yzx":i[0]=u*d*f+c*l*p,i[1]=c*l*f+u*d*p,i[2]=c*d*p-u*l*f,i[3]=c*d*f-u*l*p;break;case"zxy":i[0]=u*d*f-c*l*p,i[1]=c*l*f+u*d*p,i[2]=c*d*p+u*l*f,i[3]=c*d*f-u*l*p;break;case"zyx":i[0]=u*d*f-c*l*p,i[1]=c*l*f+u*d*p,i[2]=c*d*p-u*l*f,i[3]=c*d*f+u*l*p;break;default:throw new Error(`Unknown rotation order: ${n}`)}return i}function Kn(t,e){return e=e||new q(4),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}const wc=Kn;function xc(t,e,r){return r=r||new q(4),r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r}function Qn(t,e,r){return r=r||new q(4),r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r}const kc=Qn;function Zn(t,e,r){return r=r||new q(4),r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r}const Sc=Zn;function Tc(t,e,r){return r=r||new q(4),r[0]=t[0]/e,r[1]=t[1]/e,r[2]=t[2]/e,r[3]=t[3]/e,r}function ei(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Ec(t,e,r,n){return n=n||new q(4),n[0]=t[0]+r*(e[0]-t[0]),n[1]=t[1]+r*(e[1]-t[1]),n[2]=t[2]+r*(e[2]-t[2]),n[3]=t[3]+r*(e[3]-t[3]),n}function ti(t){const e=t[0],r=t[1],n=t[2],i=t[3];return Math.sqrt(e*e+r*r+n*n+i*i)}const Mc=ti;function ri(t){const e=t[0],r=t[1],n=t[2],i=t[3];return e*e+r*r+n*n+i*i}const Ac=ri;function ni(t,e){e=e||new q(4);const r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i+s*s);return a>1e-5?(e[0]=r/a,e[1]=n/a,e[2]=i/a,e[3]=s/a):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function Cc(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[3]-e[3])<C}function Pc(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Oc(t){return t=t||new q(4),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}let fe,xr,kr;function Bc(t,e,r){r=r||new q(4),fe=fe||re(),xr=xr||re(1,0,0),kr=kr||re(0,1,0);const n=vr(t,e);return n<-.999999?(ge(xr,t,fe),zn(fe)<1e-6&&ge(kr,t,fe),pe(fe,fe),Xn(fe,Math.PI,r),r):n>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(ge(t,e,fe),r[0]=fe[0],r[1]=fe[1],r[2]=fe[2],r[3]=1+n,ni(r,r))}let Gt,Ft;function Nc(t,e,r,n,i,s){return s=s||new q(4),Gt=Gt||new q(4),Ft=Ft||new q(4),Ut(t,n,i,Gt),Ut(e,r,i,Ft),Ut(Gt,Ft,2*i*(1-i),s),s}var Ze=Object.freeze({__proto__:null,add:xc,angle:hc,clone:wc,conjugate:vc,copy:Kn,create:Wn,divScalar:Tc,dot:ei,equals:Pc,equalsApproximately:Cc,fromAxisAngle:Xn,fromEuler:bc,fromMat:yc,fromValues:cc,identity:Oc,inverse:gc,len:Mc,lenSq:Ac,length:ti,lengthSq:ri,lerp:Ec,mul:pc,mulScalar:Zn,multiply:Jn,normalize:ni,rotateX:fc,rotateY:mc,rotateZ:_c,rotationTo:Bc,scale:Sc,set:lc,setDefaultType:uc,slerp:Ut,sqlerp:Nc,sub:kc,subtract:Qn,toAxisAngle:dc});let R=Float32Array;function Lc(t){const e=R;return R=t,e}function ii(t,e,r,n){const i=new R(4);return t!==void 0&&(i[0]=t,e!==void 0&&(i[1]=e,r!==void 0&&(i[2]=r,n!==void 0&&(i[3]=n)))),i}const Ic=ii;function zc(t,e,r,n,i){return i=i||new R(4),i[0]=t,i[1]=e,i[2]=r,i[3]=n,i}function Uc(t,e){return e=e||new R(4),e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function Gc(t,e){return e=e||new R(4),e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Fc(t,e){return e=e||new R(4),e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function Rc(t,e=0,r=1,n){return n=n||new R(4),n[0]=Math.min(r,Math.max(e,t[0])),n[1]=Math.min(r,Math.max(e,t[1])),n[2]=Math.min(r,Math.max(e,t[2])),n[3]=Math.min(r,Math.max(e,t[3])),n}function Dc(t,e,r){return r=r||new R(4),r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r}function Vc(t,e,r,n){return n=n||new R(4),n[0]=t[0]+e[0]*r,n[1]=t[1]+e[1]*r,n[2]=t[2]+e[2]*r,n[3]=t[3]+e[3]*r,n}function si(t,e,r){return r=r||new R(4),r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r}const jc=si;function qc(t,e){return Math.abs(t[0]-e[0])<C&&Math.abs(t[1]-e[1])<C&&Math.abs(t[2]-e[2])<C&&Math.abs(t[3]-e[3])<C}function $c(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function ai(t,e,r,n){return n=n||new R(4),n[0]=t[0]+r*(e[0]-t[0]),n[1]=t[1]+r*(e[1]-t[1]),n[2]=t[2]+r*(e[2]-t[2]),n[3]=t[3]+r*(e[3]-t[3]),n}function Hc(t,e,r,n){return n=n||new R(4),n[0]=t[0]+r[0]*(e[0]-t[0]),n[1]=t[1]+r[1]*(e[1]-t[1]),n[2]=t[2]+r[2]*(e[2]-t[2]),n[3]=t[3]+r[3]*(e[3]-t[3]),n}function Yc(t,e,r){return r=r||new R(4),r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r[3]=Math.max(t[3],e[3]),r}function Wc(t,e,r){return r=r||new R(4),r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.min(t[2],e[2]),r[3]=Math.min(t[3],e[3]),r}function Sr(t,e,r){return r=r||new R(4),r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r}const Xc=Sr;function Jc(t,e,r){return r=r||new R(4),r[0]=t[0]/e,r[1]=t[1]/e,r[2]=t[2]/e,r[3]=t[3]/e,r}function oi(t,e){return e=e||new R(4),e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}const Kc=oi;function Qc(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Tr(t){const e=t[0],r=t[1],n=t[2],i=t[3];return Math.sqrt(e*e+r*r+n*n+i*i)}const Zc=Tr;function ui(t){const e=t[0],r=t[1],n=t[2],i=t[3];return e*e+r*r+n*n+i*i}const el=ui;function ci(t,e){const r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return Math.sqrt(r*r+n*n+i*i+s*s)}const tl=ci;function li(t,e){const r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return r*r+n*n+i*i+s*s}const rl=li;function di(t,e){e=e||new R(4);const r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i+s*s);return a>1e-5?(e[0]=r/a,e[1]=n/a,e[2]=i/a,e[3]=s/a):(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function nl(t,e){return e=e||new R(4),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function Er(t,e){return e=e||new R(4),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}const il=Er;function hi(t,e,r){return r=r||new R(4),r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r[3]=t[3]*e[3],r}const sl=hi;function pi(t,e,r){return r=r||new R(4),r[0]=t[0]/e[0],r[1]=t[1]/e[1],r[2]=t[2]/e[2],r[3]=t[3]/e[3],r}const al=pi;function ol(t){return t=t||new R(4),t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function ul(t,e,r){r=r||new R(4);const n=t[0],i=t[1],s=t[2],a=t[3];return r[0]=e[0]*n+e[4]*i+e[8]*s+e[12]*a,r[1]=e[1]*n+e[5]*i+e[9]*s+e[13]*a,r[2]=e[2]*n+e[6]*i+e[10]*s+e[14]*a,r[3]=e[3]*n+e[7]*i+e[11]*s+e[15]*a,r}function fi(t,e,r){return r=r||new R(4),di(t,r),Sr(r,e,r)}function cl(t,e,r){return r=r||new R(4),Tr(t)>e?fi(t,e,r):Er(t,r)}function ll(t,e,r){return r=r||new R(4),ai(t,e,.5,r)}var Oe=Object.freeze({__proto__:null,add:Dc,addScaled:Vc,ceil:Uc,clamp:Rc,clone:il,copy:Er,create:ii,dist:tl,distSq:rl,distance:ci,distanceSq:li,div:al,divScalar:Jc,divide:pi,dot:Qc,equals:$c,equalsApproximately:qc,floor:Gc,fromValues:Ic,inverse:oi,invert:Kc,len:Zc,lenSq:el,length:Tr,lengthSq:ui,lerp:ai,lerpV:Hc,max:Yc,midpoint:ll,min:Wc,mul:sl,mulScalar:Sr,multiply:hi,negate:nl,normalize:di,round:Fc,scale:Xc,set:zc,setDefaultType:Lc,setLength:fi,sub:jc,subtract:si,transformMat4:ul,truncate:cl,zero:ol});class mi{constructor(){w(this,"pipelineCount",0);w(this,"pipelineSets",0);w(this,"bindGroupCount",0);w(this,"bindGroupSets",0);w(this,"bufferSets",0);w(this,"drawCount",0)}}var _t=(t=>(t[t.POSITION=0]="POSITION",t[t.NORMAL=1]="NORMAL",t[t.TEXCOORD_0=2]="TEXCOORD_0",t[t.TANGENT=3]="TANGENT",t))(_t||{});const gt="tf",_i="mtfInstances",et="lightCollection",Fe="env",gi=`
struct Transformation {
  projectionMatrix: mat4x4f,
  viewMatrix: mat4x4f,
  cameraPosition: vec3f,
};

@group(0) @binding(0) var<uniform> ${gt}: Transformation;
`,vi=`
struct InputLight {
  dir: vec3f,
  pos: vec3f,
  color: vec4f,
  flux: f32,
  ltype: u32,
};

struct InputLightGroup {
  lightNums: u32,
  lights: array<InputLight>
}

@group(0) @binding(1) var<storage> ${et}: InputLightGroup;
`,yi=`
struct EnvUniform {
  diffuseColor: vec4f,
  specularColor: vec4f,
  diffuseFactor: vec3f,
  specularFactor: vec3f,
  specularDetails: f32,
};
@group(0) @binding(2) var diffuseMap: texture_2d<f32>;
@group(0) @binding(3) var specularMap: texture_2d<f32>;
@group(0) @binding(4) var<uniform> ${Fe}: EnvUniform;
@group(0) @binding(5) var envSampler: sampler;
`,dl=`
struct MTransformation {
  modelMatrix: mat4x4f,
  normalMatrix: mat4x4f,
};

@group(1) @binding(0) var<storage> ${_i}: array<MTransformation>;
`,hl=/#([^\s]*)(\s*)/gm;class bi{constructor(e){w(this,"elseIsValid",!0);w(this,"branches",[]);this.pushBranch("if",e)}pushBranch(e,r){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid=e==="if"||e==="elif",this.branches.push({expression:!!r,string:""})}appendStringToCurrentBranch(...e){for(const r of e)this.branches[this.branches.length-1].string+=r}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function Rt(t,...e){const r=[];let n=new bi(!0);n.elseIsValid=!1;const i=(s,a)=>{if(s.index+s[0].length!=a.length)throw new Error(`#${s[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let s=0;s<t.length;++s){const a=t[s],o=a.matchAll(hl);let u=0,c=!1;for(const l of o){switch(n.appendStringToCurrentBranch(a.substring(u,l.index)),l[1]){case"if":i(l,a),c=!0,r.push(n),n=new bi(e[s]);break;case"elif":i(l,a),c=!0,n.pushBranch(l[1],e[s]);break;case"else":n.pushBranch(l[1],!0),n.appendStringToCurrentBranch(l[2]);break;case"endif":if(!r.length)throw new Error(`#${l[1]} not preceeded by an #if`);const d=n.resolve();n=r.pop(),n.appendStringToCurrentBranch(d,l[2]);break;default:n.appendStringToCurrentBranch(l[0]);break}u=l.index+l[0].length}u!=a.length&&n.appendStringToCurrentBranch(a.substring(u,a.length)),!c&&e.length>s&&n.appendStringToCurrentBranch(e[s])}if(r.length)throw new Error("Mismatched #if/#endif count");return n.resolve()}const pl=t=>Rt`
struct VertexInput {
  @location(${_t.POSITION}) position: vec4f,
  @location(${_t.NORMAL}) normal: vec3f,
#if ${t.useTexcoord}
  @location(${_t.TEXCOORD_0}) uv0: vec2f,
#endif
};

struct VertexOutput {
  @builtin(position) position: vec4f,
  @location(0) normal: vec3f,
  @location(1) pos: vec3f,
  @location(2) uv0: vec2f,
  @location(3) cameraPos: vec3f
};

${gi}
${dl}

@vertex
fn main(
  vert: VertexInput, 
  @builtin(instance_index) instanceIndex : u32
) -> VertexOutput {
    var o: VertexOutput;
    let modelTransform = ${_i}[instanceIndex];
    let pos = modelTransform.modelMatrix * vert.position;
    o.pos = pos.xyz/pos.w;
    o.cameraPos = ${gt}.cameraPosition;
    o.position = ${gt}.projectionMatrix * ${gt}.viewMatrix * pos;
    o.normal = (modelTransform.normalMatrix * vec4f(vert.normal, 0)).xyz;
    #if ${t.useTexcoord}
      o.uv0 = vert.uv0;
    #else
      o.uv0 = vec2f(0);
    #endif
    return o;
};

`,Mr=(t,e)=>((t+e-1)/e|0)*e;function fl(t){return Object.keys(t)}function ml(t,e){return new Array(t).fill(0).map((r,n)=>e(n))}const Be=t=>t&&typeof t.length=="number"&&t.buffer instanceof ArrayBuffer&&typeof t.byteLength=="number",z={i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array},bool:{numElements:0,align:1,size:0,type:"bool",View:Uint32Array}},tt={...z,"atomic<i32>":z.i32,"atomic<u32>":z.u32,"vec2<i32>":z.vec2i,"vec2<u32>":z.vec2u,"vec2<f32>":z.vec2f,"vec2<f16>":z.vec2h,"vec3<i32>":z.vec3i,"vec3<u32>":z.vec3u,"vec3<f32>":z.vec3f,"vec3<f16>":z.vec3h,"vec4<i32>":z.vec4i,"vec4<u32>":z.vec4u,"vec4<f32>":z.vec4f,"vec4<f16>":z.vec4h,"mat2x2<f32>":z.mat2x2f,"mat2x2<f16>":z.mat2x2h,"mat3x2<f32>":z.mat3x2f,"mat3x2<f16>":z.mat3x2h,"mat4x2<f32>":z.mat4x2f,"mat4x2<f16>":z.mat4x2h,"mat2x3<f32>":z.mat2x3f,"mat2x3<f16>":z.mat2x3h,"mat3x3<f32>":z.mat3x3f,"mat3x3<f16>":z.mat3x3h,"mat4x3<f32>":z.mat4x3f,"mat4x3<f16>":z.mat4x3h,"mat2x4<f32>":z.mat2x4f,"mat2x4<f16>":z.mat2x4h,"mat3x4<f32>":z.mat3x4f,"mat3x4<f16>":z.mat3x4h,"mat4x4<f32>":z.mat4x4f,"mat4x4<f16>":z.mat4x4h},_l=fl(tt);function gl(t=[],e){const r=new Set;for(const n of _l){const i=tt[n];r.has(i)||(r.add(i),i.flatten=t.includes(n)?e:!e)}}gl();function vl(t){const e=t;if(e.elementType)return e.size;{const r=t,n=e.numElements||1;if(r.fields)return t.size*n;{const i=t,{align:s}=tt[i.type];return n>1?Mr(t.size,s)*n:t.size}}}function wi(t,e,r,n){const{size:i,type:s}=t;try{const{View:a,align:o}=tt[s],u=n!==void 0,c=u?Mr(i,o):i,l=c/a.BYTES_PER_ELEMENT,d=u?n===0?(e.byteLength-r)/c:n:1;return new a(e,r,l*d)}catch{throw new Error(`unknown type: ${s}`)}}function yl(t){return!t.fields&&!t.elementType}function bl(t,e,r){const n=r||0,i=e||new ArrayBuffer(vl(t)),s=(a,o)=>{const u=a,c=u.elementType;if(c){if(yl(c)&&tt[c.type].flatten)return wi(c,i,o,u.numElements);{const{size:l}=Pr(a),d=u.numElements===0?(i.byteLength-o)/l:u.numElements;return ml(d,p=>s(c,o+l*p))}}else{if(typeof a=="string")throw Error("unreachable");{const l=a.fields;if(l){const d={};for(const[p,{type:f,offset:y}]of Object.entries(l))d[p]=s(f,o+y);return d}else return wi(a,i,o)}}};return{views:s(t,n),arrayBuffer:i}}function Ar(t,e){if(t!==void 0)if(Be(e)){const r=e;if(r.length===1&&typeof t=="number")r[0]=t;else if(Array.isArray(t[0])||Be(t[0])){const n=t[0].length,i=n===3?4:n;for(let s=0;s<t.length;++s){const a=s*i;r.set(t[s],a)}}else r.set(t)}else if(Array.isArray(e)){const r=e;t.forEach((n,i)=>{Ar(n,r[i])})}else{const r=e;for(const[n,i]of Object.entries(t)){const s=r[n];s&&Ar(i,s)}}}function vt(t,e,r=0){const n=t,i=n.group===void 0?t:n.typeDefinition,s=bl(i,e,r);return{...s,set(a){Ar(a,s.views)}}}function Cr(t){const e=t.elementType;if(e)return Cr(e);const r=t.fields;if(r)return Object.values(r).reduce((s,{type:a})=>Math.max(s,Cr(a)),0);const{type:n}=t,{align:i}=tt[n];return i}function Pr(t){const e=t.elementType;if(e){const n=e.size,i=Cr(e);return{unalignedSize:n,align:i,size:Mr(n,i)}}const r=t.fields;if(r){const n=Object.values(r).pop();if(n.type.size===0)return Pr(n.type)}return{size:0,unalignedSize:0,align:1}}function wl(t){const e=t,r=e.group===void 0?t:e.typeDefinition;return Pr(r)}class xl{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Se{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,r){if(e){r(Dt.instance);for(const n of e)n instanceof Array?this.searchBlock(n,r):n.search(r);r(Vt.instance)}}}class Dt extends Se{}Dt.instance=new Dt;class Vt extends Se{}Vt.instance=new Vt;class J extends Se{constructor(){super()}}let Or=class extends J{constructor(t,e,r,n){super(),this.name=t,this.args=e,this.returnType=r,this.body=n}get astNodeType(){return"function"}search(t){this.searchBlock(this.body,t)}};class kl extends J{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Sl extends J{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Tl extends J{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class El extends J{constructor(e,r,n,i){super(),this.init=e,this.condition=r,this.increment=n,this.body=i}get astNodeType(){return"for"}search(e){var r,n,i;(r=this.init)===null||r===void 0||r.search(e),(n=this.condition)===null||n===void 0||n.search(e),(i=this.increment)===null||i===void 0||i.search(e),this.searchBlock(this.body,e)}}class Re extends J{constructor(e,r,n,i,s){super(),this.name=e,this.type=r,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"var"}search(e){var r;e(this),(r=this.value)===null||r===void 0||r.search(e)}}class xi extends J{constructor(e,r,n){super(),this.name=e,this.type=r,this.value=n}get astNodeType(){return"override"}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}class Br extends J{constructor(e,r,n,i,s){super(),this.name=e,this.type=r,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"let"}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}class ki extends J{constructor(e,r,n,i,s){super(),this.name=e,this.type=r,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}var rt;(function(t){t.increment="++",t.decrement="--"})(rt||(rt={})),function(t){function e(r){const n=r;if(n=="parse")throw new Error("Invalid value for IncrementOperator");return t[n]}t.parse=e}(rt||(rt={}));class Ml extends J{constructor(e,r){super(),this.operator=e,this.variable=r}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}var yt;(function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="})(yt||(yt={})),function(t){function e(r){const n=r;if(n=="parse")throw new Error("Invalid value for AssignOperator");return n}t.parse=e}(yt||(yt={}));class Al extends J{constructor(e,r,n){super(),this.operator=e,this.variable=r,this.value=n}get astNodeType(){return"assign"}search(e){this.value.search(e)}}class Cl extends J{constructor(e,r){super(),this.name=e,this.args=r}get astNodeType(){return"call"}}class Pl extends J{constructor(e,r){super(),this.body=e,this.continuing=r}get astNodeType(){return"loop"}}class Ol extends J{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"body"}}class Bl extends J{constructor(e,r,n,i){super(),this.condition=e,this.body=r,this.elseif=n,this.else=i}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Nl extends J{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}class Ll extends J{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Si extends J{constructor(e,r){super(),this.name=e,this.type=r}get astNodeType(){return"alias"}}class Il extends J{constructor(){super()}get astNodeType(){return"discard"}}class zl extends J{constructor(){super()}get astNodeType(){return"break"}}class Ul extends J{constructor(){super()}get astNodeType(){return"continue"}}let De=class extends J{constructor(t){super(),this.name=t}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}};class Ve extends De{constructor(e,r){super(e),this.members=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let r=0;r<this.members.length;r++)if(this.members[r].name==e)return r;return-1}}class Ti extends De{constructor(e,r,n){super(e),this.format=r,this.access=n}get astNodeType(){return"template"}}class Gl extends De{constructor(e,r,n,i){super(e),this.storage=r,this.type=n,this.access=i}get astNodeType(){return"pointer"}}class Ei extends De{constructor(e,r,n,i){super(e),this.attributes=r,this.format=n,this.count=i}get astNodeType(){return"array"}get isArray(){return!0}}class bt extends De{constructor(e,r,n){super(e),this.format=r,this.access=n}get astNodeType(){return"sampler"}}class ve extends Se{constructor(){super()}}class Mi extends ve{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class wt extends ve{constructor(e,r){super(),this.type=e,this.args=r}get astNodeType(){return"createExpr"}}class Ai extends ve{constructor(e,r){super(),this.name=e,this.args=r}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return this.args[0].evaluate(e)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const r of this.args)r.search(e);e(this)}}class Ci extends ve{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this)}}class Pi extends ve{constructor(e,r){super(),this.name=e,this.initializer=r}get astNodeType(){return"constExpr"}evaluate(e){var r,n;if(this.initializer instanceof wt){const i=(r=this.postfix)===null||r===void 0?void 0:r.evaluateString(e),s=(n=this.initializer.type)===null||n===void 0?void 0:n.name,a=e.structs.get(s),o=a==null?void 0:a.getMemberIndex(i);if(o!=-1)return this.initializer.args[o].evaluate(e);console.log(o)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class Oi extends ve{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class Fl extends ve{constructor(e,r){super(),this.type=e,this.value=r}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Rl extends ve{constructor(e,r){super(),this.type=e,this.args=r}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class Bi extends ve{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Ni extends ve{constructor(){super()}}class Dl extends Ni{constructor(e,r){super(),this.operator=e,this.right=r}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class ye extends Ni{constructor(e,r,n){super(),this.operator=e,this.left=r,this.right=n}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class Li extends Se{constructor(){super()}}class Vl extends Li{constructor(e,r){super(),this.selector=e,this.body=r}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class jl extends Li{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class ql extends Se{constructor(e,r,n){super(),this.name=e,this.type=r,this.attributes=n}get astNodeType(){return"argument"}}class $l extends Se{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Hl extends Se{constructor(e,r,n){super(),this.name=e,this.type=r,this.attributes=n}get astNodeType(){return"member"}}class Ii extends Se{constructor(e,r){super(),this.name=e,this.value=r}get astNodeType(){return"attribute"}}var x,m;(function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"})(m||(m={}));class _{constructor(e,r,n){this.name=e,this.type=r,this.rule=n}toString(){return this.name}}class h{}x=h,h.none=new _("",m.reserved,""),h.eof=new _("EOF",m.token,""),h.reserved={asm:new _("asm",m.reserved,"asm"),bf16:new _("bf16",m.reserved,"bf16"),do:new _("do",m.reserved,"do"),enum:new _("enum",m.reserved,"enum"),f16:new _("f16",m.reserved,"f16"),f64:new _("f64",m.reserved,"f64"),handle:new _("handle",m.reserved,"handle"),i8:new _("i8",m.reserved,"i8"),i16:new _("i16",m.reserved,"i16"),i64:new _("i64",m.reserved,"i64"),mat:new _("mat",m.reserved,"mat"),premerge:new _("premerge",m.reserved,"premerge"),regardless:new _("regardless",m.reserved,"regardless"),typedef:new _("typedef",m.reserved,"typedef"),u8:new _("u8",m.reserved,"u8"),u16:new _("u16",m.reserved,"u16"),u64:new _("u64",m.reserved,"u64"),unless:new _("unless",m.reserved,"unless"),using:new _("using",m.reserved,"using"),vec:new _("vec",m.reserved,"vec"),void:new _("void",m.reserved,"void")},h.keywords={array:new _("array",m.keyword,"array"),atomic:new _("atomic",m.keyword,"atomic"),bool:new _("bool",m.keyword,"bool"),f32:new _("f32",m.keyword,"f32"),i32:new _("i32",m.keyword,"i32"),mat2x2:new _("mat2x2",m.keyword,"mat2x2"),mat2x3:new _("mat2x3",m.keyword,"mat2x3"),mat2x4:new _("mat2x4",m.keyword,"mat2x4"),mat3x2:new _("mat3x2",m.keyword,"mat3x2"),mat3x3:new _("mat3x3",m.keyword,"mat3x3"),mat3x4:new _("mat3x4",m.keyword,"mat3x4"),mat4x2:new _("mat4x2",m.keyword,"mat4x2"),mat4x3:new _("mat4x3",m.keyword,"mat4x3"),mat4x4:new _("mat4x4",m.keyword,"mat4x4"),ptr:new _("ptr",m.keyword,"ptr"),sampler:new _("sampler",m.keyword,"sampler"),sampler_comparison:new _("sampler_comparison",m.keyword,"sampler_comparison"),struct:new _("struct",m.keyword,"struct"),texture_1d:new _("texture_1d",m.keyword,"texture_1d"),texture_2d:new _("texture_2d",m.keyword,"texture_2d"),texture_2d_array:new _("texture_2d_array",m.keyword,"texture_2d_array"),texture_3d:new _("texture_3d",m.keyword,"texture_3d"),texture_cube:new _("texture_cube",m.keyword,"texture_cube"),texture_cube_array:new _("texture_cube_array",m.keyword,"texture_cube_array"),texture_multisampled_2d:new _("texture_multisampled_2d",m.keyword,"texture_multisampled_2d"),texture_storage_1d:new _("texture_storage_1d",m.keyword,"texture_storage_1d"),texture_storage_2d:new _("texture_storage_2d",m.keyword,"texture_storage_2d"),texture_storage_2d_array:new _("texture_storage_2d_array",m.keyword,"texture_storage_2d_array"),texture_storage_3d:new _("texture_storage_3d",m.keyword,"texture_storage_3d"),texture_depth_2d:new _("texture_depth_2d",m.keyword,"texture_depth_2d"),texture_depth_2d_array:new _("texture_depth_2d_array",m.keyword,"texture_depth_2d_array"),texture_depth_cube:new _("texture_depth_cube",m.keyword,"texture_depth_cube"),texture_depth_cube_array:new _("texture_depth_cube_array",m.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new _("texture_depth_multisampled_2d",m.keyword,"texture_depth_multisampled_2d"),texture_external:new _("texture_external",m.keyword,"texture_external"),u32:new _("u32",m.keyword,"u32"),vec2:new _("vec2",m.keyword,"vec2"),vec3:new _("vec3",m.keyword,"vec3"),vec4:new _("vec4",m.keyword,"vec4"),bitcast:new _("bitcast",m.keyword,"bitcast"),block:new _("block",m.keyword,"block"),break:new _("break",m.keyword,"break"),case:new _("case",m.keyword,"case"),continue:new _("continue",m.keyword,"continue"),continuing:new _("continuing",m.keyword,"continuing"),default:new _("default",m.keyword,"default"),discard:new _("discard",m.keyword,"discard"),else:new _("else",m.keyword,"else"),enable:new _("enable",m.keyword,"enable"),fallthrough:new _("fallthrough",m.keyword,"fallthrough"),false:new _("false",m.keyword,"false"),fn:new _("fn",m.keyword,"fn"),for:new _("for",m.keyword,"for"),function:new _("function",m.keyword,"function"),if:new _("if",m.keyword,"if"),let:new _("let",m.keyword,"let"),const:new _("const",m.keyword,"const"),loop:new _("loop",m.keyword,"loop"),while:new _("while",m.keyword,"while"),private:new _("private",m.keyword,"private"),read:new _("read",m.keyword,"read"),read_write:new _("read_write",m.keyword,"read_write"),return:new _("return",m.keyword,"return"),storage:new _("storage",m.keyword,"storage"),switch:new _("switch",m.keyword,"switch"),true:new _("true",m.keyword,"true"),alias:new _("alias",m.keyword,"alias"),type:new _("type",m.keyword,"type"),uniform:new _("uniform",m.keyword,"uniform"),var:new _("var",m.keyword,"var"),override:new _("override",m.keyword,"override"),workgroup:new _("workgroup",m.keyword,"workgroup"),write:new _("write",m.keyword,"write"),r8unorm:new _("r8unorm",m.keyword,"r8unorm"),r8snorm:new _("r8snorm",m.keyword,"r8snorm"),r8uint:new _("r8uint",m.keyword,"r8uint"),r8sint:new _("r8sint",m.keyword,"r8sint"),r16uint:new _("r16uint",m.keyword,"r16uint"),r16sint:new _("r16sint",m.keyword,"r16sint"),r16float:new _("r16float",m.keyword,"r16float"),rg8unorm:new _("rg8unorm",m.keyword,"rg8unorm"),rg8snorm:new _("rg8snorm",m.keyword,"rg8snorm"),rg8uint:new _("rg8uint",m.keyword,"rg8uint"),rg8sint:new _("rg8sint",m.keyword,"rg8sint"),r32uint:new _("r32uint",m.keyword,"r32uint"),r32sint:new _("r32sint",m.keyword,"r32sint"),r32float:new _("r32float",m.keyword,"r32float"),rg16uint:new _("rg16uint",m.keyword,"rg16uint"),rg16sint:new _("rg16sint",m.keyword,"rg16sint"),rg16float:new _("rg16float",m.keyword,"rg16float"),rgba8unorm:new _("rgba8unorm",m.keyword,"rgba8unorm"),rgba8unorm_srgb:new _("rgba8unorm_srgb",m.keyword,"rgba8unorm_srgb"),rgba8snorm:new _("rgba8snorm",m.keyword,"rgba8snorm"),rgba8uint:new _("rgba8uint",m.keyword,"rgba8uint"),rgba8sint:new _("rgba8sint",m.keyword,"rgba8sint"),bgra8unorm:new _("bgra8unorm",m.keyword,"bgra8unorm"),bgra8unorm_srgb:new _("bgra8unorm_srgb",m.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new _("rgb10a2unorm",m.keyword,"rgb10a2unorm"),rg11b10float:new _("rg11b10float",m.keyword,"rg11b10float"),rg32uint:new _("rg32uint",m.keyword,"rg32uint"),rg32sint:new _("rg32sint",m.keyword,"rg32sint"),rg32float:new _("rg32float",m.keyword,"rg32float"),rgba16uint:new _("rgba16uint",m.keyword,"rgba16uint"),rgba16sint:new _("rgba16sint",m.keyword,"rgba16sint"),rgba16float:new _("rgba16float",m.keyword,"rgba16float"),rgba32uint:new _("rgba32uint",m.keyword,"rgba32uint"),rgba32sint:new _("rgba32sint",m.keyword,"rgba32sint"),rgba32float:new _("rgba32float",m.keyword,"rgba32float"),static_assert:new _("static_assert",m.keyword,"static_assert")},h.tokens={decimal_float_literal:new _("decimal_float_literal",m.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new _("hex_float_literal",m.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new _("int_literal",m.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new _("uint_literal",m.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new _("ident",m.token,/[a-zA-Z][0-9a-zA-Z_]*/),and:new _("and",m.token,"&"),and_and:new _("and_and",m.token,"&&"),arrow:new _("arrow ",m.token,"->"),attr:new _("attr",m.token,"@"),attr_left:new _("attr_left",m.token,"[["),attr_right:new _("attr_right",m.token,"]]"),forward_slash:new _("forward_slash",m.token,"/"),bang:new _("bang",m.token,"!"),bracket_left:new _("bracket_left",m.token,"["),bracket_right:new _("bracket_right",m.token,"]"),brace_left:new _("brace_left",m.token,"{"),brace_right:new _("brace_right",m.token,"}"),colon:new _("colon",m.token,":"),comma:new _("comma",m.token,","),equal:new _("equal",m.token,"="),equal_equal:new _("equal_equal",m.token,"=="),not_equal:new _("not_equal",m.token,"!="),greater_than:new _("greater_than",m.token,">"),greater_than_equal:new _("greater_than_equal",m.token,">="),shift_right:new _("shift_right",m.token,">>"),less_than:new _("less_than",m.token,"<"),less_than_equal:new _("less_than_equal",m.token,"<="),shift_left:new _("shift_left",m.token,"<<"),modulo:new _("modulo",m.token,"%"),minus:new _("minus",m.token,"-"),minus_minus:new _("minus_minus",m.token,"--"),period:new _("period",m.token,"."),plus:new _("plus",m.token,"+"),plus_plus:new _("plus_plus",m.token,"++"),or:new _("or",m.token,"|"),or_or:new _("or_or",m.token,"||"),paren_left:new _("paren_left",m.token,"("),paren_right:new _("paren_right",m.token,")"),semicolon:new _("semicolon",m.token,";"),star:new _("star",m.token,"*"),tilde:new _("tilde",m.token,"~"),underscore:new _("underscore",m.token,"_"),xor:new _("xor",m.token,"^"),plus_equal:new _("plus_equal",m.token,"+="),minus_equal:new _("minus_equal",m.token,"-="),times_equal:new _("times_equal",m.token,"*="),division_equal:new _("division_equal",m.token,"/="),modulo_equal:new _("modulo_equal",m.token,"%="),and_equal:new _("and_equal",m.token,"&="),or_equal:new _("or_equal",m.token,"|="),xor_equal:new _("xor_equal",m.token,"^="),shift_right_equal:new _("shift_right_equal",m.token,">>="),shift_left_equal:new _("shift_left_equal",m.token,"<<=")},h.storage_class=[x.keywords.function,x.keywords.private,x.keywords.workgroup,x.keywords.uniform,x.keywords.storage],h.access_mode=[x.keywords.read,x.keywords.write,x.keywords.read_write],h.sampler_type=[x.keywords.sampler,x.keywords.sampler_comparison],h.sampled_texture_type=[x.keywords.texture_1d,x.keywords.texture_2d,x.keywords.texture_2d_array,x.keywords.texture_3d,x.keywords.texture_cube,x.keywords.texture_cube_array],h.multisampled_texture_type=[x.keywords.texture_multisampled_2d],h.storage_texture_type=[x.keywords.texture_storage_1d,x.keywords.texture_storage_2d,x.keywords.texture_storage_2d_array,x.keywords.texture_storage_3d],h.depth_texture_type=[x.keywords.texture_depth_2d,x.keywords.texture_depth_2d_array,x.keywords.texture_depth_cube,x.keywords.texture_depth_cube_array,x.keywords.texture_depth_multisampled_2d],h.texture_external_type=[x.keywords.texture_external],h.any_texture_type=[...x.sampled_texture_type,...x.multisampled_texture_type,...x.storage_texture_type,...x.depth_texture_type,...x.texture_external_type],h.texel_format=[x.keywords.r8unorm,x.keywords.r8snorm,x.keywords.r8uint,x.keywords.r8sint,x.keywords.r16uint,x.keywords.r16sint,x.keywords.r16float,x.keywords.rg8unorm,x.keywords.rg8snorm,x.keywords.rg8uint,x.keywords.rg8sint,x.keywords.r32uint,x.keywords.r32sint,x.keywords.r32float,x.keywords.rg16uint,x.keywords.rg16sint,x.keywords.rg16float,x.keywords.rgba8unorm,x.keywords.rgba8unorm_srgb,x.keywords.rgba8snorm,x.keywords.rgba8uint,x.keywords.rgba8sint,x.keywords.bgra8unorm,x.keywords.bgra8unorm_srgb,x.keywords.rgb10a2unorm,x.keywords.rg11b10float,x.keywords.rg32uint,x.keywords.rg32sint,x.keywords.rg32float,x.keywords.rgba16uint,x.keywords.rgba16sint,x.keywords.rgba16float,x.keywords.rgba32uint,x.keywords.rgba32sint,x.keywords.rgba32float],h.const_literal=[x.tokens.int_literal,x.tokens.uint_literal,x.tokens.decimal_float_literal,x.tokens.hex_float_literal,x.keywords.true,x.keywords.false],h.literal_or_ident=[x.tokens.ident,x.tokens.int_literal,x.tokens.uint_literal,x.tokens.decimal_float_literal,x.tokens.hex_float_literal],h.element_count_expression=[x.tokens.int_literal,x.tokens.uint_literal,x.tokens.ident],h.template_types=[x.keywords.vec2,x.keywords.vec3,x.keywords.vec4,x.keywords.mat2x2,x.keywords.mat2x3,x.keywords.mat2x4,x.keywords.mat3x2,x.keywords.mat3x3,x.keywords.mat3x4,x.keywords.mat4x2,x.keywords.mat4x3,x.keywords.mat4x4,x.keywords.atomic,x.keywords.bitcast,...x.any_texture_type],h.attribute_name=[x.tokens.ident,x.keywords.block],h.assignment_operators=[x.tokens.equal,x.tokens.plus_equal,x.tokens.minus_equal,x.tokens.times_equal,x.tokens.division_equal,x.tokens.modulo_equal,x.tokens.and_equal,x.tokens.or_equal,x.tokens.xor_equal,x.tokens.shift_right_equal,x.tokens.shift_left_equal],h.increment_operators=[x.tokens.plus_plus,x.tokens.minus_minus];class zi{constructor(e,r,n){this.type=e,this.lexeme=r,this.line=n}toString(){return this.lexeme}isTemplateType(){return h.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==h.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class Yl{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new zi(h.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let n=1;for(;n>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),n--,n==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),n++)}return!0}}let r=h.none;for(;;){let n=this._findType(e);const i=this._peekAhead();if(e==">"&&(i==">"||i=="=")){let s=!1,a=this._tokens.length-1;for(let o=0;o<5&&a>=0;++o,--a)if(this._tokens[a].type===h.tokens.less_than){a>0&&this._tokens[a-1].isArrayOrTemplateType()&&(s=!0);break}if(s)return this._addToken(n),!0}if(n===h.none){let s=e,a=0;const o=2;for(let u=0;u<o;++u)if(s+=this._peekAhead(u),n=this._findType(s),n!==h.none){a=u;break}if(n===h.none)return r===h.none?!1:(this._current--,this._addToken(r),!0);e=s,this._current+=a+1}if(r=n,this._isAtEnd())break;e+=this._advance()}return r===h.none?!1:(this._addToken(r),!0)}_findType(e){for(const r in h.keywords){const n=h.keywords[r];if(this._match(e,n.rule))return n}for(const r in h.tokens){const n=h.tokens[r];if(this._match(e,n.rule))return n}return h.none}_match(e,r){if(typeof r=="string"){if(r==e)return!0}else{const n=r.exec(e);if(n&&n.index==0&&n[0]==e)return!0}return!1}_isAtEnd(){return this._current>=this._source.length}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let r=this._source[this._current];return e=e||0,e++,this._current+=e,r}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const r=this._source.substring(this._start,this._current);this._tokens.push(new zi(e,r,this._line))}}class Wl{constructor(){this._tokens=[],this._current=0,this._context=new xl}parse(e){this._initialize(e);let r=[];for(;!this._isAtEnd();){const n=this._global_decl_or_directive();if(!n)break;r.push(n)}return r}_initialize(e){if(e)if(typeof e=="string"){const r=new Yl(e);this._tokens=r.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,r){return console.error(e,r),{token:e,message:r,toString:function(){return`${r}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==h.eof}_match(e){if(e instanceof _)return this._check(e)?(this._advance(),!0):!1;for(let r=0,n=e.length;r<n;++r){const i=e[r];if(this._check(i))return this._advance(),!0}return!1}_consume(e,r){if(this._check(e))return this._advance();throw this._error(this._peek(),r)}_check(e){if(this._isAtEnd())return!1;const r=this._peek();if(e instanceof Array){let n=r.type;return e.indexOf(n)!=-1}return r.type==e}_advance(){return this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(h.tokens.semicolon)&&!this._isAtEnd(););if(this._match(h.keywords.alias)){const r=this._type_alias();return this._consume(h.tokens.semicolon,"Expected ';'"),r}if(this._match(h.keywords.enable)){const r=this._enable_directive();return this._consume(h.tokens.semicolon,"Expected ';'"),r}const e=this._attribute();if(this._check(h.keywords.var)){const r=this._global_variable_decl();return r!=null&&(r.attributes=e),this._consume(h.tokens.semicolon,"Expected ';'."),r}if(this._check(h.keywords.override)){const r=this._override_variable_decl();return r!=null&&(r.attributes=e),this._consume(h.tokens.semicolon,"Expected ';'."),r}if(this._check(h.keywords.let)){const r=this._global_let_decl();return r!=null&&(r.attributes=e),this._consume(h.tokens.semicolon,"Expected ';'."),r}if(this._check(h.keywords.const)){const r=this._global_const_decl();return r!=null&&(r.attributes=e),this._consume(h.tokens.semicolon,"Expected ';'."),r}if(this._check(h.keywords.struct)){const r=this._struct_decl();return r!=null&&(r.attributes=e),r}if(this._check(h.keywords.fn)){const r=this._function_decl();return r!=null&&(r.attributes=e),r}return null}_function_decl(){if(!this._match(h.keywords.fn))return null;const e=this._consume(h.tokens.ident,"Expected function name.").toString();this._consume(h.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(h.tokens.paren_right))do{if(this._check(h.tokens.paren_right))break;const s=this._attribute(),a=this._consume(h.tokens.ident,"Expected argument name.").toString();this._consume(h.tokens.colon,"Expected ':' for argument type.");const o=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=o,r.push(new ql(a,u,s)))}while(this._match(h.tokens.comma));this._consume(h.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(h.tokens.arrow)){const s=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=s)}const i=this._compound_statement();return new Or(e,r,n,i)}_compound_statement(){const e=[];for(this._consume(h.tokens.brace_left,"Expected '{' for block.");!this._check(h.tokens.brace_right);){const r=this._statement();r!==null&&e.push(r)}return this._consume(h.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(h.tokens.semicolon)&&!this._isAtEnd(););if(this._check(h.keywords.if))return this._if_statement();if(this._check(h.keywords.switch))return this._switch_statement();if(this._check(h.keywords.loop))return this._loop_statement();if(this._check(h.keywords.for))return this._for_statement();if(this._check(h.keywords.while))return this._while_statement();if(this._check(h.keywords.continuing))return this._continuing_statement();if(this._check(h.keywords.static_assert))return this._static_assert_statement();if(this._check(h.tokens.brace_left))return this._compound_statement();let e=null;return this._check(h.keywords.return)?e=this._return_statement():this._check([h.keywords.var,h.keywords.let,h.keywords.const])?e=this._variable_statement():this._match(h.keywords.discard)?e=new Il:this._match(h.keywords.break)?e=new zl:this._match(h.keywords.continue)?e=new Ul:e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(h.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(h.keywords.static_assert))return null;let e=this._optional_paren_expression();return new kl(e)}_while_statement(){if(!this._match(h.keywords.while))return null;let e=this._optional_paren_expression();const r=this._compound_statement();return new Sl(e,r)}_continuing_statement(){if(!this._match(h.keywords.continuing))return null;const e=this._compound_statement();return new Tl(e)}_for_statement(){if(!this._match(h.keywords.for))return null;this._consume(h.tokens.paren_left,"Expected '('.");const e=this._check(h.tokens.semicolon)?null:this._for_init();this._consume(h.tokens.semicolon,"Expected ';'.");const r=this._check(h.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(h.tokens.semicolon,"Expected ';'.");const n=this._check(h.tokens.paren_right)?null:this._for_increment();this._consume(h.tokens.paren_right,"Expected ')'.");const i=this._compound_statement();return new El(e,r,n,i)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(h.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let r=null;return this._match(h.tokens.equal)&&(r=this._short_circuit_or_expression()),new Re(e.name,e.type,e.storage,e.access,r)}if(this._match(h.keywords.let)){const e=this._consume(h.tokens.ident,"Expected name for let.").toString();let r=null;if(this._match(h.tokens.colon)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}this._consume(h.tokens.equal,"Expected '=' for let.");const n=this._short_circuit_or_expression();return new Br(e,r,null,null,n)}if(this._match(h.keywords.const)){const e=this._consume(h.tokens.ident,"Expected name for const.").toString();let r=null;if(this._match(h.tokens.colon)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}this._consume(h.tokens.equal,"Expected '=' for const.");const n=this._short_circuit_or_expression();return new ki(e,r,null,null,n)}return null}_increment_decrement_statement(){const e=this._current,r=this._unary_expression();if(r==null)return null;if(!this._check(h.increment_operators))return this._current=e,null;const n=this._consume(h.increment_operators,"Expected increment operator");return new Ml(n.type===h.tokens.plus_plus?rt.increment:rt.decrement,r)}_assignment_statement(){let e=null;if(this._check(h.tokens.brace_right))return null;let r=this._match(h.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const n=this._consume(h.assignment_operators,"Expected assignment operator."),i=this._short_circuit_or_expression();return new Al(yt.parse(n.lexeme),e,i)}_func_call_statement(){if(!this._check(h.tokens.ident))return null;const e=this._current,r=this._consume(h.tokens.ident,"Expected function name."),n=this._argument_expression_list();return n===null?(this._current=e,null):new Cl(r.lexeme,n)}_loop_statement(){if(!this._match(h.keywords.loop))return null;this._consume(h.tokens.brace_left,"Expected '{' for loop.");const e=[];let r=this._statement();for(;r!==null;){if(Array.isArray(r))for(let i of r)e.push(i);else e.push(r);r=this._statement()}let n=null;return this._match(h.keywords.continuing)&&(n=this._compound_statement()),this._consume(h.tokens.brace_right,"Expected '}' for loop."),new Pl(e,n)}_switch_statement(){if(!this._match(h.keywords.switch))return null;const e=this._optional_paren_expression();this._consume(h.tokens.brace_left,"Expected '{' for switch.");const r=this._switch_body();if(r==null||r.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(h.tokens.brace_right,"Expected '}' for switch."),new Ol(e,r)}_switch_body(){const e=[];if(this._match(h.keywords.case)){const r=this._case_selectors();this._match(h.tokens.colon),this._consume(h.tokens.brace_left,"Exected '{' for switch case.");const n=this._case_body();this._consume(h.tokens.brace_right,"Exected '}' for switch case."),e.push(new Vl(r,n))}if(this._match(h.keywords.default)){this._match(h.tokens.colon),this._consume(h.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(h.tokens.brace_right,"Exected '}' for switch default."),e.push(new jl(r))}if(this._check([h.keywords.default,h.keywords.case])){const r=this._switch_body();e.push(r[0])}return e}_case_selectors(){var e,r,n,i;const s=[(r=(e=this._shift_expression())===null||e===void 0?void 0:e.evaluate(this._context).toString())!==null&&r!==void 0?r:""];for(;this._match(h.tokens.comma);)s.push((i=(n=this._shift_expression())===null||n===void 0?void 0:n.evaluate(this._context).toString())!==null&&i!==void 0?i:"");return s}_case_body(){if(this._match(h.keywords.fallthrough))return this._consume(h.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const r=this._case_body();return r.length==0?e:[...e,r[0]]}_if_statement(){if(!this._match(h.keywords.if))return null;const e=this._optional_paren_expression(),r=this._compound_statement();let n=[];this._match_elseif()&&(n=this._elseif_statement(n));let i=null;return this._match(h.keywords.else)&&(i=this._compound_statement()),new Bl(e,r,n,i)}_match_elseif(){return this._tokens[this._current].type===h.keywords.else&&this._tokens[this._current+1].type===h.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(e=[]){const r=this._optional_paren_expression(),n=this._compound_statement();return e.push(new $l(r,n)),this._match_elseif()&&this._elseif_statement(e),e}_return_statement(){if(!this._match(h.keywords.return))return null;const e=this._short_circuit_or_expression();return new Nl(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(h.tokens.or_or);)e=new ye(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(h.tokens.and_and);)e=new ye(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(h.tokens.or);)e=new ye(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(h.tokens.xor);)e=new ye(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(h.tokens.and);)e=new ye(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([h.tokens.equal_equal,h.tokens.not_equal])?new ye(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([h.tokens.less_than,h.tokens.greater_than,h.tokens.less_than_equal,h.tokens.greater_than_equal]);)e=new ye(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([h.tokens.shift_left,h.tokens.shift_right]);)e=new ye(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([h.tokens.plus,h.tokens.minus]);)e=new ye(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([h.tokens.star,h.tokens.forward_slash,h.tokens.modulo]);)e=new ye(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([h.tokens.minus,h.tokens.bang,h.tokens.tilde,h.tokens.star,h.tokens.and])?new Dl(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),r=this._postfix_expression();return r&&(e.postfix=r),e}_postfix_expression(){if(this._match(h.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(h.tokens.bracket_right,"Expected ']'.");const r=this._postfix_expression();return r&&(e.postfix=r),e}if(this._match(h.tokens.period)){const e=this._consume(h.tokens.ident,"Expected member name."),r=this._postfix_expression(),n=new Mi(e.lexeme);return r&&(n.postfix=r),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(h.tokens.ident)){const n=this._previous().toString();if(this._check(h.tokens.paren_left)){const i=this._argument_expression_list(),s=this._getStruct(n);return s!=null?new wt(s,i):new Ai(n,i)}if(this._context.constants.has(n)){const i=this._context.constants.get(n);return new Pi(n,i.value)}return new Ci(n)}if(this._match(h.const_literal))return new Oi(parseFloat(this._previous().toString()));if(this._check(h.tokens.paren_left))return this._paren_expression();if(this._match(h.keywords.bitcast)){this._consume(h.tokens.less_than,"Expected '<'.");const n=this._type_decl();this._consume(h.tokens.greater_than,"Expected '>'.");const i=this._paren_expression();return new Fl(n,i)}const e=this._type_decl(),r=this._argument_expression_list();return new Rl(e,r)}_argument_expression_list(){if(!this._match(h.tokens.paren_left))return null;const e=[];do{if(this._check(h.tokens.paren_right))break;const r=this._short_circuit_or_expression();e.push(r)}while(this._match(h.tokens.comma));return this._consume(h.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(h.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(h.tokens.paren_right),new Bi([e])}_paren_expression(){this._consume(h.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(h.tokens.paren_right,"Expected ')'."),new Bi([e])}_struct_decl(){if(!this._match(h.keywords.struct))return null;const e=this._consume(h.tokens.ident,"Expected name for struct.").toString();this._consume(h.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(h.tokens.brace_right);){const i=this._attribute(),s=this._consume(h.tokens.ident,"Expected variable name.").toString();this._consume(h.tokens.colon,"Expected ':' for struct member type.");const a=this._attribute(),o=this._type_decl();o!=null&&(o.attributes=a),this._check(h.tokens.brace_right)?this._match(h.tokens.comma):this._consume(h.tokens.comma,"Expected ',' for struct member."),r.push(new Hl(s,o,i))}this._consume(h.tokens.brace_right,"Expected '}' after struct body.");const n=new Ve(e,r);return this._context.structs.set(e,n),n}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(h.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(h.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(h.keywords.const))return null;const e=this._consume(h.tokens.ident,"Expected variable name");let r=null;if(this._match(h.tokens.colon)){const s=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=s)}let n=null;if(this._match(h.tokens.equal)){const s=this._short_circuit_or_expression();if(s instanceof wt)n=s;else if(s instanceof Pi&&s.initializer instanceof wt)n=s.initializer;else try{const a=s.evaluate(this._context);n=new Oi(a)}catch{n=s}}const i=new ki(e.toString(),r,"","",n);return this._context.constants.set(i.name,i),i}_global_let_decl(){if(!this._match(h.keywords.let))return null;const e=this._consume(h.tokens.ident,"Expected variable name");let r=null;if(this._match(h.tokens.colon)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}let n=null;return this._match(h.tokens.equal)&&(n=this._const_expression()),new Br(e.toString(),r,"","",n)}_const_expression(){if(this._match(h.const_literal))return new Mi(this._previous().toString());const e=this._type_decl();this._consume(h.tokens.paren_left,"Expected '('.");let r=[];for(;!this._check(h.tokens.paren_right)&&(r.push(this._const_expression()),!!this._check(h.tokens.comma));)this._advance();return this._consume(h.tokens.paren_right,"Expected ')'."),new wt(e,r)}_variable_decl(){if(!this._match(h.keywords.var))return null;let e="",r="";this._match(h.tokens.less_than)&&(e=this._consume(h.storage_class,"Expected storage_class.").toString(),this._match(h.tokens.comma)&&(r=this._consume(h.access_mode,"Expected access_mode.").toString()),this._consume(h.tokens.greater_than,"Expected '>'."));const n=this._consume(h.tokens.ident,"Expected variable name");let i=null;if(this._match(h.tokens.colon)){const s=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=s)}return new Re(n.toString(),i,e,r,null)}_override_decl(){if(!this._match(h.keywords.override))return null;const e=this._consume(h.tokens.ident,"Expected variable name");let r=null;if(this._match(h.tokens.colon)){const n=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=n)}return new xi(e.toString(),r,null)}_enable_directive(){const e=this._consume(h.tokens.ident,"identity expected.");return new Ll(e.toString())}_type_alias(){const e=this._consume(h.tokens.ident,"identity expected.");this._consume(h.tokens.equal,"Expected '=' for type alias.");let r=this._type_decl();if(r===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);const n=new Si(e.toString(),r);return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([h.tokens.ident,...h.texel_format,h.keywords.bool,h.keywords.f32,h.keywords.i32,h.keywords.u32])){const n=this._advance(),i=n.toString();return this._context.structs.has(i)?this._context.structs.get(i):this._context.aliases.has(i)?this._context.aliases.get(i).type:new De(n.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(h.template_types)){let n=this._advance().toString(),i=null,s=null;return this._match(h.tokens.less_than)&&(i=this._type_decl(),s=null,this._match(h.tokens.comma)&&(s=this._consume(h.access_mode,"Expected access_mode for pointer").toString()),this._consume(h.tokens.greater_than,"Expected '>' for type.")),new Ti(n,i,s)}if(this._match(h.keywords.ptr)){let n=this._previous().toString();this._consume(h.tokens.less_than,"Expected '<' for pointer.");const i=this._consume(h.storage_class,"Expected storage_class for pointer");this._consume(h.tokens.comma,"Expected ',' for pointer.");const s=this._type_decl();let a=null;return this._match(h.tokens.comma)&&(a=this._consume(h.access_mode,"Expected access_mode for pointer").toString()),this._consume(h.tokens.greater_than,"Expected '>' for pointer."),new Gl(n,i.toString(),s,a)}const r=this._attribute();if(this._match(h.keywords.array)){let n=null,i=-1;const s=this._previous();if(this._match(h.tokens.less_than)){n=this._type_decl(),this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);let a="";this._match(h.tokens.comma)&&(a=this._shift_expression().evaluate(this._context).toString()),this._consume(h.tokens.greater_than,"Expected '>' for array."),i=a?parseInt(a):0}return new Ei(s.toString(),r,n,i)}return null}_texture_sampler_types(){if(this._match(h.sampler_type))return new bt(this._previous().toString(),null,null);if(this._match(h.depth_texture_type))return new bt(this._previous().toString(),null,null);if(this._match(h.sampled_texture_type)||this._match(h.multisampled_texture_type)){const e=this._previous();this._consume(h.tokens.less_than,"Expected '<' for sampler type.");const r=this._type_decl();return this._consume(h.tokens.greater_than,"Expected '>' for sampler type."),new bt(e.toString(),r,null)}if(this._match(h.storage_texture_type)){const e=this._previous();this._consume(h.tokens.less_than,"Expected '<' for sampler type.");const r=this._consume(h.texel_format,"Invalid texel format.").toString();this._consume(h.tokens.comma,"Expected ',' after texel format.");const n=this._consume(h.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(h.tokens.greater_than,"Expected '>' for sampler type."),new bt(e.toString(),r,n)}return null}_attribute(){let e=[];for(;this._match(h.tokens.attr);){const r=this._consume(h.attribute_name,"Expected attribute name"),n=new Ii(r.toString(),null);if(this._match(h.tokens.paren_left)){if(n.value=this._consume(h.literal_or_ident,"Expected attribute value").toString(),this._check(h.tokens.comma)){this._advance();do{const i=this._consume(h.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(i)}while(this._match(h.tokens.comma))}this._consume(h.tokens.paren_right,"Expected ')'")}e.push(n)}for(;this._match(h.tokens.attr_left);){if(!this._check(h.tokens.attr_right))do{const r=this._consume(h.attribute_name,"Expected attribute name"),n=new Ii(r.toString(),null);if(this._match(h.tokens.paren_left)){if(n.value=[this._consume(h.literal_or_ident,"Expected attribute value").toString()],this._check(h.tokens.comma)){this._advance();do{const i=this._consume(h.literal_or_ident,"Expected attribute value").toString();n.value.push(i)}while(this._match(h.tokens.comma))}this._consume(h.tokens.paren_right,"Expected ')'")}e.push(n)}while(this._match(h.tokens.comma));this._consume(h.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class nt{constructor(e,r){this.name=e,this.attributes=r,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Ui{constructor(e,r,n){this.name=e,this.type=r,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class jt extends nt{constructor(e,r){super(e,r),this.members=[],this.align=0}get isStruct(){return!0}}class Nr extends nt{constructor(e,r){super(e,r),this.count=0,this.stride=0}get isArray(){return!0}}class Gi extends nt{constructor(e,r,n,i){super(e,n),this.format=r,this.access=i}get isTemplate(){return!0}}var ne;(function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"})(ne||(ne={}));class qt{constructor(e,r,n,i,s,a,o){this.name=e,this.type=r,this.group=n,this.binding=i,this.attributes=s,this.resourceType=a,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Xl{constructor(e,r){this.name=e,this.type=r}}class $t{constructor(e,r){this.align=e,this.size=r}}class Jl{constructor(e,r,n,i){this.name=e,this.type=r,this.locationType=n,this.location=i,this.interpolation=null}}class Fi{constructor(e,r,n,i){this.name=e,this.type=r,this.locationType=n,this.location=i}}class Kl{constructor(e,r=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.name=e,this.stage=r}}class Ql{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class Zl{constructor(e,r,n,i){this.name=e,this.type=r,this.attributes=n,this.id=i}}class ed{constructor(e){this.resources=null,this.node=e}}class Te{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new Ql,this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const r=new Wl().parse(e);for(const n of r)n instanceof Or&&this._functions.set(n.name,new ed(n));for(const n of r){if(n instanceof Ve){const i=this._getTypeInfo(n,null);i instanceof jt&&this.structs.push(i);continue}if(n instanceof Si){this.aliases.push(this._getAliasInfo(n));continue}if(n instanceof xi){const i=n,s=this._getAttributeNum(i.attributes,"id",0),a=i.type!=null?this._getTypeInfo(i.type,i.attributes):null;this.overrides.push(new Zl(i.name,a,i.attributes,s));continue}if(this._isUniformVar(n)){const i=n,s=this._getAttributeNum(i.attributes,"group",0),a=this._getAttributeNum(i.attributes,"binding",0),o=this._getTypeInfo(i.type,i.attributes),u=new qt(i.name,o,s,a,i.attributes,ne.Uniform,i.access);this.uniforms.push(u);continue}if(this._isStorageVar(n)){const i=n,s=this._getAttributeNum(i.attributes,"group",0),a=this._getAttributeNum(i.attributes,"binding",0),o=this._getTypeInfo(i.type,i.attributes),u=this._isStorageTexture(o),c=new qt(i.name,o,s,a,i.attributes,u?ne.StorageTexture:ne.Storage,i.access);this.storage.push(c);continue}if(this._isTextureVar(n)){const i=n,s=this._getAttributeNum(i.attributes,"group",0),a=this._getAttributeNum(i.attributes,"binding",0),o=this._getTypeInfo(i.type,i.attributes),u=this._isStorageTexture(o),c=new qt(i.name,o,s,a,i.attributes,u?ne.StorageTexture:ne.Texture,i.access);u?this.storage.push(c):this.textures.push(c);continue}if(this._isSamplerVar(n)){const i=n,s=this._getAttributeNum(i.attributes,"group",0),a=this._getAttributeNum(i.attributes,"binding",0),o=this._getTypeInfo(i.type,i.attributes),u=new qt(i.name,o,s,a,i.attributes,ne.Sampler,i.access);this.samplers.push(u);continue}if(n instanceof Or){const i=this._getAttribute(n,"vertex"),s=this._getAttribute(n,"fragment"),a=this._getAttribute(n,"compute"),o=i||s||a;if(o){const u=new Kl(n.name,o==null?void 0:o.name);u.inputs=this._getInputs(n.args),u.outputs=this._getOutputs(n.returnType),u.resources=this._findResources(n),this.entry[o.name].push(u)}continue}}}_findResource(e){for(const r of this.uniforms)if(r.name==e)return r;for(const r of this.storage)if(r.name==e)return r;for(const r of this.textures)if(r.name==e)return r;for(const r of this.samplers)if(r.name==e)return r;return null}_findResources(e){const r=[],n=this,i=[];return e.search(s=>{if(s instanceof Dt)i.push({});else if(s instanceof Vt)i.pop();else if(s instanceof Re){if(i.length>0){const a=s;i[i.length-1][a.name]=a}}else if(s instanceof Br){if(i.length>0){const a=s;i[i.length-1][a.name]=a}}else if(s instanceof Ci){const a=s;if(i.length>0&&i[i.length-1][a.name])return;const o=n._findResource(a.name);o&&r.push(o)}else if(s instanceof Ai){const a=s,o=n._functions.get(a.name);o&&(o.resources===null&&(o.resources=n._findResources(o.node)),r.push(...o.resources))}}),[...new Map(r.map(s=>[s.name,s])).values()]}getBindGroups(){const e=[];function r(n,i){n>=e.length&&(e.length=n+1),e[n]===void 0&&(e[n]=[]),i>=e[n].length&&(e[n].length=i+1)}for(const n of this.uniforms){r(n.group,n.binding);const i=e[n.group];i[n.binding]=n}for(const n of this.storage){r(n.group,n.binding);const i=e[n.group];i[n.binding]=n}for(const n of this.textures){r(n.group,n.binding);const i=e[n.group];i[n.binding]=n}for(const n of this.samplers){r(n.group,n.binding);const i=e[n.group];i[n.binding]=n}return e}_getOutputs(e,r=void 0){if(r===void 0&&(r=[]),e instanceof Ve)this._getStructOutputs(e,r);else{const n=this._getOutputInfo(e);n!==null&&r.push(n)}return r}_getStructOutputs(e,r){for(const n of e.members)if(n.type instanceof Ve)this._getStructOutputs(n.type,r);else{const i=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(i!==null){const s=this._getTypeInfo(n.type,n.type.attributes),a=this._parseInt(i.value),o=new Fi(n.name,s,i.name,a);r.push(o)}}}_getOutputInfo(e){const r=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(r!==null){const n=this._getTypeInfo(e,e.attributes),i=this._parseInt(r.value);return new Fi("",n,r.name,i)}return null}_getInputs(e,r=void 0){r===void 0&&(r=[]);for(const n of e)if(n.type instanceof Ve)this._getStructInputs(n.type,r);else{const i=this._getInputInfo(n);i!==null&&r.push(i)}return r}_getStructInputs(e,r){for(const n of e.members)if(n.type instanceof Ve)this._getStructInputs(n.type,r);else{const i=this._getInputInfo(n);i!==null&&r.push(i)}}_getInputInfo(e){const r=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(r!==null){const n=this._getAttribute(e,"interpolation"),i=this._getTypeInfo(e.type,e.attributes),s=this._parseInt(r.value),a=new Jl(e.name,i,r.name,s);return n!==null&&(a.interpolation=this._parseString(n.value)),a}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const r=parseInt(e);return isNaN(r)?e:r}_getAlias(e){for(const r of this.aliases)if(r.name==e)return r.type;return null}_getAliasInfo(e){return new Xl(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,r){if(this._types.has(e))return this._types.get(e);if(e instanceof Ei){const i=e,s=this._getTypeInfo(i.format,i.attributes),a=new Nr(i.name,r);return a.format=s,a.count=i.count,this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Ve){const i=e,s=new jt(i.name,r);for(const a of i.members){const o=this._getTypeInfo(a.type,a.attributes);s.members.push(new Ui(a.name,o,a.attributes))}return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof bt){const i=e,s=i.format instanceof De,a=i.format?s?this._getTypeInfo(i.format,null):new nt(i.format,null):null,o=new Gi(i.name,a,r,i.access);return this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof Ti){const i=e,s=i.format?this._getTypeInfo(i.format,null):null,a=new Gi(i.name,s,r,i.access);return this._types.set(e,a),this._updateTypeInfo(a),a}const n=new nt(e.name,r);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var r,n;const i=this._getTypeSize(e);if(e.size=(r=i==null?void 0:i.size)!==null&&r!==void 0?r:0,e instanceof Nr){const s=this._getTypeSize(e.format);e.stride=(n=s==null?void 0:s.size)!==null&&n!==void 0?n:0,this._updateTypeInfo(e.format)}e instanceof jt&&this._updateStructInfo(e)}_updateStructInfo(e){var r;let n=0,i=0,s=0,a=0;for(let o=0,u=e.members.length;o<u;++o){const c=e.members[o],l=this._getTypeSize(c);if(!l)continue;(r=this._getAlias(c.type.name))!==null&&r!==void 0||c.type;const d=l.align,p=l.size;n=this._roundUp(d,n+i),i=p,s=n,a=Math.max(a,d),c.offset=n,c.size=p,this._updateTypeInfo(c.type)}e.size=this._roundUp(a,s+i),e.align=a}_getTypeSize(e){var r;if(e==null)return null;const n=this._getAttributeNum(e.attributes,"size",0),i=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Ui&&(e=e.type),e instanceof nt){const s=this._getAlias(e.name);s!==null&&(e=s)}{const s=Te._typeInfo[e.name];if(s!==void 0){const a=e.format==="f16"?2:1;return new $t(Math.max(i,s.align/a),Math.max(n,s.size/a))}}{const s=Te._typeInfo[e.name.substring(0,e.name.length-1)];if(s){const a=e.name[e.name.length-1]==="h"?2:1;return new $t(Math.max(i,s.align/a),Math.max(n,s.size/a))}}if(e instanceof Nr){let s=e,a=8,o=8;const u=this._getTypeSize(s.format);u!==null&&(o=u.size,a=u.align);const c=s.count,l=this._getAttributeNum((r=e==null?void 0:e.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(a,o));return o=c*l,n&&(o=n),new $t(Math.max(i,a),Math.max(n,o))}if(e instanceof jt){let s=0,a=0,o=0,u=0,c=0;for(const l of e.members){const d=this._getTypeSize(l.type);d!==null&&(s=Math.max(d.align,s),o=this._roundUp(d.align,o+u),u=d.size,c=o)}return a=this._roundUp(s,c+u),new $t(Math.max(i,s),Math.max(n,a))}return null}_isUniformVar(e){return e instanceof Re&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Re&&e.storage=="storage"}_isTextureVar(e){return e instanceof Re&&e.type!==null&&Te._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Re&&e.type!==null&&Te._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,r){const n=e;if(!n||!n.attributes)return null;const i=n.attributes;for(let s of i)if(s.name==r)return s;return null}_getAttributeNum(e,r,n){if(e===null)return n;for(let i of e)if(i.name==r){let s=i!==null&&i.value!==null?i.value:n;return s instanceof Array&&(s=s[0]),typeof s=="number"?s:typeof s=="string"?parseInt(s):n}return n}_roundUp(e,r){return Math.ceil(r/e)*e}}Te._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Te._textureTypes=h.any_texture_type.map(t=>t.name),Te._samplerTypes=h.sampler_type.map(t=>t.name);function it(t,e){return Object.fromEntries(e.map(r=>{const n=sd(t,r,0);return[r.name,{typeDefinition:n,group:r.group,binding:r.binding,size:n.size}]}))}function Ri(t,e,r){return{fields:Object.fromEntries(e.members.map(n=>[n.name,{offset:n.offset,type:zr(t,n.type,0)}])),size:e.size,offset:r}}function td(t){var e;if(t.name.includes("depth"))return"depth";switch((e=t.format)==null?void 0:e.name){case"f32":return"float";case"i32":return"sint";case"u32":return"uint";default:throw new Error("unknown texture sample type")}}function Di(t){return t.name.includes("2d_array")?"2d-array":t.name.includes("cube_array")?"cube-array":t.name.includes("3d")?"3d":t.name.includes("1d")?"1d":t.name.includes("cube")?"cube":"2d"}function rd(t){switch(t.access){case"read":return"read-only";case"write":return"write-only";case"read_write":return"read-write";default:throw new Error("unknonw storage texture access")}}function nd(t){return t.name.endsWith("_comparison")?"comparison":"filtering"}function id(t,e){const{binding:r,access:n,type:i}=t;switch(t.resourceType){case ne.Uniform:return{binding:r,visibility:e,buffer:{}};case ne.Storage:return{binding:r,visibility:e,buffer:{type:n===""||n==="read"?"read-only-storage":"storage"}};case ne.Texture:{if(i.name==="texture_external")return{binding:r,visibility:e,externalTexture:{}};const s=i.name.includes("multisampled");return{binding:r,visibility:e,texture:{sampleType:td(i),viewDimension:Di(i),multisampled:s}}}case ne.Sampler:return{binding:r,visibility:e,sampler:{type:nd(i)}};case ne.StorageTexture:return{binding:r,visibility:e,storageTexture:{access:rd(i),format:i.format.name,viewDimension:Di(i)}};default:throw new Error("unknown resource type")}}function Lr(t,e){const r={};for(const n of t)r[n.name]={stage:e,resources:n.resources.map(i=>{const{name:s,group:a}=i;return{name:s,group:a,entry:id(i,e)}})};return r}function Ht(t){const e=new Te(t),r=Object.fromEntries(e.structs.map(l=>[l.name,Ri(e,l,0)])),n=it(e,e.uniforms),i=it(e,e.storage.filter(l=>l.resourceType===ne.Storage)),s=it(e,e.storage.filter(l=>l.resourceType===ne.StorageTexture)),a=it(e,e.textures.filter(l=>l.type.name!=="texture_external")),o=it(e,e.textures.filter(l=>l.type.name==="texture_external")),u=it(e,e.samplers),c={...Lr(e.entry.vertex,GPUShaderStage.VERTEX),...Lr(e.entry.fragment,GPUShaderStage.FRAGMENT),...Lr(e.entry.compute,GPUShaderStage.COMPUTE)};return{externalTextures:o,samplers:u,structs:r,storages:i,storageTextures:s,textures:a,uniforms:n,entryPoints:c}}function Ir(t,e=""){if(!t)throw new Error(e)}function sd(t,e,r){switch(e.resourceType){case ne.Uniform:case ne.Storage:case ne.StorageTexture:return zr(t,e.type,r);default:return{size:0,type:e.type.name}}}function zr(t,e,r){if(e.isArray){Ir(!e.isStruct,"struct array is invalid"),Ir(!e.isStruct,"template array is invalid");const n=e;return{size:n.size,elementType:zr(t,n.format,r),numElements:n.count}}else{if(e.isStruct)return Ir(!e.isTemplate,"template struct is invalid"),Ri(t,e,r);{const n=e,i=e.isTemplate?`${n.name}<${n.format.name}>`:e.name;return{size:e.size,type:i}}}}function ad(t){switch(t.dimension){case"1d":return"1d";case"3d":return"3d";default:case"2d":return t.depthOrArrayLayers>1?"2d-array":"2d"}}function od(t){return[t.width,t.height||1,t.depthOrArrayLayers||1]}function ud(t){return Array.isArray(t)||Be(t)?[...t,1,1].slice(0,3):od(t)}function cd(t,e){const r=ud(t),n=Math.max(...r.slice(0,e==="3d"?3:2));return 1+Math.log2(n)|0}function ld(t){let e,r;switch(t){case"2d":e="texture_2d<f32>",r="textureSample(ourTexture, ourSampler, fsInput.texcoord)";break;case"2d-array":e="texture_2d_array<f32>",r=`
          textureSample(
              ourTexture,
              ourSampler,
              fsInput.texcoord,
              uni.layer)`;break;case"cube":e="texture_cube<f32>",r=`
          textureSample(
              ourTexture,
              ourSampler,
              faceMat[uni.layer] * vec3f(fract(fsInput.texcoord), 1))`;break;case"cube-array":e="texture_cube_array<f32>",r=`
          textureSample(
              ourTexture,
              ourSampler,
              faceMat[uni.layer] * vec3f(fract(fsInput.texcoord), 1), uni.layer)`;break;default:throw new Error(`unsupported view: ${t}`)}return`
        const faceMat = array(
          mat3x3f( 0,  0,  -2,  0, -2,   0,  1,  1,   1),   // pos-x
          mat3x3f( 0,  0,   2,  0, -2,   0, -1,  1,  -1),   // neg-x
          mat3x3f( 2,  0,   0,  0,  0,   2, -1,  1,  -1),   // pos-y
          mat3x3f( 2,  0,   0,  0,  0,  -2, -1, -1,   1),   // neg-y
          mat3x3f( 2,  0,   0,  0, -2,   0, -1,  1,   1),   // pos-z
          mat3x3f(-2,  0,   0,  0, -2,   0,  1,  1,  -1));  // neg-z

        struct VSOutput {
          @builtin(position) position: vec4f,
          @location(0) texcoord: vec2f,
        };

        @vertex fn vs(
          @builtin(vertex_index) vertexIndex : u32
        ) -> VSOutput {
          var pos = array<vec2f, 3>(
            vec2f(-1.0, -1.0),
            vec2f(-1.0,  3.0),
            vec2f( 3.0, -1.0),
          );

          var vsOutput: VSOutput;
          let xy = pos[vertexIndex];
          vsOutput.position = vec4f(xy, 0.0, 1.0);
          vsOutput.texcoord = xy * vec2f(0.5, -0.5) + vec2f(0.5);
          return vsOutput;
        }

        struct Uniforms {
          layer: u32,
        };

        @group(0) @binding(0) var ourSampler: sampler;
        @group(0) @binding(1) var ourTexture: ${e};
        @group(0) @binding(2) var<uniform> uni: Uniforms;

        @fragment fn fs(fsInput: VSOutput) -> @location(0) vec4f {
          _ = uni.layer; // make sure this is used so all pipelines have the same bindings
          return ${r};
        }
      `}const Vi=new WeakMap;function dd(t,e,r){let n=Vi.get(t);n||(n={pipelineByFormatAndView:{},moduleByViewType:{}},Vi.set(t,n));let{sampler:i,uniformBuffer:s,uniformValues:a}=n;const{pipelineByFormatAndView:o,moduleByViewType:u}=n;r=r||ad(e);let c=u[r];if(!c){const p=ld(r);c=t.createShaderModule({label:`mip level generation for ${r}`,code:p}),u[r]=c}i||(i=t.createSampler({minFilter:"linear",magFilter:"linear"}),s=t.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),a=new Uint32Array(1),Object.assign(n,{sampler:i,uniformBuffer:s,uniformValues:a}));const l=`${e.format}.${r}`;o[l]||(o[l]=t.createRenderPipeline({label:`mip level generator pipeline for ${r}`,layout:"auto",vertex:{module:c,entryPoint:"vs"},fragment:{module:c,entryPoint:"fs",targets:[{format:e.format}]}}));const d=o[l];for(let p=1;p<e.mipLevelCount;++p)for(let f=0;f<e.depthOrArrayLayers;++f){a[0]=f,t.queue.writeBuffer(s,0,a);const y=t.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:i},{binding:1,resource:e.createView({dimension:r,baseMipLevel:p-1,mipLevelCount:1})},{binding:2,resource:{buffer:s}}]}),v={label:"mip gen renderPass",colorAttachments:[{view:e.createView({dimension:"2d",baseMipLevel:p,mipLevelCount:1,baseArrayLayer:f,arrayLayerCount:1}),loadOp:"clear",storeOp:"store"}]},g=t.createCommandEncoder({label:"mip gen encoder"}),S=g.beginRenderPass(v);S.setPipeline(d),S.setBindGroup(0,y),S.draw(3),S.end();const T=g.finish();t.queue.submit([T])}}const hd=new Map([[Int8Array,{formats:["sint8","snorm8"],defaultForType:1}],[Uint8Array,{formats:["uint8","unorm8"],defaultForType:1}],[Int16Array,{formats:["sint16","snorm16"],defaultForType:1}],[Uint16Array,{formats:["uint16","unorm16"],defaultForType:1}],[Int32Array,{formats:["sint32","snorm32"],defaultForType:0}],[Uint32Array,{formats:["uint32","unorm32"],defaultForType:0}],[Float32Array,{formats:["float32","float32"],defaultForType:0}]]);new Map([...hd.entries()].map(([t,{formats:[e,r]}])=>[[e,t],[r,t]]).flat());function pd(t){const e=t;return Be(e.data)||Array.isArray(e.data)}function ji(t){return Be(t)||Array.isArray(t)||pd(t)}function fd(t,e){if(Be(t))return t;const{Type:r}=Ur(e);return new r(t)}function md(t,e,r,n="2d"){if(r%1!==0)throw new Error("can't guess dimensions");if(!t&&!e){const s=Math.sqrt(r/(n==="cube"?6:1));s%1===0?(t=s,e=s):(t=r,e=1)}else if(e){if(!t&&(t=r/e,t%1))throw new Error("can't guess dimensions")}else if(e=r/t,e%1)throw new Error("can't guess dimensions");const i=r/t/e;if(i%1)throw new Error("can't guess dimensions");return[t,e,i]}function _d(t){switch(t){case"1d":return"1d";case"3d":return"3d";default:return"2d"}}const gd={"8snorm":Int8Array,"8unorm":Uint8Array,"8sint":Int8Array,"8uint":Uint8Array,"16snorm":Int16Array,"16unorm":Uint16Array,"16sint":Int16Array,"16uint":Uint16Array,"32snorm":Int32Array,"32unorm":Uint32Array,"32sint":Int32Array,"32uint":Uint32Array,"16float":Uint16Array,"32float":Float32Array},vd=/([a-z]+)(\d+)([a-z]+)/;function Ur(t){const[,e,r,n]=vd.exec(t),i=e.length,s=parseInt(r)/8,a=i*s,o=gd[`${r}${n}`];return{channels:e,numChannels:i,bytesPerChannel:s,bytesPerElement:a,Type:o}}function yd(t,e){return[t.width,t.height,t.depthOrArrayLayers].map(r=>Math.max(1,Math.floor(r/2**e)))}function bd(t,e,r,n){const i=fd(r.data||r,e.format),s=yd(e,0),{bytesPerElement:a}=Ur(e.format),o=n.origin||[0,0,0];t.queue.writeTexture({texture:e,origin:o},i,{bytesPerRow:a*s[0],rowsPerImage:s[1]},s)}function wd(t,e,r,n={}){r.forEach((i,s)=>{const a=[0,0,s+(n.baseArrayLayer||0)];if(ji(i))bd(t,e,i,{origin:a});else{const o=i,{flipY:u,premultipliedAlpha:c,colorSpace:l}=n;t.queue.copyExternalImageToTexture({source:o,flipY:u},{texture:e,premultipliedAlpha:c,colorSpace:l,origin:a},qi(o,n))}}),e.mipLevelCount>1&&dd(t,e)}function qi(t,e){if(t instanceof HTMLVideoElement)return[t.videoWidth,t.videoHeight,1];{const r=t,{width:n,height:i}=r;if(n>0&&i>0&&!ji(t))return[n,i,1];const s=e.format||"rgba8unorm",{bytesPerElement:a,bytesPerChannel:o}=Ur(s),u=Be(t)||Array.isArray(t)?t:t.data,c=(Be(u)?u.byteLength:u.length*o)/a;return md(n,i,c)}}function xd(t,e,r={}){const n=qi(e[0],r);n[2]=n[2]>1?n[2]:e.length;const i=t.createTexture({dimension:_d(r.dimension),format:r.format||"rgba8unorm",mipLevelCount:r.mipLevelCount?r.mipLevelCount:r.mips?cd(n):1,size:n,usage:(r.usage??0)|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return wd(t,i,e,r),i}function kd(t,e,r={}){return xd(t,[e],r)}const $i=`
fn pixel2tex(pixel: f32, noOfPixels: u32) -> f32 {
  return (pixel + 0.5) / f32(noOfPixels);
}

fn tex2pixel(tex: f32, noOfPixels: u32) -> f32 {
  return tex * f32(noOfPixels) - 0.5;
}

fn pixel2grid(p: f32) -> u32 {
  return u32(p + 0.5);
}

fn textureUV(id: vec2u, size: vec2u) -> vec2f {
  // Pixel coordinates (centre of pixel, origin at bottom left)
  let fragCoord = vec2f(f32(id.x) + .5, f32(size.y - id.y) - .5);  // flipY

  // Normalised pixel coordinates (from 0 to 1)
  let uv = fragCoord / vec2f(size);

  return uv;
}

fn texturePixel(uv: vec2f, size: vec2u) -> vec2u {
  return vec2u(uv * vec2f(size) - 0.5);
}
`,Sd=`
fn textureGrid(uv: vec2f, size: vec2u) -> vec4f {
  let pixel_center = uv * vec2f(size) - 0.5;
  let grid = vec2f(vec2u(pixel_center));
  let gsp = select(
      pixel_center - grid, 
      vec2f(0.0), 
      pixel_center<=vec2f(0.0) // || pixel_center>=vec2f(size)-1.0  \u540E\u9762\u8FD9\u79CD\u60C5\u51B5\u4E00\u822C\u4E0D\u4F1A\u53D1\u751F
  );
  return vec4f(grid, gsp);
}
`,Gr=(t,e)=>t?`
${Sd}

fn biFilter(left_bottom: vec4f, left_top: vec4f, right_bottom: vec4f, right_top: vec4f, gap: vec2f) -> vec4f {
  let a = mix(left_bottom, left_top, gap.y);
  let b = mix(right_bottom, right_top, gap.y);
  return mix(a, b, gap.x);
}

fn textureLevel(map: texture_2d<f32>, uv: vec2f, level: u32) -> vec4f {
  // remap to mip size
  let mip_size = textureDimensions(map, level);
  let grid = textureGrid(uv, mip_size);
  let left_bottom = vec2u(grid.xy);
  let left_top = left_bottom + vec2u(0u, 1u);  // \u4F1A\u81EA\u52A8\u622A\u65AD\uFF0C\u6216\u8005\u8FD4\u56DE 0\uFF0C\u56E0\u6B64\u4E0D\u9700\u8981\u624B\u52A8\u622A\u65AD
  let right_bottom = left_bottom + vec2u(1u, 0u); 
  let right_top = left_bottom + vec2u(1u, 1u); 
  let gap = grid.zw;

  let res1 = textureLoad(map, left_bottom, level);
  let res2 = textureLoad(map, left_top, level);
  let res3 = textureLoad(map, right_bottom, level);
  let res4 = textureLoad(map, right_top, level);
  
  let res = biFilter(res1, res2, res3, res4, gap);
  return res;
}

fn texture(map: texture_2d<f32>, uv: vec2f, mipLevel: f32) -> vec4f {
  let level = u32(mipLevel);
  let res1 = textureLevel(map, uv, level);
  let res2 = textureLevel(map, uv, level+1u);
  let gap = mipLevel - f32(level);
  let res = mix(res1, res2, gap);
  return res;
}`:`
fn texture(map: texture_2d<f32>, uv: vec2f, mipLevel: f32) -> vec4f {
  return textureSampleLevel(map, ${e}, uv, mipLevel); 
}
`,Hi=`
fn SphereCoord2Dir(phi: f32, theta: f32) -> vec3f {
  return vec3f(sin(theta)*cos(phi), sin(theta)*sin(phi), cos(theta));
}

fn Dir2SphereCoord(dir: vec3f) -> vec2f {
  let theta = acos(dir.z);
  let phi = atan2(dir.y, dir.x);
  return vec2f(phi, theta);
}

fn SphereTexCoord2Dir(tex: vec2f) -> vec3f {
  let phi = 2.0*PI*(0.5-tex.x);
  let theta = PI*(1.0-tex.y);
  return SphereCoord2Dir(phi, theta);
}

fn Dir2SphereTexCoord(dir: vec3f) -> vec2f {
  let angle = Dir2SphereCoord(dir);
  let s = 0.5 - angle.x / (2.0*PI);
  let t = 1.0 - angle.y / PI;
  return vec2f(s, t);
}
`,Td=`
fn getNormalSpace(normal: vec3f) -> mat3x3f {
  let someVec = vec3f(1.0, 0.0, 0.0);
  var tang = cross(someVec, normal);
  if(length(tang)<1e-8){  // normal parallel to someVec
    tang = vec3f(0.0, 1.0, 0.0);
  }
  tang = normalize(tang);
  let biTang = normalize(cross(normal, tang));
  return mat3x3f(tang, biTang, normal);
}
`,Ed=`
// from http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
// Hacker's Delight, Henry S. Warren, 2001
fn radicalInverse(i_bits: u32) -> f32 {
  var bits = (i_bits << 16u) | (i_bits >> 16u);
  bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
  bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
  bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
  bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
  return f32(bits) * 2.3283064365386963e-10; // / 0x100000000
}

fn hammersley(n: u32, N: u32) -> vec2f {
  return vec2f(f32(n) / f32(N), radicalInverse(n));
}
`,be="material",Yi=`
struct Material { 
  baseColorFactor: vec4f,
  metallicFactor: f32,
  roughnessFactor: f32,
  emissiveFactor: vec3f,
  normalScale:f32,
  occlusionStrength: f32,
  alphaCutoff: f32,
  applyNormalMap: u32,
  useEnvMap: u32,
}

@group(2) @binding(0) var<uniform> ${be}: Material;
`,Md=t=>Rt`

const PI = 3.141592653589793;
const RECIPROCAL_PI = 0.3183098861837907;
const RECIPROCAL_2PI = 0.15915494309189535;
const ESP = 0.001;

const reflectance = 0.5;

${vi}
${yi}
${Yi}
// 贴图
@group(2) @binding(1) var baseColorTexture: texture_2d<f32>;
@group(2) @binding(2) var normalTexture: texture_2d<f32>;
@group(2) @binding(3) var metallicRoughnessTexture: texture_2d<f32>;
@group(2) @binding(4) var emissiveTexture: texture_2d<f32>;
@group(2) @binding(5) var occlusionTexture: texture_2d<f32>;

// sampler
@group(2) @binding(6) var materialSampler: sampler;

fn lin2rgb(lin: vec3f) -> vec3f {
  return pow(lin, vec3f(1.0/2.2));
}

fn rgb2lin(rgb: vec3f) -> vec3f {
  return pow(rgb, vec3f(2.2));
}

// from http://www.thetenthplanet.de/archives/1180
fn cotangentFrame(N: vec3f, p: vec3f, uv: vec2f) -> mat3x3f
{
    // get edge vectors of the pixel triangle
    let dp1 = dpdx( p );
    let dp2 = dpdy( p );
    let duv1 = dpdx( uv );
    let duv2 = dpdy( uv );
 
    // solve the linear system
    let dp2perp = cross( dp2, N );
    let dp1perp = cross( N, dp1 );
    let T = dp2perp * duv1.x + dp1perp * duv2.x;
    let B = dp2perp * duv1.y + dp1perp * duv2.y;
 
    // construct a scale-invariant frame 
    let invmax = inverseSqrt( max( dot(T,T), dot(B,B) ) );
    return mat3x3f( T * invmax, B * invmax, N );
}

fn applyNormalMap(localNorm: vec3f, uv0: vec2f, normal: vec3f, p: vec3f) -> vec3f {
  let n = normalize(2.0 * localNorm - 1.0);
  let tbn = cotangentFrame(normal, -p, uv0);
  return normalize(tbn * n);
}

fn fresnelSchlick(F0: vec3f, VoH: f32) -> vec3f {
  return F0 + (1.0 - F0) * pow( (1.0 - VoH), 5.0);
}

fn D_GGX(roughness: f32, NoH: f32) -> f32 {
  let alpha2 = pow(roughness, 4.0);
  return RECIPROCAL_PI * alpha2 / pow(1.0 + NoH*NoH*(alpha2-1.0), 2.0);
}

fn G1_SchlickGGX(k: f32, NoX: f32) -> f32 {
  return max(NoX,ESP) / ( k + (1.0-k)*NoX );
}

fn G_Smith(roughness: f32, NoL: f32, NoV: f32) -> f32 {
  let k = roughness*roughness*0.5;
  return G1_SchlickGGX(k, NoL) * G1_SchlickGGX(k, NoV);
}

fn cook_torrance_MicrofacetBRDF(l: vec3f, n: vec3f, v: vec3f, baseColor: vec3f, 
                                  roughness: f32, metallic: f32, reflectance: f32) -> vec3f {
  let h = normalize(l+v);
  let VoH = max(dot(v,h),0.0);
  let NoH = max(dot(n,h),0.0);
  let NoV = max(dot(n,v),0.0);
  let NoL = max(dot(n,l),0.0);
  
  // metal F0 is baseColor, dielectric F0 is reflectance
  let F0 = mix(vec3f(0.16 * reflectance * reflectance), baseColor, metallic);
  
  let F = fresnelSchlick(F0, NoH);
  let D = D_GGX(roughness, NoH);
  let G = G_Smith(roughness, NoL, NoV);
  let spec = (D*G)/(4.0*max(NoL,ESP)*max(NoV,ESP));
  
  // metal diffuse is zero, dielectric diffuse is baseColor*transmitted
  let diff = RECIPROCAL_PI * mix(baseColor, vec3f(0.0), metallic); 
  
  return (1.0-F)*diff + F*spec;
}

struct Light {
  dir: vec3f,
  ir: vec3f,
};

fn irradiance_direction_light(in_light: InputLight, n: vec3f) -> Light {
  var light: Light;
  let l = normalize(-in_light.dir);  // towards light
  let irradiance = max(dot(l,n),0.0) * in_light.flux;
  light.dir = l;
  light.ir = irradiance * rgb2lin(in_light.color.rgb);
  return light;
}

fn irradiance_point_light(in_light: InputLight, pos: vec3f, n: vec3f) -> Light {
  var light: Light;
  let lightDir = in_light.pos - pos;
  let r = length(lightDir);
  let l = normalize(lightDir);
  let irradiance = max(dot(l,n),0.0) * in_light.flux / (4.0 * PI * pow(r, 2.0));
  light.dir = l;
  light.ir = irradiance * rgb2lin(in_light.color.rgb);
  return light;
}

fn radiance_render(brdf: vec3f, ir: vec3f) -> vec3f {
  return brdf * ir;
}

${Gr(t.polyfill,"envSampler")}

${Hi}
fn envIBL(diffuseMap: texture_2d<f32>, specularMap: texture_2d<f32>, roughness: f32,
          n: vec3f, v: vec3f) -> vec3f {

  let r_v = reflect(-v, n);
  // linear
  let env_diff = texture(diffuseMap,Dir2SphereTexCoord(n),0.0).rgb;
  let env_spec = texture(specularMap,Dir2SphereTexCoord(r_v),roughness*${Fe}.specularDetails).rgb;
  let rho_d =  ${Fe}.diffuseFactor * rgb2lin(${Fe}.diffuseColor.rgb);
  let rho_s = ${Fe}.specularFactor * rgb2lin(${Fe}.specularColor.rgb);
  
  var radiance = rho_d * env_diff;
  let rn = dot(n, r_v);
  if(rn>0.0){
    radiance += rn * rho_s * env_spec;
  }
  return radiance;
}

fn textureSample_rgb2lin(texture: texture_2d<f32>, _sampler: sampler, uv: vec2f) -> vec4f {
  let col = textureSample(texture, _sampler, uv);
  return vec4f(rgb2lin(col.rgb), col.a);
}

@fragment
fn main(
  @location(0) norm: vec3f, 
  @location(1) pos: vec3f,
  @location(2) uv0: vec2f,  
  @location(3) cameraPos: vec3f
) -> @location(0) vec4f {

  let baseColor = ${be}.baseColorFactor * textureSample_rgb2lin(baseColorTexture, materialSampler, uv0);
  let metallicRoughness = textureSample(metallicRoughnessTexture, materialSampler, uv0);
  let roughness = ${be}.roughnessFactor * metallicRoughness.g;
  let metallic = ${be}.metallicFactor * metallicRoughness.b;
  let emissiveColor = ${be}.emissiveFactor * textureSample_rgb2lin(emissiveTexture, materialSampler, uv0).rgb;
  
  let v = normalize(cameraPos-pos);
  let n = select(normalize(norm), 
                applyNormalMap(textureSample(normalTexture, materialSampler, uv0).xyz, uv0, normalize(norm), v),
                bool(${be}.applyNormalMap));

  var radiance = emissiveColor + 
            select(vec3f(0.0), envIBL(diffuseMap,specularMap,roughness,n,v), bool(${be}.useEnvMap));
  ///////////////////////////////////////////
  for(var i=0u; i<${et}.lightNums; i++){
    let in_light = ${et}.lights[i];
    var out_light: Light;
    switch in_light.ltype {
      case 1: {
        out_light = irradiance_direction_light(in_light, n);
        break; 
      }
      case 2: {
        out_light = irradiance_point_light(in_light, pos, n); 
        break; 
      }
      default: {
        break; 
      }
    }
    let brdf = cook_torrance_MicrofacetBRDF(out_light.dir, n, v, baseColor.rgb,
                          roughness, metallic, reflectance);
                          
    radiance += radiance_render(brdf, out_light.ir);
  }
  ///////////////////////////////////////////
  let rgb = lin2rgb(radiance);

  #if ${t.useAlphaCutoff}
    if(baseColor.a < ${be}.alphaCutoff){
      discard;
    }
  #endif
  return vec4f(rgb, baseColor.a);
}
`,Ad=(t,e)=>new Promise(r=>{const n=setInterval(()=>{e()&&(clearInterval(n),r(!0))},t)});class Cd{static list(e){const r=[];let n=!1;for(;!n;){const{value:i,done:s}=e.next();!s&&r.push(i),n=s}return r}static filter(e,r){const n=[];let i=!1;for(;!i;){const{value:s,done:a}=e.next();!a&&r(s)&&n.push(s),i=a}return n}static map(e,r){const n=[];let i=!1;for(;!i;){const{value:s,done:a}=e.next();!a&&n.push(r(s)),i=a}return n}}const Wi=async(t,e)=>{var n;const r=await fetch(t);if(r.status>=200&&r.status<400){const i=(n=r.body)==null?void 0:n.getReader(),s=+(r.headers.get("Content-Length")??0);let a=0;const o=[];return i==null?void 0:i.read().then(function u({done:c,value:l}){if(c){if(a!==s)throw new Error("received length is not equal to content length");const d=new Uint8Array(a);let p=0;for(let f of o)d.set(f,p),p+=f.length;return new Blob([d])}return o.push(l),a+=l.length,e&&e(a/s),i.read().then(u)})}else throw new Error(`${r.status}: ${r.statusText}`)},oe=class oe{static checkTextureIsValid(e,r){const n=!e||e.width!==r[0]||e.height!==r[1];return n&&e&&e.destroy(),n}static createDepthTexture(e,r,n){return oe.checkTextureIsValid(oe.depthTexture,r)&&(oe.depthTexture=e.createTexture({size:r,format:n??oe.depthFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT})),oe.depthTexture}static createMultiSampleTexture(e,r,n,i){return oe.checkTextureIsValid(oe.multiSampleTexture,r)&&(oe.multiSampleTexture=e.createTexture({format:i??oe.renderFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT,size:r,sampleCount:n})),oe.multiSampleTexture}};w(oe,"renderFormat","rgba8unorm"),w(oe,"depthFormat","depth24plus"),w(oe,"depthTexture"),w(oe,"multiSampleTexture");let je=oe;var Xi=typeof global=="object"&&global&&global.Object===Object&&global,Pd=typeof self=="object"&&self&&self.Object===Object&&self,Ee=Xi||Pd||Function("return this")(),st=Ee.Symbol,Ji=Object.prototype,Od=Ji.hasOwnProperty,Bd=Ji.toString,xt=st?st.toStringTag:void 0;function Nd(t){var e=Od.call(t,xt),r=t[xt];try{t[xt]=void 0;var n=!0}catch{}var i=Bd.call(t);return n&&(e?t[xt]=r:delete t[xt]),i}var Ld=Object.prototype,Id=Ld.toString;function zd(t){return Id.call(t)}var Ud="[object Null]",Gd="[object Undefined]",Ki=st?st.toStringTag:void 0;function kt(t){return t==null?t===void 0?Gd:Ud:Ki&&Ki in Object(t)?Nd(t):zd(t)}function St(t){return t!=null&&typeof t=="object"}var Yt=Array.isArray;function Qi(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var Fd="[object AsyncFunction]",Rd="[object Function]",Dd="[object GeneratorFunction]",Vd="[object Proxy]";function Zi(t){if(!Qi(t))return!1;var e=kt(t);return e==Rd||e==Dd||e==Fd||e==Vd}var Fr=Ee["__core-js_shared__"],es=function(){var t=/[^.]+$/.exec(Fr&&Fr.keys&&Fr.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function jd(t){return!!es&&es in t}var qd=Function.prototype,$d=qd.toString;function qe(t){if(t!=null){try{return $d.call(t)}catch{}try{return t+""}catch{}}return""}var Hd=/[\\^$.*+?()[\]{}|]/g,Yd=/^\[object .+?Constructor\]$/,Wd=Function.prototype,Xd=Object.prototype,Jd=Wd.toString,Kd=Xd.hasOwnProperty,Qd=RegExp("^"+Jd.call(Kd).replace(Hd,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Zd(t){if(!Qi(t)||jd(t))return!1;var e=Zi(t)?Qd:Yd;return e.test(qe(t))}function eh(t,e){return t==null?void 0:t[e]}function at(t,e){var r=eh(t,e);return Zd(r)?r:void 0}var Rr=at(Ee,"WeakMap"),th=9007199254740991,rh=/^(?:0|[1-9]\d*)$/;function nh(t,e){var r=typeof t;return e=e??th,!!e&&(r=="number"||r!="symbol"&&rh.test(t))&&t>-1&&t%1==0&&t<e}function ts(t,e){return t===e||t!==t&&e!==e}var ih=9007199254740991;function rs(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=ih}function sh(t){return t!=null&&rs(t.length)&&!Zi(t)}var ah=Object.prototype;function oh(t){var e=t&&t.constructor,r=typeof e=="function"&&e.prototype||ah;return t===r}function uh(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}var ch="[object Arguments]";function ns(t){return St(t)&&kt(t)==ch}var is=Object.prototype,lh=is.hasOwnProperty,dh=is.propertyIsEnumerable,hh=ns(function(){return arguments}())?ns:function(t){return St(t)&&lh.call(t,"callee")&&!dh.call(t,"callee")};function ph(){return!1}var ss=typeof Ce=="object"&&Ce&&!Ce.nodeType&&Ce,as=ss&&typeof Pe=="object"&&Pe&&!Pe.nodeType&&Pe,fh=as&&as.exports===ss,os=fh?Ee.Buffer:void 0,mh=os?os.isBuffer:void 0,Dr=mh||ph,_h="[object Arguments]",gh="[object Array]",vh="[object Boolean]",yh="[object Date]",bh="[object Error]",wh="[object Function]",xh="[object Map]",kh="[object Number]",Sh="[object Object]",Th="[object RegExp]",Eh="[object Set]",Mh="[object String]",Ah="[object WeakMap]",Ch="[object ArrayBuffer]",Ph="[object DataView]",Oh="[object Float32Array]",Bh="[object Float64Array]",Nh="[object Int8Array]",Lh="[object Int16Array]",Ih="[object Int32Array]",zh="[object Uint8Array]",Uh="[object Uint8ClampedArray]",Gh="[object Uint16Array]",Fh="[object Uint32Array]",Y={};Y[Oh]=Y[Bh]=Y[Nh]=Y[Lh]=Y[Ih]=Y[zh]=Y[Uh]=Y[Gh]=Y[Fh]=!0,Y[_h]=Y[gh]=Y[Ch]=Y[vh]=Y[Ph]=Y[yh]=Y[bh]=Y[wh]=Y[xh]=Y[kh]=Y[Sh]=Y[Th]=Y[Eh]=Y[Mh]=Y[Ah]=!1;function Rh(t){return St(t)&&rs(t.length)&&!!Y[kt(t)]}function Dh(t){return function(e){return t(e)}}var us=typeof Ce=="object"&&Ce&&!Ce.nodeType&&Ce,Tt=us&&typeof Pe=="object"&&Pe&&!Pe.nodeType&&Pe,Vh=Tt&&Tt.exports===us,Vr=Vh&&Xi.process,cs=function(){try{var t=Tt&&Tt.require&&Tt.require("util").types;return t||Vr&&Vr.binding&&Vr.binding("util")}catch{}}(),ls=cs&&cs.isTypedArray,ds=ls?Dh(ls):Rh,jh=Object.prototype,qh=jh.hasOwnProperty;function $h(t,e){var r=Yt(t),n=!r&&hh(t),i=!r&&!n&&Dr(t),s=!r&&!n&&!i&&ds(t),a=r||n||i||s,o=a?uh(t.length,String):[],u=o.length;for(var c in t)(e||qh.call(t,c))&&!(a&&(c=="length"||i&&(c=="offset"||c=="parent")||s&&(c=="buffer"||c=="byteLength"||c=="byteOffset")||nh(c,u)))&&o.push(c);return o}function Hh(t,e){return function(r){return t(e(r))}}var Yh=Hh(Object.keys,Object),Wh=Object.prototype,Xh=Wh.hasOwnProperty;function Jh(t){if(!oh(t))return Yh(t);var e=[];for(var r in Object(t))Xh.call(t,r)&&r!="constructor"&&e.push(r);return e}function Kh(t){return sh(t)?$h(t):Jh(t)}var Et=at(Object,"create");function Qh(){this.__data__=Et?Et(null):{},this.size=0}function Zh(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var ep="__lodash_hash_undefined__",tp=Object.prototype,rp=tp.hasOwnProperty;function np(t){var e=this.__data__;if(Et){var r=e[t];return r===ep?void 0:r}return rp.call(e,t)?e[t]:void 0}var ip=Object.prototype,sp=ip.hasOwnProperty;function ap(t){var e=this.__data__;return Et?e[t]!==void 0:sp.call(e,t)}var op="__lodash_hash_undefined__";function up(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=Et&&e===void 0?op:e,this}function $e(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}$e.prototype.clear=Qh,$e.prototype.delete=Zh,$e.prototype.get=np,$e.prototype.has=ap,$e.prototype.set=up;function cp(){this.__data__=[],this.size=0}function Wt(t,e){for(var r=t.length;r--;)if(ts(t[r][0],e))return r;return-1}var lp=Array.prototype,dp=lp.splice;function hp(t){var e=this.__data__,r=Wt(e,t);if(r<0)return!1;var n=e.length-1;return r==n?e.pop():dp.call(e,r,1),--this.size,!0}function pp(t){var e=this.__data__,r=Wt(e,t);return r<0?void 0:e[r][1]}function fp(t){return Wt(this.__data__,t)>-1}function mp(t,e){var r=this.__data__,n=Wt(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this}function Me(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}Me.prototype.clear=cp,Me.prototype.delete=hp,Me.prototype.get=pp,Me.prototype.has=fp,Me.prototype.set=mp;var Mt=at(Ee,"Map");function _p(){this.size=0,this.__data__={hash:new $e,map:new(Mt||Me),string:new $e}}function gp(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}function Xt(t,e){var r=t.__data__;return gp(e)?r[typeof e=="string"?"string":"hash"]:r.map}function vp(t){var e=Xt(this,t).delete(t);return this.size-=e?1:0,e}function yp(t){return Xt(this,t).get(t)}function bp(t){return Xt(this,t).has(t)}function wp(t,e){var r=Xt(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this}function He(t){var e=-1,r=t==null?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}He.prototype.clear=_p,He.prototype.delete=vp,He.prototype.get=yp,He.prototype.has=bp,He.prototype.set=wp;function xp(t,e){for(var r=-1,n=e.length,i=t.length;++r<n;)t[i+r]=e[r];return t}function kp(){this.__data__=new Me,this.size=0}function Sp(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r}function Tp(t){return this.__data__.get(t)}function Ep(t){return this.__data__.has(t)}var Mp=200;function Ap(t,e){var r=this.__data__;if(r instanceof Me){var n=r.__data__;if(!Mt||n.length<Mp-1)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new He(n)}return r.set(t,e),this.size=r.size,this}function Ne(t){var e=this.__data__=new Me(t);this.size=e.size}Ne.prototype.clear=kp,Ne.prototype.delete=Sp,Ne.prototype.get=Tp,Ne.prototype.has=Ep,Ne.prototype.set=Ap;function Cp(t,e){for(var r=-1,n=t==null?0:t.length,i=0,s=[];++r<n;){var a=t[r];e(a,r,t)&&(s[i++]=a)}return s}function Pp(){return[]}var Op=Object.prototype,Bp=Op.propertyIsEnumerable,hs=Object.getOwnPropertySymbols,Np=hs?function(t){return t==null?[]:(t=Object(t),Cp(hs(t),function(e){return Bp.call(t,e)}))}:Pp;const Lp=Np;function Ip(t,e,r){var n=e(t);return Yt(t)?n:xp(n,r(t))}function ps(t){return Ip(t,Kh,Lp)}var jr=at(Ee,"DataView"),qr=at(Ee,"Promise"),$r=at(Ee,"Set"),fs="[object Map]",zp="[object Object]",ms="[object Promise]",_s="[object Set]",gs="[object WeakMap]",vs="[object DataView]",Up=qe(jr),Gp=qe(Mt),Fp=qe(qr),Rp=qe($r),Dp=qe(Rr),Ye=kt;(jr&&Ye(new jr(new ArrayBuffer(1)))!=vs||Mt&&Ye(new Mt)!=fs||qr&&Ye(qr.resolve())!=ms||$r&&Ye(new $r)!=_s||Rr&&Ye(new Rr)!=gs)&&(Ye=function(t){var e=kt(t),r=e==zp?t.constructor:void 0,n=r?qe(r):"";if(n)switch(n){case Up:return vs;case Gp:return fs;case Fp:return ms;case Rp:return _s;case Dp:return gs}return e});const ys=Ye;var Vp=Ee.Uint8Array;const bs=Vp;var jp="__lodash_hash_undefined__";function qp(t){return this.__data__.set(t,jp),this}function $p(t){return this.__data__.has(t)}function Jt(t){var e=-1,r=t==null?0:t.length;for(this.__data__=new He;++e<r;)this.add(t[e])}Jt.prototype.add=Jt.prototype.push=qp,Jt.prototype.has=$p;function Hp(t,e){for(var r=-1,n=t==null?0:t.length;++r<n;)if(e(t[r],r,t))return!0;return!1}function Yp(t,e){return t.has(e)}var Wp=1,Xp=2;function ws(t,e,r,n,i,s){var a=r&Wp,o=t.length,u=e.length;if(o!=u&&!(a&&u>o))return!1;var c=s.get(t),l=s.get(e);if(c&&l)return c==e&&l==t;var d=-1,p=!0,f=r&Xp?new Jt:void 0;for(s.set(t,e),s.set(e,t);++d<o;){var y=t[d],v=e[d];if(n)var g=a?n(v,y,d,e,t,s):n(y,v,d,t,e,s);if(g!==void 0){if(g)continue;p=!1;break}if(f){if(!Hp(e,function(S,T){if(!Yp(f,T)&&(y===S||i(y,S,r,n,s)))return f.push(T)})){p=!1;break}}else if(!(y===v||i(y,v,r,n,s))){p=!1;break}}return s.delete(t),s.delete(e),p}function Jp(t){var e=-1,r=Array(t.size);return t.forEach(function(n,i){r[++e]=[i,n]}),r}function Kp(t){var e=-1,r=Array(t.size);return t.forEach(function(n){r[++e]=n}),r}var Qp=1,Zp=2,ef="[object Boolean]",tf="[object Date]",rf="[object Error]",nf="[object Map]",sf="[object Number]",af="[object RegExp]",of="[object Set]",uf="[object String]",cf="[object Symbol]",lf="[object ArrayBuffer]",df="[object DataView]",xs=st?st.prototype:void 0,Hr=xs?xs.valueOf:void 0;function hf(t,e,r,n,i,s,a){switch(r){case df:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case lf:return!(t.byteLength!=e.byteLength||!s(new bs(t),new bs(e)));case ef:case tf:case sf:return ts(+t,+e);case rf:return t.name==e.name&&t.message==e.message;case af:case uf:return t==e+"";case nf:var o=Jp;case of:var u=n&Qp;if(o||(o=Kp),t.size!=e.size&&!u)return!1;var c=a.get(t);if(c)return c==e;n|=Zp,a.set(t,e);var l=ws(o(t),o(e),n,i,s,a);return a.delete(t),l;case cf:if(Hr)return Hr.call(t)==Hr.call(e)}return!1}var pf=1,ff=Object.prototype,mf=ff.hasOwnProperty;function _f(t,e,r,n,i,s){var a=r&pf,o=ps(t),u=o.length,c=ps(e),l=c.length;if(u!=l&&!a)return!1;for(var d=u;d--;){var p=o[d];if(!(a?p in e:mf.call(e,p)))return!1}var f=s.get(t),y=s.get(e);if(f&&y)return f==e&&y==t;var v=!0;s.set(t,e),s.set(e,t);for(var g=a;++d<u;){p=o[d];var S=t[p],T=e[p];if(n)var E=a?n(T,S,p,e,t,s):n(S,T,p,t,e,s);if(!(E===void 0?S===T||i(S,T,r,n,s):E)){v=!1;break}g||(g=p=="constructor")}if(v&&!g){var M=t.constructor,A=e.constructor;M!=A&&"constructor"in t&&"constructor"in e&&!(typeof M=="function"&&M instanceof M&&typeof A=="function"&&A instanceof A)&&(v=!1)}return s.delete(t),s.delete(e),v}var gf=1,ks="[object Arguments]",Ss="[object Array]",Kt="[object Object]",vf=Object.prototype,Ts=vf.hasOwnProperty;function yf(t,e,r,n,i,s){var a=Yt(t),o=Yt(e),u=a?Ss:ys(t),c=o?Ss:ys(e);u=u==ks?Kt:u,c=c==ks?Kt:c;var l=u==Kt,d=c==Kt,p=u==c;if(p&&Dr(t)){if(!Dr(e))return!1;a=!0,l=!1}if(p&&!l)return s||(s=new Ne),a||ds(t)?ws(t,e,r,n,i,s):hf(t,e,u,r,n,i,s);if(!(r&gf)){var f=l&&Ts.call(t,"__wrapped__"),y=d&&Ts.call(e,"__wrapped__");if(f||y){var v=f?t.value():t,g=y?e.value():e;return s||(s=new Ne),i(v,g,r,n,s)}}return p?(s||(s=new Ne),_f(t,e,r,n,i,s)):!1}function Es(t,e,r,n,i){return t===e?!0:t==null||e==null||!St(t)&&!St(e)?t!==t&&e!==e:yf(t,e,r,n,Es,i)}function Ms(t,e){return Es(t,e)}function bf(t,e){return Math.floor((t+e-1)/e)*e}function wf(t,e,r,n){const i=n??j.create();let s=t[0],a=t[1],o=t[2],u=t[3],c=s+s,l=a+a,d=o+o,p=s*c,f=s*l,y=s*d,v=a*l,g=a*d,S=o*d,T=u*c,E=u*l,M=u*d,A=r[0],L=r[1],P=r[2];return i[0]=(1-(v+S))*A,i[1]=(f+M)*A,i[2]=(y-E)*A,i[3]=0,i[4]=(f-M)*L,i[5]=(1-(p+S))*L,i[6]=(g+T)*L,i[7]=0,i[8]=(y+E)*P,i[9]=(g-T)*P,i[10]=(1-(p+v))*P,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}function xf(t){if(t.matrix)return j.create(...t.matrix);{let e=t.scale??[1,1,1],r=t.rotation??[0,0,0,1],n=t.translation??[0,0,0];return wf(r,n,e)}}function As(t,e,r){const n=[],i=xf(t);return j.mul(e,i,i),n.push({name:t.name,matrix:i,mesh:t.mesh,camera:t.camera}),t.children&&n.push(...t.children.map(s=>As(r[s],i,r)).flat()),n}const kf=1179937895,Sf=2,Tf=1313821514,Ef=5130562;var Cs=(t=>(t[t.POINTS=0]="POINTS",t[t.LINE=1]="LINE",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t))(Cs||{}),Yr=(t=>(t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DOUBLE=5130]="DOUBLE",t))(Yr||{}),Ps=(t=>(t[t.BYTE=1]="BYTE",t[t.UNSIGNED_BYTE=1]="UNSIGNED_BYTE",t[t.SHORT=2]="SHORT",t[t.UNSIGNED_SHORT=2]="UNSIGNED_SHORT",t[t.INT=4]="INT",t[t.UNSIGNED_INT=4]="UNSIGNED_INT",t[t.FLOAT=4]="FLOAT",t[t.DOUBLE=8]="DOUBLE",t))(Ps||{}),Os=(t=>(t.BYTE="sint8",t.UNSIGNED_BYTE="uint8",t.SHORT="sint16",t.UNSIGNED_SHORT="uint16",t.INT="int32",t.UNSIGNED_INT="uint32",t.FLOAT="float32",t))(Os||{}),Wr=(t=>(t[t.SCALAR=1]="SCALAR",t[t.VEC2=2]="VEC2",t[t.VEC3=3]="VEC3",t[t.VEC4=4]="VEC4",t[t.MAT2=4]="MAT2",t[t.MAT3=9]="MAT3",t[t.MAT4=16]="MAT4",t))(Wr||{});class Mf{async load(e,r){var L,P,B,D;const{mips:n=!1,useEnvMap:i=!1,onProgress:s}=r??{},a=await(await Wi(e,O=>{s&&s("downloading",.7*O)})).arrayBuffer(),o=new Uint32Array(a,0,5);if(o[0]!=kf)throw Error("Provided file is not a gltf file");if(o[1]!=Sf)throw Error("Provided file is not gltf version 2");const u=o[3];if(o[4]!=Tf)throw Error("Invalid glB: The first chunk of the glB file is not a JSON chunk!");const c=JSON.parse(new TextDecoder("utf-8").decode(new Uint8Array(a,5*4,u)));console.log(c);const l=new Uint32Array(a,5*4+u,2),d=l[0];if(l[1]!=Ef)throw Error("Invalid glB: The second chunk of the glB file is not a binary chunk!");const p=new Nf(a,7*4+u,d),f=c.bufferViews.map(O=>new Lf(p,O)),y=c.accessors.map(O=>new If(f[O.bufferView],O)),v=((L=c.images)==null?void 0:L.map(O=>new zf(O,f[O.bufferView])))??[],g=((P=c.samplers)==null?void 0:P.map(O=>new ot(O)))??[],S=((B=c.textures)==null?void 0:B.map(O=>new Is(O,v[O.source],O.sampler!==void 0?g[O.sampler]:null)))??[],T=((D=c.materials)==null?void 0:D.map(O=>new Uf(O,S,i)))??[],E=c.meshes.map((O,H)=>{s&&s("parse mesh",.7+(H+1)/c.meshes.length*.1);const W=O.primitives.map(F=>{let Q=F.mode;if(Q===void 0&&(Q=4),!(Q in Cs))throw new Error(`Unsupported primitive mode ${Q}`);const se=F.indices!==void 0&&F.indices<y.length?y[F.indices]:null,ae=Object.keys(F.attributes).map(te=>({name:te,shaderLocation:Reflect.get(_t,te),accessor:y[Reflect.get(F.attributes,te)]})).filter(({shaderLocation:te})=>te!==void 0);return new Bf(se,Q,ae,F.material!==void 0?T[F.material]:void 0,F)});return new Pf(W,O)}),M=c.scenes[c.scene??0],A=M.nodes.map((O,H)=>{s&&s("parse nodes",.95+(H+1)/M.nodes.length*.05);const W=c.nodes[O];return As(W,j.identity(),c.nodes).filter(F=>F.mesh!==void 0).map(F=>new Cf(E[F.mesh],F))}).flat();return await Promise.all((v==null?void 0:v.map(async O=>{await O.view.createBitmap(O)}))??[]),new Af(A,E,M,{bufferViews:f,images:v,samplers:g,materials:T},{mips:n,useEnvMap:i})}}class Af{constructor(e,r,n,i,s){w(this,"record");w(this,"_mips");w(this,"_useEnvMap");this.a_nodes=e,this.a_meshs=r,this.resources=i,Object.assign(this,n),this.record=new mi,this.renderPipelines=new Map,this._mips=(s==null?void 0:s.mips)??!1,this._useEnvMap=(s==null?void 0:s.useEnvMap)??!1}upload(e,r){const{sampler:n,solidColorTexture:i}=r;ot.createDefaultSampler(n);const{images:s,samplers:a,bufferViews:o,materials:u}=this.resources;u.forEach(c=>c.uploadSolidColorTexture(i)),a.forEach(c=>c.uploadSampler(n)),o.forEach(c=>c.flag===0&&c.uploadBuffer(e)),s.map(c=>c.view.uploadTexture(e,this._mips))}build({device:e,format:r,depthFormat:n,scene:i,cached:s}){this.device=e,this.upload(e,s),this.nodeBindGroupLayout=e.createBindGroupLayout({label:"nodeBindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),this.materialBindGroupLayout=e.createBindGroupLayout({label:"materialBindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},...[1,2,3,4,5].map(p=>({binding:p,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"2d"}})),{binding:6,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]});const a=[i.bindGroupLayout],o=i.polyfill,u=new Map,c={total:0,offset:0,matrices:u,arrayBuffer:new Float32Array};this.a_nodes.forEach(p=>{const f={matrix:p.matrix,normalMatrix:p.calcNormalMatrix()};p.a_mesh.primitives.forEach(y=>{const v=JSON.stringify(y);let g=u.get(v);g||(g=[],u.set(v,g)),g.push(f),c.total++})});const l=e.createBuffer({size:16*2*4*c.total,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});this.instanceBindGroup=e.createBindGroup({layout:this.nodeBindGroupLayout,entries:[{binding:0,resource:{buffer:l}}]}),this.instanceBindGroupIndex=a.length,this.record&&this.record.bindGroupCount++,c.arrayBuffer=new Float32Array(l.getMappedRange());const d=new Map;this.a_meshs.forEach(p=>{p.a_primitives.forEach(f=>{var L;const{gpuBuffers:y,indices:v,pipelineCacheKey:g,vertexCount:S}=f.makeBuffers(o),T=JSON.stringify((L=f.a_material)==null?void 0:L.__json);let E=d.get(T);E||(E={primitive:f,bindGroup:f.makeBindGroup(e,this.materialBindGroupLayout),groupIndex:a.length+1},this.record&&this.record.bindGroupCount++,d.set(T,E));let M=this.renderPipelines.get(g);if(!M){const{pipeline:P,create:B}=Of(JSON.parse(g),e,pl,Md,[...a,this.nodeBindGroupLayout,this.materialBindGroupLayout],r,n);M={pipeline:P,materialPrimitivesMap:new Map},B&&this.record&&this.record.pipelineCount++,this.renderPipelines.set(g,M)}let A=M.materialPrimitivesMap.get(E);A||(A=[],M.materialPrimitivesMap.set(E,A)),A.push({buffers:y,indices:v,vertexCount:S,instanceInAll:this.setInstancePosForPrimitiveNodes(f,c)})})}),l.unmap()}setInstancePosForPrimitiveNodes(e,r){const n=r.matrices.get(JSON.stringify(e.__json)),i=r.offset,s=n.length;for(let a=0;a<s;a++){const o=(i+a)*32;r.arrayBuffer.set(n[a].matrix,o),r.arrayBuffer.set(n[a].normalMatrix,o+16)}return r.offset+=s,{first:i,count:s}}createInstanceForPrimitiveNodes(e,r,n,i){const s=n.get(JSON.stringify(r.__json)),a=s.length,o=e.createBuffer({size:16*2*4*a,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),u=new Float32Array(o.getMappedRange());for(let c=0;c<a;c++){const l=c*32;u.set(s[c].matrix,l),u.set(s[c].normalMatrix,l+16)}return o.unmap(),{bindGroup:e.createBindGroup({layout:i,entries:[{binding:0,resource:{buffer:o}}]}),count:a}}render(e){const r=new mi;return this.record&&Object.assign(r,this.record),r&&r.bindGroupSets++,e.setBindGroup(this.instanceBindGroupIndex,this.instanceBindGroup),this.renderPipelines.forEach(n=>{e.setPipeline(n.pipeline),r&&r.pipelineSets++,n.materialPrimitivesMap.forEach((i,s)=>{e.setBindGroup(s.groupIndex,s.bindGroup),r&&r.bindGroupSets++,i.forEach(a=>{a.buffers.forEach(({accessor:d,offset:p},f)=>{r&&r.bufferSets++,e.setVertexBuffer(f,d.view.gpuBuffer,p,d.byteLength)});const{first:o,count:u}=a.instanceInAll,{indices:c,vertexCount:l}=a;c?(r&&r.bufferSets++,e.setIndexBuffer(c.view.gpuBuffer,c.vertexType,c.byteOffset,c.byteLength),e.drawIndexed(c.count,u,0,0,o)):e.draw(l,u,0,o),r&&r.drawCount++})})}),Ms(Reflect.get(this,"lastRecord"),r)||(document.querySelector(".record").innerHTML=`
<div>pipelineCount: ${r.pipelineCount}</div>
<div>pipelineSets: ${r.pipelineSets}</div>
<div>bindGroupCount: ${r.bindGroupCount}</div>
<div>bindGroupSets: ${r.bindGroupSets}</div>
<div>bufferSets: ${r.bufferSets}</div>
<div>drawCount: ${r.drawCount}</div>
`),Reflect.set(this,"lastRecord",r),r}set mips(e){e!=this._mips&&(this._mips=e,this.resources.images.map(r=>r.view.uploadTexture(this.device,this._mips)),this.renderPipelines.forEach(r=>{const n=new Map;r.materialPrimitivesMap.forEach((i,s)=>{n.set({...s,bindGroup:s.primitive.reuploadTexture(this.device,this.materialBindGroupLayout)},i)}),r.materialPrimitivesMap=n}))}set useEnvMap(e){e!=this._useEnvMap&&(this._useEnvMap=e,this.renderPipelines.forEach(r=>{r.materialPrimitivesMap.forEach((n,i)=>{i.primitive.a_material&&(i.primitive.a_material.useEnvMap=e,i.primitive.rewriteUniformBuffer(this.device))})}))}}class Cf{constructor(e,r){w(this,"name");w(this,"matrix");w(this,"mesh");w(this,"camera");w(this,"bindGroup",null);this.a_mesh=e,this.name=r.name,this.mesh=r.mesh,this.camera=r.camera,this.matrix=r.matrix}calcNormalMatrix(){return j.transpose(j.inverse(this.matrix))}makeBindGroup(e,r){const n=e.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),i=this.calcNormalMatrix();return new Float32Array(n.getMappedRange()).set([...this.matrix,...i]),n.unmap(),this.bindGroup=e.createBindGroup({layout:r,entries:[{binding:0,resource:{buffer:n}}]}),this.bindGroup}}class Pf{constructor(e,r){this.a_primitives=e,Object.assign(this,r)}}const Bs=new Map,Ns=new Map;function Ls(t,e,r){const n=JSON.stringify(e);let i=Ns.get(n);return i||(i=t.createShaderModule({code:typeof r=="string"?r:r(e)}),Ns.set(n,i)),i}function Of(t,e,r,n,i,s,a){const o=JSON.stringify(t);let u=Bs.get(o);if(u)return{pipeline:u,create:!1};let c;switch(t.alphaMode){case"BLEND":c={color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one"}};break}return u=e.createRenderPipeline({layout:e.createPipelineLayout({bindGroupLayouts:i}),vertex:{module:Ls(e,t.shaderContext.vertex,r),entryPoint:"main",buffers:t.bufferLayout},fragment:{module:Ls(e,t.shaderContext.fragment,n),entryPoint:"main",targets:[{format:s,blend:c}]},primitive:{cullMode:t.doubleSided?"none":"back",...t.primitive},depthStencil:{format:a,depthWriteEnabled:!0,depthCompare:"less"}}),Bs.set(o,u),{pipeline:u,create:!0}}class Bf{constructor(e,r,n,i,s){w(this,"renderPipeline",null);w(this,"vertexCount",0);w(this,"bufferLayout",[]);w(this,"gpuBuffers",[]);w(this,"uniformBuffer",null);w(this,"defs");var a;this.a_indices=e,this.topology=r,this.attributeAccessors=n,this.a_material=i,this.__json=s,Object.assign(this,this.__json),(a=this.a_indices)==null||a.view.addUsage(GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST),this.setupPrimitive(),this.defs=Ht(Yi)}makeBuffers(e){var s,a;const r={topology:"triangle-list"};this.topology==5&&(r.topology="triangle-strip",this.a_indices&&(r.stripIndexFormat=this.a_indices.vertexType));const n=this.bufferLayout,i=((s=this.a_material)==null?void 0:s.alphaMode)??"OPAQUE";return{pipelineCacheKey:JSON.stringify({primitive:r,bufferLayout:n,alphaMode:i,doubleSided:((a=this.a_material)==null?void 0:a.doubleSided)??!1,shaderContext:{vertex:{useTexcoord:"TEXCOORD_0"in this.attributes,useAlphaCutoff:i=="MASK"},fragment:{polyfill:e}}}),vertexCount:this.vertexCount,gpuBuffers:this.gpuBuffers,indices:this.a_indices}}setupPrimitive(){const e=new Map,r=new Map;this.attributeAccessors.sort((n,i)=>n.accessor.byteOffset-i.accessor.byteOffset).forEach(({accessor:n,name:i,shaderLocation:s})=>{i=="POSITION"&&(this.vertexCount=n.count),n.view.addUsage(GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST);let a=e.get(n.bufferView),o,u=a&&Math.abs(n.byteOffset-a.attributes[0].offset)>=a.arrayStride;!a||u?(a={arrayStride:n.byteStride,attributes:[]},e.set(u?i:n.bufferView,a),r.set(a,{accessor:n,offset:n.byteOffset})):(o=r.get(a),o.offset=Math.min(o.offset,n.byteOffset)),a.attributes.push({shaderLocation:s,format:n.vertexType,offset:n.byteOffset})});for(const n of e.values()){const i=r.get(n);for(const s of n.attributes)s.offset-=i.offset;n.attributes=n.attributes.sort((s,a)=>s.shaderLocation-a.shaderLocation)}this.bufferLayout=[...e.values()].sort((n,i)=>n.attributes[0].shaderLocation-i.attributes[0].shaderLocation),this.gpuBuffers=this.bufferLayout.map(n=>r.get(n))}reuploadTexture(e,r){if(console.log("reupload texture"),!this.a_material)return;const n=this.a_material.textures,i=this.a_material.samplers.find(s=>!!s);return e.createBindGroup({layout:r,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},...n.map((s,a)=>{const o=s.a_image.view.texture;return{binding:a+1,resource:o.createView()}}),{binding:n.length+1,resource:(i==null?void 0:i.sampler)??ot.defaultSampler}]})}rewriteUniformBuffer(e){if(console.log("rewrite uniform buffer"),!this.a_material)return;const r=vt(this.defs.uniforms[be]);r.set(this.a_material.uniformValue),e.queue.writeBuffer(this.uniformBuffer,0,r.arrayBuffer)}makeBindGroup(e,r){if(!this.a_material)return;const n=vt(this.defs.uniforms[be]);n.set(this.a_material.uniformValue),this.uniformBuffer=e.createBuffer({size:n.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),e.queue.writeBuffer(this.uniformBuffer,0,n.arrayBuffer);const i=this.a_material.textures,s=this.a_material.samplers.find(a=>!!a);return e.createBindGroup({layout:r,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},...i.map((a,o)=>{const u=a.a_image.view.texture;return{binding:o+1,resource:u.createView()}}),{binding:i.length+1,resource:(s==null?void 0:s.sampler)??ot.defaultSampler}]})}}class Nf extends Uint8Array{constructor(e,r,n){return super(),new Uint8Array(e,r,n)}}class Lf{constructor(e,r){w(this,"viewBuffer");w(this,"usage",0);w(this,"format",null);w(this,"gpuBuffer",null);w(this,"texture",null);w(this,"bitmap",null);w(this,"flag",0);Object.assign(this,{byteStride:0,byteOffset:0,...r}),this.viewBuffer=e.subarray(this.byteOffset,this.byteOffset+this.byteLength)}setFlag(e){this.flag=e}setFormat(e){this.format=e}addUsage(e){this.usage=this.usage|e}async createBitmap(e){const r=new Blob([this.viewBuffer],{type:e.mimeType});this.bitmap=await createImageBitmap(r)}async uploadTexture(e,r){if(!this.format)throw new Error("Can't upload texture without format");if(!this.bitmap)throw new Error("Can't upload texture without create bitmap");this.texture=kd(e,this.bitmap,{mips:r})}uploadBuffer(e){var r;(r=this.gpuBuffer)==null||r.destroy(),this.gpuBuffer=e.createBuffer({size:bf(this.viewBuffer.byteLength,4),usage:this.usage,mappedAtCreation:!0}),Reflect.construct(this.viewBuffer.constructor,[this.gpuBuffer.getMappedRange()]).set(this.viewBuffer),this.gpuBuffer.unmap()}}class If{constructor(e,r){this.view=e,Object.assign(this,{byteOffset:0,...r})}get byteStride(){const e=Reflect.get(Wr,this.type)*Reflect.get(Ps,Reflect.get(Yr,this.componentType));return Math.max(e,this.view.byteStride)}get byteLength(){return this.count*this.byteStride}get vertexType(){const e=Reflect.get(Os,Reflect.get(Yr,this.componentType));if(!e)throw Error(`Unrecognized or unsupported glTF type ${this.componentType}`);const r=Reflect.get(Wr,this.type);return r>1?`${e}x${r}`:e}}class zf{constructor(e,r){this.view=r,Object.assign(this,e),r.setFlag(1),r.addUsage(GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT)}}const It=class It{constructor(e){w(this,"sampler",null);Object.assign(this,e)}static createDefaultSampler(e){It.defaultSampler||(It.defaultSampler=e.default)}uploadSampler(e){const r={addressModeU:this.addressModeForWrap(this.wrapS),addressModeV:this.addressModeForWrap(this.wrapT)};switch((!this.magFilter||this.magFilter===9729)&&(r.magFilter="linear"),this.minFilter){case WebGLRenderingContext.NEAREST:break;case WebGLRenderingContext.LINEAR:case WebGLRenderingContext.LINEAR_MIPMAP_NEAREST:r.minFilter="linear";break;case WebGLRenderingContext.NEAREST_MIPMAP_LINEAR:r.mipmapFilter="linear";break;case WebGLRenderingContext.LINEAR_MIPMAP_LINEAR:default:r.minFilter="linear",r.mipmapFilter="linear";break}this.sampler=e.get(r)}addressModeForWrap(e){switch(e){case 33071:return"clamp-to-edge";case 33648:return"mirror-repeat";default:return"repeat"}}};w(It,"defaultSampler",null);let ot=It;class Is{constructor(e,r,n){this.a_image=r,this.a_sampler=n,Object.assign(this,e)}}class Uf{constructor(e,r,n){w(this,"textures",[]);w(this,"samplers",[]);this.__json=e,this.a_textures=r,this.useEnvMap=n,Object.assign(this,e)}uploadSolidColorTexture(e){const r=je.renderFormat.split("-")[0];this.textures=[{a:this.pbrMetallicRoughness.baseColorTexture,d:"opaqueWhiteTexture",f:`${r}-srgb`},{a:this.normalTexture,d:"defaultNormalTexture",f:r},{a:this.pbrMetallicRoughness.metallicRoughnessTexture,d:"opaqueWhiteTexture",f:r},{a:this.emissiveTexture,d:"transparentBlackTexture",f:`${r}-srgb`},{a:this.occlusionTexture,d:"transparentBlackTexture",f:r}].map(({a:n,d:i,f:s})=>{const a=(n==null?void 0:n.index)!==void 0,o=a?this.a_textures[n==null?void 0:n.index]:new Is({source:-1,sampler:-1},{view:{texture:e.get({format:s,type:i})}},null);return a&&o.a_image.view.setFormat(s),this.samplers.includes(o.a_sampler)||this.samplers.push(o.a_sampler),o})}get uniformValue(){var e,r;return{baseColorFactor:this.pbrMetallicRoughness.baseColorFactor??[1,1,1,1],metallicFactor:this.pbrMetallicRoughness.metallicFactor??1,roughnessFactor:this.pbrMetallicRoughness.roughnessFactor??1,emissiveFactor:this.emissiveFactor??[0,0,0],normalScale:((e=this.normalTexture)==null?void 0:e.scale)??1,occlusionStrength:((r=this.occlusionTexture)==null?void 0:r.strength)??1,alphaCutoff:this.alphaCutoff??.5,applyNormalMap:this.normalTexture!==void 0?1:0,useEnvMap:this.useEnvMap?1:0}}}class Gf{constructor(e,r,n,i,s){w(this,"invScreen");w(this,"centerTranslation");w(this,"translation");w(this,"rotation");w(this,"camera");w(this,"invCamera");this.eye=e,this.center=r,this.up=n,this.zoomSpeed=i,this.screenDims=s;var a=Z.set(e[0],e[1],e[2]),o=Z.set(r[0],r[1],r[2]),u=Z.set(n[0],n[1],n[2]);Z.normalize(u,u);var c=Z.sub(o,a),l=Z.len(c);Z.normalize(c,c);var d=Z.cross(c,u);Z.normalize(d,d);var p=Z.cross(d,c);Z.normalize(p,p),Z.cross(d,c,p),Z.normalize(d,d),this.zoomSpeed=i,this.invScreen=[1/s[0],1/s[1]],this.centerTranslation=j.translation(r),j.inverse(this.centerTranslation,this.centerTranslation);var f=Z.set(0,0,-1*l);this.translation=j.translation(f);var y=Nn.create(d[0],d[1],d[2],p[0],p[1],p[2],-c[0],-c[1],-c[2]);Nn.transpose(y,y),this.rotation=Ze.fromMat(y),Ze.normalize(this.rotation,this.rotation),this.camera=j.create(),this.invCamera=j.create(),this.updateCameraMatrix()}rotate(e,r){var n=K.set(Qt(e[0]*2*this.invScreen[0]-1,-1,1),Qt(1-e[1]*2*this.invScreen[1],-1,1)),i=K.set(Qt(r[0]*2*this.invScreen[0]-1,-1,1),Qt(1-r[1]*2*this.invScreen[1],-1,1)),s=zs(n),a=zs(i);this.rotation=Ze.mul(this.rotation,s,this.rotation),this.rotation=Ze.mul(this.rotation,a,this.rotation),this.updateCameraMatrix()}zoom(e){var r=Z.set(0,0,e*this.invScreen[1]*this.zoomSpeed),n=j.translation(r);this.translation=j.mul(this.translation,n,this.translation),this.translation[14]>=-.2&&(this.translation[14]=-.2),this.updateCameraMatrix()}pan(e){var r=Oe.set(e[0]*this.invScreen[0]*Math.abs(this.translation[14]),e[1]*this.invScreen[1]*Math.abs(this.translation[14]),0,0),n=Oe.transformMat4(r,this.invCamera),i=j.translation(n);this.centerTranslation=j.mul(this.centerTranslation,i,this.centerTranslation),this.updateCameraMatrix()}updateCameraMatrix(){var e=j.fromQuat(this.rotation);this.camera=j.mul(e,this.centerTranslation,this.camera),this.camera=j.mul(this.translation,this.camera,this.camera),this.invCamera=j.invert(this.camera,this.invCamera)}eyePos(){return[this.invCamera[12],this.invCamera[13],this.invCamera[14]]}eyeDir(){var e=Oe.set(0,0,-1,0);return e=Oe.transformMat4(e,e,this.invCamera),e=Oe.normalize(e,e),[e[0],e[1],e[2]]}upDir(){var e=Oe.set(0,1,0,0);return e=Oe.transformMat4(e,e,this.invCamera),e=Oe.normalize(e,e),[e[0],e[1],e[2]]}}function zs(t){const e=K.dot(t,t);if(e<=1)return Ze.set(t[0],t[1],Math.sqrt(1-e),0);{const r=K.normalize(t);return Ze.set(r[0],r[1],0,0)}}function Qt(t,e,r){return t<e?e:t>r?r:t}let Ff=class{constructor(){w(this,"mousemove",null);w(this,"press",null);w(this,"wheel",null);w(this,"twoFingerDrag",null);w(this,"pinch",null)}registerForCanvas(t){let e;t.addEventListener("mousemove",i=>{i.preventDefault();const s=t.getBoundingClientRect(),a=[i.clientX-s.left,i.clientY-s.top];e?this.mousemove&&this.mousemove(e,a,i):e=[i.clientX-s.left,i.clientY-s.top],e=a}),t.addEventListener("mousedown",i=>{i.preventDefault();let s=t.getBoundingClientRect(),a=[i.clientX-s.left,i.clientY-s.top];this.press&&this.press(a,i)}),t.addEventListener("wheel",i=>{i.preventDefault(),this.wheel&&this.wheel(-i.deltaY)}),t.oncontextmenu=function(i){i.preventDefault()};const r={};t.addEventListener("touchstart",i=>{const s=t.getBoundingClientRect();i.preventDefault();for(let a=0;a<i.changedTouches.length;++a){const o=i.changedTouches[a];r[o.identifier]=[o.clientX-s.left,o.clientY-s.top],i.changedTouches.length==1&&this.press&&this.press(r[o.identifier],i)}}),t.addEventListener("touchmove",i=>{i.preventDefault();const s=t.getBoundingClientRect();if(Object.keys(r).length==1){if(this.mousemove){const a=i.changedTouches[0],o=r[a.identifier],u=[a.clientX-s.left,a.clientY-s.top];i.buttons=1,this.mousemove(o,u,i)}}else{const a={};for(let v=0;v<i.changedTouches.length;++v){let g=i.changedTouches[v];a[g.identifier]=[g.clientX-s.left,g.clientY-s.top]}let o=[];for(const v in r)v in a||(a[v]=r[v]),o.push(r[v]);let u=[];for(const v in a)u.push(a[v]);let c=[K.set(u[0][0]-o[0][0],u[0][1]-o[0][1]),K.set(u[1][0]-o[1][0],u[1][1]-o[1][1])],l=[K.create(),K.create()];K.normalize(l[0],c[0]),K.normalize(l[1],c[1]);let d=K.set(o[1][0]-o[0][0],o[1][1]-o[0][1]);K.normalize(d,d);let p=K.lerp(c[0],c[1],.5);K.normalize(p,p);let f=[K.dot(d,l[0]),K.dot(d,l[1])],y=[K.dot(p,l[0]),K.dot(p,l[1])];if(this.pinch&&Math.abs(f[0])>.5&&Math.abs(f[1])>.5&&Math.sign(f[0])!=Math.sign(f[1])){let v=K.distance(o[0],o[1]),g=K.distance(u[0],u[1]);this.pinch(g-v)}else if(this.twoFingerDrag&&Math.abs(y[0])>.5&&Math.abs(y[1])>.5&&Math.sign(y[0])==Math.sign(y[1])){let v=K.lerp(c[0],c[1],.5);v[1]=-v[1],this.twoFingerDrag(v)}}for(let a=0;a<i.changedTouches.length;++a){let o=i.changedTouches[a];r[o.identifier]=[o.clientX-s.left,o.clientY-s.top]}});let n=function(i){i.preventDefault();for(let s=0;s<i.changedTouches.length;++s){let a=i.changedTouches[s];delete r[a.identifier]}};t.addEventListener("touchcancel",n),t.addEventListener("touchend",n)}};const Qe=class Qe{constructor(){this.eye=[0,0,0],this.target=[0,0,0],this.up=[0,1,0],this.viewMatrix=j.identity(),this.cameraPosition=Z.zero()}lookAt(e,r,n){this.eye=e,r&&(this.target=r),n&&(this.up=n),this.viewMatrix=j.lookAt(this.eye,this.target,this.up),this.cameraPosition=Z.getTranslation(j.inverse(this.viewMatrix))}getBufferView(){return{projectionMatrix:this.matrix,viewMatrix:this.viewMatrix,cameraPosition:this.cameraPosition}}};w(Qe,"defs"),w(Qe,"view"),(()=>{try{Qe.defs=Ht(gi),Qe.view=vt(Qe.defs.uniforms[gt])}catch{}})();let We=Qe;class Rf extends We{constructor(e,r,n,i){super(),this.matrix=j.perspective(e,r,n,i)}}class Us{constructor(e,r,n){w(this,"arcballController");w(this,"id","orbitcontroller-tips");this.camera=e,this.canvas=r,this.options=n,this.arcballController=this.createArcBallCamera(e.eye,e.target,e.up)}createArcBallCamera(e,r,n){const i=this.canvas.clientWidth,s=this.canvas.clientHeight,{zoomSpeed:a}=this.options??{},o=new Gf(e,r,n,a??.5,[i,s]),u=new Ff;if(u.mousemove=(c,l,d)=>{d.buttons==1?o.rotate(c,l):d.buttons==2&&o.pan([l[0]-c[0],c[1]-l[1]])},u.wheel=c=>{o.zoom(c*.5)},u.registerForCanvas(this.canvas),!document.getElementById(this.id)){const c=document.createElement("div");c.innerText="Controls: left-click to drag, right-click to pan, scroll to zoom.",document.body.insertBefore(c,document.body.firstChild),c.id=this.id}return o}update(){this.camera.viewMatrix=this.arcballController.camera,this.camera.cameraPosition=Z.getTranslation(j.inverse(this.camera.viewMatrix))}}function Df(t){if(t&&!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}function ut(t,e){var r=t.__state.conversionName.toString(),n=Math.round(t.r),i=Math.round(t.g),s=Math.round(t.b),a=t.a,o=Math.round(t.h),u=t.s.toFixed(1),c=t.v.toFixed(1);if(e||r==="THREE_CHAR_HEX"||r==="SIX_CHAR_HEX"){for(var l=t.hex.toString(16);l.length<6;)l="0"+l;return"#"+l}else{if(r==="CSS_RGB")return"rgb("+n+","+i+","+s+")";if(r==="CSS_RGBA")return"rgba("+n+","+i+","+s+","+a+")";if(r==="HEX")return"0x"+t.hex.toString(16);if(r==="RGB_ARRAY")return"["+n+","+i+","+s+"]";if(r==="RGBA_ARRAY")return"["+n+","+i+","+s+","+a+"]";if(r==="RGB_OBJ")return"{r:"+n+",g:"+i+",b:"+s+"}";if(r==="RGBA_OBJ")return"{r:"+n+",g:"+i+",b:"+s+",a:"+a+"}";if(r==="HSV_OBJ")return"{h:"+o+",s:"+u+",v:"+c+"}";if(r==="HSVA_OBJ")return"{h:"+o+",s:"+u+",v:"+c+",a:"+a+"}"}return"unknown format"}var Gs=Array.prototype.forEach,At=Array.prototype.slice,k={BREAK:{},extend:function(t){return this.each(At.call(arguments,1),function(e){var r=this.isObject(e)?Object.keys(e):[];r.forEach((function(n){this.isUndefined(e[n])||(t[n]=e[n])}).bind(this))},this),t},defaults:function(t){return this.each(At.call(arguments,1),function(e){var r=this.isObject(e)?Object.keys(e):[];r.forEach((function(n){this.isUndefined(t[n])&&(t[n]=e[n])}).bind(this))},this),t},compose:function(){var t=At.call(arguments);return function(){for(var e=At.call(arguments),r=t.length-1;r>=0;r--)e=[t[r].apply(this,e)];return e[0]}},each:function(t,e,r){if(t){if(Gs&&t.forEach&&t.forEach===Gs)t.forEach(e,r);else if(t.length===t.length+0){var n=void 0,i=void 0;for(n=0,i=t.length;n<i;n++)if(n in t&&e.call(r,t[n],n)===this.BREAK)return}else for(var s in t)if(e.call(r,t[s],s)===this.BREAK)return}},defer:function(t){setTimeout(t,0)},debounce:function(t,e,r){var n=void 0;return function(){var i=this,s=arguments;function a(){n=null,r||t.apply(i,s)}var o=r||!n;clearTimeout(n),n=setTimeout(a,e),o&&t.apply(i,s)}},toArray:function(t){return t.toArray?t.toArray():At.call(t)},isUndefined:function(t){return t===void 0},isNull:function(t){return t===null},isNaN:function(t){function e(r){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return t===!1||t===!0},isFunction:function(t){return t instanceof Function}},Vf=[{litmus:k.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:ut},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:ut},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:ut},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:ut}}},{litmus:k.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:k.isArray,conversions:{RGB_ARRAY:{read:function(t){return t.length!==3?!1:{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return t.length!==4?!1:{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:k.isObject,conversions:{RGBA_OBJ:{read:function(t){return k.isNumber(t.r)&&k.isNumber(t.g)&&k.isNumber(t.b)&&k.isNumber(t.a)?{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return k.isNumber(t.r)&&k.isNumber(t.g)&&k.isNumber(t.b)?{space:"RGB",r:t.r,g:t.g,b:t.b}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return k.isNumber(t.h)&&k.isNumber(t.s)&&k.isNumber(t.v)&&k.isNumber(t.a)?{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return k.isNumber(t.h)&&k.isNumber(t.s)&&k.isNumber(t.v)?{space:"HSV",h:t.h,s:t.s,v:t.v}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}],Ct=void 0,Zt=void 0,Xr=function(){Zt=!1;var t=arguments.length>1?k.toArray(arguments):arguments[0];return k.each(Vf,function(e){if(e.litmus(t))return k.each(e.conversions,function(r,n){if(Ct=r.read(t),Zt===!1&&Ct!==!1)return Zt=Ct,Ct.conversionName=n,Ct.conversion=r,k.BREAK}),k.BREAK}),Zt},Fs=void 0,er={hsv_to_rgb:function(t,e,r){var n=Math.floor(t/60)%6,i=t/60-Math.floor(t/60),s=r*(1-e),a=r*(1-i*e),o=r*(1-(1-i)*e),u=[[r,o,s],[a,r,s],[s,r,o],[s,a,r],[o,s,r],[r,s,a]][n];return{r:u[0]*255,g:u[1]*255,b:u[2]*255}},rgb_to_hsv:function(t,e,r){var n=Math.min(t,e,r),i=Math.max(t,e,r),s=i-n,a=void 0,o=void 0;if(i!==0)o=s/i;else return{h:NaN,s:0,v:0};return t===i?a=(e-r)/s:e===i?a=2+(r-t)/s:a=4+(t-e)/s,a/=6,a<0&&(a+=1),{h:a*360,s:o,v:i/255}},rgb_to_hex:function(t,e,r){var n=this.hex_with_component(0,2,t);return n=this.hex_with_component(n,1,e),n=this.hex_with_component(n,0,r),n},component_from_hex:function(t,e){return t>>e*8&255},hex_with_component:function(t,e,r){return r<<(Fs=e*8)|t&~(255<<Fs)}},jf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},me=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_e=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),Le=function t(e,r,n){e===null&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,r);if(i===void 0){var s=Object.getPrototypeOf(e);return s===null?void 0:t(s,r,n)}else{if("value"in i)return i.value;var a=i.get;return a===void 0?void 0:a.call(n)}},Ie=function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},ze=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t},ie=function(){function t(){if(me(this,t),this.__state=Xr.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return _e(t,[{key:"toString",value:function(){return ut(this)}},{key:"toHexString",value:function(){return ut(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function Jr(t,e,r){Object.defineProperty(t,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(ie.recalculateRGB(this,e,r),this.__state[e])},set:function(n){this.__state.space!=="RGB"&&(ie.recalculateRGB(this,e,r),this.__state.space="RGB"),this.__state[e]=n}})}function Kr(t,e){Object.defineProperty(t,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(ie.recalculateHSV(this),this.__state[e])},set:function(r){this.__state.space!=="HSV"&&(ie.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=r}})}ie.recalculateRGB=function(t,e,r){if(t.__state.space==="HEX")t.__state[e]=er.component_from_hex(t.__state.hex,r);else if(t.__state.space==="HSV")k.extend(t.__state,er.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v));else throw new Error("Corrupted color state")},ie.recalculateHSV=function(t){var e=er.rgb_to_hsv(t.r,t.g,t.b);k.extend(t.__state,{s:e.s,v:e.v}),k.isNaN(e.h)?k.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h},ie.COMPONENTS=["r","g","b","h","s","v","hex","a"],Jr(ie.prototype,"r",2),Jr(ie.prototype,"g",1),Jr(ie.prototype,"b",0),Kr(ie.prototype,"h"),Kr(ie.prototype,"s"),Kr(ie.prototype,"v"),Object.defineProperty(ie.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(ie.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=er.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}});var Xe=function(){function t(e,r){me(this,t),this.initialValue=e[r],this.domElement=document.createElement("div"),this.object=e,this.property=r,this.__onChange=void 0,this.__onFinishChange=void 0}return _e(t,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),qf={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},Rs={};k.each(qf,function(t,e){k.each(t,function(r){Rs[r]=e})});var $f=/(\d+(\.\d+)?)px/;function we(t){if(t==="0"||k.isUndefined(t))return 0;var e=t.match($f);return k.isNull(e)?0:parseFloat(e[1])}var b={makeSelectable:function(t,e){t===void 0||t.style===void 0||(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(t,e,r){var n=r,i=e;k.isUndefined(i)&&(i=!0),k.isUndefined(n)&&(n=!0),t.style.position="absolute",i&&(t.style.left=0,t.style.right=0),n&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,e,r,n){var i=r||{},s=Rs[e];if(!s)throw new Error("Event type "+e+" not supported.");var a=document.createEvent(s);switch(s){case"MouseEvents":{var o=i.x||i.clientX||0,u=i.y||i.clientY||0;a.initMouseEvent(e,i.bubbles||!1,i.cancelable||!0,window,i.clickCount||1,0,0,o,u,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var c=a.initKeyboardEvent||a.initKeyEvent;k.defaults(i,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),c(e,i.bubbles||!1,i.cancelable,window,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.keyCode,i.charCode);break}default:{a.initEvent(e,i.bubbles||!1,i.cancelable||!0);break}}k.defaults(a,n),t.dispatchEvent(a)},bind:function(t,e,r,n){var i=n||!1;return t.addEventListener?t.addEventListener(e,r,i):t.attachEvent&&t.attachEvent("on"+e,r),b},unbind:function(t,e,r,n){var i=n||!1;return t.removeEventListener?t.removeEventListener(e,r,i):t.detachEvent&&t.detachEvent("on"+e,r),b},addClass:function(t,e){if(t.className===void 0)t.className=e;else if(t.className!==e){var r=t.className.split(/ +/);r.indexOf(e)===-1&&(r.push(e),t.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return b},removeClass:function(t,e){if(e)if(t.className===e)t.removeAttribute("class");else{var r=t.className.split(/ +/),n=r.indexOf(e);n!==-1&&(r.splice(n,1),t.className=r.join(" "))}else t.className=void 0;return b},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var e=getComputedStyle(t);return we(e["border-left-width"])+we(e["border-right-width"])+we(e["padding-left"])+we(e["padding-right"])+we(e.width)},getHeight:function(t){var e=getComputedStyle(t);return we(e["border-top-width"])+we(e["border-bottom-width"])+we(e["padding-top"])+we(e["padding-bottom"])+we(e.height)},getOffset:function(t){var e=t,r={left:0,top:0};if(e.offsetParent)do r.left+=e.offsetLeft,r.top+=e.offsetTop,e=e.offsetParent;while(e);return r},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}},Ds=function(t){Ie(e,t);function e(r,n){me(this,e);var i=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n)),s=i;i.__prev=i.getValue(),i.__checkbox=document.createElement("input"),i.__checkbox.setAttribute("type","checkbox");function a(){s.setValue(!s.__prev)}return b.bind(i.__checkbox,"change",a,!1),i.domElement.appendChild(i.__checkbox),i.updateDisplay(),i}return _e(e,[{key:"setValue",value:function(r){var n=Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),n}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Xe),Hf=function(t){Ie(e,t);function e(r,n,i){me(this,e);var s=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n)),a=i,o=s;if(s.__select=document.createElement("select"),k.isArray(a)){var u={};k.each(a,function(c){u[c]=c}),a=u}return k.each(a,function(c,l){var d=document.createElement("option");d.innerHTML=l,d.setAttribute("value",c),o.__select.appendChild(d)}),s.updateDisplay(),b.bind(s.__select,"change",function(){var c=this.options[this.selectedIndex].value;o.setValue(c)}),s.domElement.appendChild(s.__select),s}return _e(e,[{key:"setValue",value:function(r){var n=Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),n}},{key:"updateDisplay",value:function(){return b.isActive(this.__select)?this:(this.__select.value=this.getValue(),Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(Xe),Yf=function(t){Ie(e,t);function e(r,n){me(this,e);var i=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n)),s=i;function a(){s.setValue(s.__input.value)}function o(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),b.bind(i.__input,"keyup",a),b.bind(i.__input,"change",a),b.bind(i.__input,"blur",o),b.bind(i.__input,"keydown",function(u){u.keyCode===13&&this.blur()}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return _e(e,[{key:"updateDisplay",value:function(){return b.isActive(this.__input)||(this.__input.value=this.getValue()),Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Xe);function Vs(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var js=function(t){Ie(e,t);function e(r,n,i){me(this,e);var s=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n)),a=i||{};return s.__min=a.min,s.__max=a.max,s.__step=a.step,k.isUndefined(s.__step)?s.initialValue===0?s.__impliedStep=1:s.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(s.initialValue))/Math.LN10))/10:s.__impliedStep=s.__step,s.__precision=Vs(s.__impliedStep),s}return _e(e,[{key:"setValue",value:function(r){var n=r;return this.__min!==void 0&&n<this.__min?n=this.__min:this.__max!==void 0&&n>this.__max&&(n=this.__max),this.__step!==void 0&&n%this.__step!==0&&(n=Math.round(n/this.__step)*this.__step),Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,n)}},{key:"min",value:function(r){return this.__min=r,this}},{key:"max",value:function(r){return this.__max=r,this}},{key:"step",value:function(r){return this.__step=r,this.__impliedStep=r,this.__precision=Vs(r),this}}]),e}(Xe);function Wf(t,e){var r=Math.pow(10,e);return Math.round(t*r)/r}var tr=function(t){Ie(e,t);function e(r,n,i){me(this,e);var s=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n,i));s.__truncationSuspended=!1;var a=s,o=void 0;function u(){var y=parseFloat(a.__input.value);k.isNaN(y)||a.setValue(y)}function c(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function l(){c()}function d(y){var v=o-y.clientY;a.setValue(a.getValue()+v*a.__impliedStep),o=y.clientY}function p(){b.unbind(window,"mousemove",d),b.unbind(window,"mouseup",p),c()}function f(y){b.bind(window,"mousemove",d),b.bind(window,"mouseup",p),o=y.clientY}return s.__input=document.createElement("input"),s.__input.setAttribute("type","text"),b.bind(s.__input,"change",u),b.bind(s.__input,"blur",l),b.bind(s.__input,"mousedown",f),b.bind(s.__input,"keydown",function(y){y.keyCode===13&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,c())}),s.updateDisplay(),s.domElement.appendChild(s.__input),s}return _e(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():Wf(this.getValue(),this.__precision),Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(js);function qs(t,e,r,n,i){return n+(i-n)*((t-e)/(r-e))}var Qr=function(t){Ie(e,t);function e(r,n,i,s,a){me(this,e);var o=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n,{min:i,max:s,step:a})),u=o;o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),b.bind(o.__background,"mousedown",c),b.bind(o.__background,"touchstart",p),b.addClass(o.__background,"slider"),b.addClass(o.__foreground,"slider-fg");function c(v){document.activeElement.blur(),b.bind(window,"mousemove",l),b.bind(window,"mouseup",d),l(v)}function l(v){v.preventDefault();var g=u.__background.getBoundingClientRect();return u.setValue(qs(v.clientX,g.left,g.right,u.__min,u.__max)),!1}function d(){b.unbind(window,"mousemove",l),b.unbind(window,"mouseup",d),u.__onFinishChange&&u.__onFinishChange.call(u,u.getValue())}function p(v){v.touches.length===1&&(b.bind(window,"touchmove",f),b.bind(window,"touchend",y),f(v))}function f(v){var g=v.touches[0].clientX,S=u.__background.getBoundingClientRect();u.setValue(qs(g,S.left,S.right,u.__min,u.__max))}function y(){b.unbind(window,"touchmove",f),b.unbind(window,"touchend",y),u.__onFinishChange&&u.__onFinishChange.call(u,u.getValue())}return o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return _e(e,[{key:"updateDisplay",value:function(){var r=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=r*100+"%",Le(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(js),$s=function(t){Ie(e,t);function e(r,n,i){me(this,e);var s=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n)),a=s;return s.__button=document.createElement("div"),s.__button.innerHTML=i===void 0?"Fire":i,b.bind(s.__button,"click",function(o){return o.preventDefault(),a.fire(),!1}),b.addClass(s.__button,"button"),s.domElement.appendChild(s.__button),s}return _e(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(Xe),Zr=function(t){Ie(e,t);function e(r,n){me(this,e);var i=ze(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,n));i.__color=new ie(i.getValue()),i.__temp=new ie(0);var s=i;i.domElement=document.createElement("div"),b.makeSelectable(i.domElement,!1),i.__selector=document.createElement("div"),i.__selector.className="selector",i.__saturation_field=document.createElement("div"),i.__saturation_field.className="saturation-field",i.__field_knob=document.createElement("div"),i.__field_knob.className="field-knob",i.__field_knob_border="2px solid ",i.__hue_knob=document.createElement("div"),i.__hue_knob.className="hue-knob",i.__hue_field=document.createElement("div"),i.__hue_field.className="hue-field",i.__input=document.createElement("input"),i.__input.type="text",i.__input_textShadow="0 1px 1px ",b.bind(i.__input,"keydown",function(v){v.keyCode===13&&d.call(this)}),b.bind(i.__input,"blur",d),b.bind(i.__selector,"mousedown",function(){b.addClass(this,"drag").bind(window,"mouseup",function(){b.removeClass(s.__selector,"drag")})}),b.bind(i.__selector,"touchstart",function(){b.addClass(this,"drag").bind(window,"touchend",function(){b.removeClass(s.__selector,"drag")})});var a=document.createElement("div");k.extend(i.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),k.extend(i.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:i.__field_knob_border+(i.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),k.extend(i.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),k.extend(i.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),k.extend(a.style,{width:"100%",height:"100%",background:"none"}),Hs(a,"top","rgba(0,0,0,0)","#000"),k.extend(i.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),Jf(i.__hue_field),k.extend(i.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:i.__input_textShadow+"rgba(0,0,0,0.7)"}),b.bind(i.__saturation_field,"mousedown",o),b.bind(i.__saturation_field,"touchstart",o),b.bind(i.__field_knob,"mousedown",o),b.bind(i.__field_knob,"touchstart",o),b.bind(i.__hue_field,"mousedown",u),b.bind(i.__hue_field,"touchstart",u);function o(v){f(v),b.bind(window,"mousemove",f),b.bind(window,"touchmove",f),b.bind(window,"mouseup",c),b.bind(window,"touchend",c)}function u(v){y(v),b.bind(window,"mousemove",y),b.bind(window,"touchmove",y),b.bind(window,"mouseup",l),b.bind(window,"touchend",l)}function c(){b.unbind(window,"mousemove",f),b.unbind(window,"touchmove",f),b.unbind(window,"mouseup",c),b.unbind(window,"touchend",c),p()}function l(){b.unbind(window,"mousemove",y),b.unbind(window,"touchmove",y),b.unbind(window,"mouseup",l),b.unbind(window,"touchend",l),p()}function d(){var v=Xr(this.value);v!==!1?(s.__color.__state=v,s.setValue(s.__color.toOriginal())):this.value=s.__color.toString()}function p(){s.__onFinishChange&&s.__onFinishChange.call(s,s.__color.toOriginal())}i.__saturation_field.appendChild(a),i.__selector.appendChild(i.__field_knob),i.__selector.appendChild(i.__saturation_field),i.__selector.appendChild(i.__hue_field),i.__hue_field.appendChild(i.__hue_knob),i.domElement.appendChild(i.__input),i.domElement.appendChild(i.__selector),i.updateDisplay();function f(v){v.type.indexOf("touch")===-1&&v.preventDefault();var g=s.__saturation_field.getBoundingClientRect(),S=v.touches&&v.touches[0]||v,T=S.clientX,E=S.clientY,M=(T-g.left)/(g.right-g.left),A=1-(E-g.top)/(g.bottom-g.top);return A>1?A=1:A<0&&(A=0),M>1?M=1:M<0&&(M=0),s.__color.v=A,s.__color.s=M,s.setValue(s.__color.toOriginal()),!1}function y(v){v.type.indexOf("touch")===-1&&v.preventDefault();var g=s.__hue_field.getBoundingClientRect(),S=v.touches&&v.touches[0]||v,T=S.clientY,E=1-(T-g.top)/(g.bottom-g.top);return E>1?E=1:E<0&&(E=0),s.__color.h=E*360,s.setValue(s.__color.toOriginal()),!1}return i}return _e(e,[{key:"updateDisplay",value:function(){var r=Xr(this.getValue());if(r!==!1){var n=!1;k.each(ie.COMPONENTS,function(a){if(!k.isUndefined(r[a])&&!k.isUndefined(this.__color.__state[a])&&r[a]!==this.__color.__state[a])return n=!0,{}},this),n&&k.extend(this.__color.__state,r)}k.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,s=255-i;k.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,Hs(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),k.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+s+","+s+","+s+",.7)"})}}]),e}(Xe),Xf=["-moz-","-o-","-webkit-","-ms-",""];function Hs(t,e,r,n){t.style.background="",k.each(Xf,function(i){t.style.cssText+="background: "+i+"linear-gradient("+e+", "+r+" 0%, "+n+" 100%); "})}function Jf(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Kf={load:function(t,e){var r=e||document,n=r.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=t,r.getElementsByTagName("head")[0].appendChild(n)},inject:function(t,e){var r=e||document,n=document.createElement("style");n.type="text/css",n.innerHTML=t;var i=r.getElementsByTagName("head")[0];try{i.appendChild(n)}catch{}}},Qf=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Zf=function(t,e){var r=t[e];return k.isArray(arguments[2])||k.isObject(arguments[2])?new Hf(t,e,arguments[2]):k.isNumber(r)?k.isNumber(arguments[2])&&k.isNumber(arguments[3])?k.isNumber(arguments[4])?new Qr(t,e,arguments[2],arguments[3],arguments[4]):new Qr(t,e,arguments[2],arguments[3]):k.isNumber(arguments[4])?new tr(t,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new tr(t,e,{min:arguments[2],max:arguments[3]}):k.isString(r)?new Yf(t,e):k.isFunction(r)?new $s(t,e,""):k.isBoolean(r)?new Ds(t,e):null};function em(t){setTimeout(t,1e3/60)}var tm=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||em,rm=function(){function t(){me(this,t),this.backgroundElement=document.createElement("div"),k.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),b.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),k.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;b.bind(this.backgroundElement,"click",function(){e.hide()})}return _e(t,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),k.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,r=function n(){e.domElement.style.display="none",e.backgroundElement.style.display="none",b.unbind(e.domElement,"webkitTransitionEnd",n),b.unbind(e.domElement,"transitionend",n),b.unbind(e.domElement,"oTransitionEnd",n)};b.bind(this.domElement,"webkitTransitionEnd",r),b.bind(this.domElement,"transitionend",r),b.bind(this.domElement,"oTransitionEnd",r),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-b.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-b.getHeight(this.domElement)/2+"px"}}]),t}(),nm=Df(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Kf.inject(nm);var Ys="dg",Ws=72,Xs=20,Pt="Default",Ot=function(){try{return!!window.localStorage}catch{return!1}}(),Bt=void 0,Js=!0,ct=void 0,en=!1,Ks=[],$=function t(e){var r=this,n=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),b.addClass(this.domElement,Ys),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],n=k.defaults(n,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),n=k.defaults(n,{resizable:n.autoPlace,hideable:n.autoPlace}),k.isUndefined(n.load)?n.load={preset:Pt}:n.preset&&(n.load.preset=n.preset),k.isUndefined(n.parent)&&n.hideable&&Ks.push(this),n.resizable=k.isUndefined(n.parent)&&n.resizable,n.autoPlace&&k.isUndefined(n.scrollable)&&(n.scrollable=!0);var i=Ot&&localStorage.getItem(lt(this,"isLocal"))==="true",s=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return n.parent}},scrollable:{get:function(){return n.scrollable}},autoPlace:{get:function(){return n.autoPlace}},closeOnTop:{get:function(){return n.closeOnTop}},preset:{get:function(){return r.parent?r.getRoot().preset:n.load.preset},set:function(d){r.parent?r.getRoot().preset=d:n.load.preset=d,om(this),r.revert()}},width:{get:function(){return n.width},set:function(d){n.width=d,sn(r,d)}},name:{get:function(){return n.name},set:function(d){n.name=d,a&&(a.innerHTML=n.name)}},closed:{get:function(){return n.closed},set:function(d){n.closed=d,n.closed?b.addClass(r.__ul,t.CLASS_CLOSED):b.removeClass(r.__ul,t.CLASS_CLOSED),this.onResize(),r.__closeButton&&(r.__closeButton.innerHTML=d?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return n.load}},useLocalStorage:{get:function(){return i},set:function(d){Ot&&(i=d,d?b.bind(window,"unload",s):b.unbind(window,"unload",s),localStorage.setItem(lt(r,"isLocal"),d))}}}),k.isUndefined(n.parent)){if(this.closed=n.closed||!1,b.addClass(this.domElement,t.CLASS_MAIN),b.makeSelectable(this.domElement,!1),Ot&&i){r.useLocalStorage=!0;var o=localStorage.getItem(lt(this,"gui"));o&&(n.load=JSON.parse(o))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,b.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),n.closeOnTop?(b.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(b.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),b.bind(this.__closeButton,"click",function(){r.closed=!r.closed})}else{n.closed===void 0&&(n.closed=!0);var u=document.createTextNode(n.name);b.addClass(u,"controller-name"),a=tn(r,u);var c=function(d){return d.preventDefault(),r.closed=!r.closed,!1};b.addClass(this.__ul,t.CLASS_CLOSED),b.addClass(a,"title"),b.bind(a,"click",c),n.closed||(this.closed=!1)}n.autoPlace&&(k.isUndefined(n.parent)&&(Js&&(ct=document.createElement("div"),b.addClass(ct,Ys),b.addClass(ct,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(ct),Js=!1),ct.appendChild(this.domElement),b.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||sn(r,n.width)),this.__resizeHandler=function(){r.onResizeDebounced()},b.bind(window,"resize",this.__resizeHandler),b.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),b.bind(this.__ul,"transitionend",this.__resizeHandler),b.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),n.resizable&&am(this),s=function(){Ot&&localStorage.getItem(lt(r,"isLocal"))==="true"&&localStorage.setItem(lt(r,"gui"),JSON.stringify(r.getSaveObject()))},this.saveToLocalStorageIfPossible=s;function l(){var d=r.getRoot();d.width+=1,k.defer(function(){d.width-=1})}n.parent||l()};$.toggleHide=function(){en=!en,k.each(Ks,function(t){t.domElement.style.display=en?"none":""})},$.CLASS_AUTO_PLACE="a",$.CLASS_AUTO_PLACE_CONTAINER="ac",$.CLASS_MAIN="main",$.CLASS_CONTROLLER_ROW="cr",$.CLASS_TOO_TALL="taller-than-window",$.CLASS_CLOSED="closed",$.CLASS_CLOSE_BUTTON="close-button",$.CLASS_CLOSE_TOP="close-top",$.CLASS_CLOSE_BOTTOM="close-bottom",$.CLASS_DRAG="drag",$.DEFAULT_WIDTH=245,$.TEXT_CLOSED="Close Controls",$.TEXT_OPEN="Open Controls",$._keydownHandler=function(t){document.activeElement.type!=="text"&&(t.which===Ws||t.keyCode===Ws)&&$.toggleHide()},b.bind(window,"keydown",$._keydownHandler,!1),k.extend($.prototype,{add:function(t,e){return Nt(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return Nt(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.splice(this.__controllers.indexOf(t),1);var e=this;k.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&ct.removeChild(this.domElement);var t=this;k.each(this.__folders,function(e){t.removeFolder(e)}),b.unbind(window,"keydown",$._keydownHandler,!1),Qs(this)},addFolder:function(t){if(this.__folders[t]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var r=new $(e);this.__folders[t]=r;var n=tn(this,r.domElement);return b.addClass(n,"folder"),r},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],Qs(t);var e=this;k.each(t.__folders,function(r){t.removeFolder(r)}),k.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=b.getOffset(t.__ul).top,r=0;k.each(t.__ul.childNodes,function(n){t.autoPlace&&n===t.__save_row||(r+=b.getHeight(n))}),window.innerHeight-e-Xs<r?(b.addClass(t.domElement,$.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-Xs+"px"):(b.removeClass(t.domElement,$.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&k.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:k.debounce(function(){this.onResize()},50),remember:function(){if(k.isUndefined(Bt)&&(Bt=new rm,Bt.domElement.innerHTML=Qf),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;k.each(Array.prototype.slice.call(arguments),function(e){t.__rememberedObjects.length===0&&sm(t),t.__rememberedObjects.indexOf(e)===-1&&t.__rememberedObjects.push(e)}),this.autoPlace&&sn(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=rr(this)),t.folders={},k.each(this.__folders,function(e,r){t.folders[r]=e.getSaveObject()}),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=rr(this),rn(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered[Pt]=rr(this,!0)),this.load.remembered[t]=rr(this),this.preset=t,nn(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){k.each(this.__controllers,function(e){this.getRoot().load.remembered?Zs(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),k.each(this.__folders,function(e){e.revert(e)}),t||rn(this.getRoot(),!1)},listen:function(t){var e=this.__listening.length===0;this.__listening.push(t),e&&ta(this.__listening)},updateDisplay:function(){k.each(this.__controllers,function(t){t.updateDisplay()}),k.each(this.__folders,function(t){t.updateDisplay()})}});function tn(t,e,r){var n=document.createElement("li");return e&&n.appendChild(e),r?t.__ul.insertBefore(n,r):t.__ul.appendChild(n),t.onResize(),n}function Qs(t){b.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&b.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function rn(t,e){var r=t.__preset_select[t.__preset_select.selectedIndex];e?r.innerHTML=r.value+"*":r.innerHTML=r.value}function im(t,e,r){if(r.__li=e,r.__gui=t,k.extend(r,{options:function(s){if(arguments.length>1){var a=r.__li.nextElementSibling;return r.remove(),Nt(t,r.object,r.property,{before:a,factoryArgs:[k.toArray(arguments)]})}if(k.isArray(s)||k.isObject(s)){var o=r.__li.nextElementSibling;return r.remove(),Nt(t,r.object,r.property,{before:o,factoryArgs:[s]})}},name:function(s){return r.__li.firstElementChild.firstElementChild.innerHTML=s,r},listen:function(){return r.__gui.listen(r),r},remove:function(){return r.__gui.remove(r),r}}),r instanceof Qr){var n=new tr(r.object,r.property,{min:r.__min,max:r.__max,step:r.__step});k.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(s){var a=r[s],o=n[s];r[s]=n[s]=function(){var u=Array.prototype.slice.call(arguments);return o.apply(n,u),a.apply(r,u)}}),b.addClass(e,"has-slider"),r.domElement.insertBefore(n.domElement,r.domElement.firstElementChild)}else if(r instanceof tr){var i=function(s){if(k.isNumber(r.__min)&&k.isNumber(r.__max)){var a=r.__li.firstElementChild.firstElementChild.innerHTML,o=r.__gui.__listening.indexOf(r)>-1;r.remove();var u=Nt(t,r.object,r.property,{before:r.__li.nextElementSibling,factoryArgs:[r.__min,r.__max,r.__step]});return u.name(a),o&&u.listen(),u}return s};r.min=k.compose(i,r.min),r.max=k.compose(i,r.max)}else r instanceof Ds?(b.bind(e,"click",function(){b.fakeEvent(r.__checkbox,"click")}),b.bind(r.__checkbox,"click",function(s){s.stopPropagation()})):r instanceof $s?(b.bind(e,"click",function(){b.fakeEvent(r.__button,"click")}),b.bind(e,"mouseover",function(){b.addClass(r.__button,"hover")}),b.bind(e,"mouseout",function(){b.removeClass(r.__button,"hover")})):r instanceof Zr&&(b.addClass(e,"color"),r.updateDisplay=k.compose(function(s){return e.style.borderLeftColor=r.__color.toString(),s},r.updateDisplay),r.updateDisplay());r.setValue=k.compose(function(s){return t.getRoot().__preset_select&&r.isModified()&&rn(t.getRoot(),!0),s},r.setValue)}function Zs(t,e){var r=t.getRoot(),n=r.__rememberedObjects.indexOf(e.object);if(n!==-1){var i=r.__rememberedObjectIndecesToControllers[n];if(i===void 0&&(i={},r.__rememberedObjectIndecesToControllers[n]=i),i[e.property]=e,r.load&&r.load.remembered){var s=r.load.remembered,a=void 0;if(s[t.preset])a=s[t.preset];else if(s[Pt])a=s[Pt];else return;if(a[n]&&a[n][e.property]!==void 0){var o=a[n][e.property];e.initialValue=o,e.setValue(o)}}}}function Nt(t,e,r,n){if(e[r]===void 0)throw new Error('Object "'+e+'" has no property "'+r+'"');var i=void 0;if(n.color)i=new Zr(e,r);else{var s=[e,r].concat(n.factoryArgs);i=Zf.apply(t,s)}n.before instanceof Xe&&(n.before=n.before.__li),Zs(t,i),b.addClass(i.domElement,"c");var a=document.createElement("span");b.addClass(a,"property-name"),a.innerHTML=i.property;var o=document.createElement("div");o.appendChild(a),o.appendChild(i.domElement);var u=tn(t,o,n.before);return b.addClass(u,$.CLASS_CONTROLLER_ROW),i instanceof Zr?b.addClass(u,"color"):b.addClass(u,jf(i.getValue())),im(t,u,i),t.__controllers.push(i),i}function lt(t,e){return document.location.href+"."+e}function nn(t,e,r){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.__preset_select.appendChild(n),r&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function ea(t,e){e.style.display=t.useLocalStorage?"block":"none"}function sm(t){var e=t.__save_row=document.createElement("li");b.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),b.addClass(e,"save-row");var r=document.createElement("span");r.innerHTML="&nbsp;",b.addClass(r,"button gears");var n=document.createElement("span");n.innerHTML="Save",b.addClass(n,"button"),b.addClass(n,"save");var i=document.createElement("span");i.innerHTML="New",b.addClass(i,"button"),b.addClass(i,"save-as");var s=document.createElement("span");s.innerHTML="Revert",b.addClass(s,"button"),b.addClass(s,"revert");var a=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?k.each(t.load.remembered,function(d,p){nn(t,p,p===t.preset)}):nn(t,Pt,!1),b.bind(a,"change",function(){for(var d=0;d<t.__preset_select.length;d++)t.__preset_select[d].innerHTML=t.__preset_select[d].value;t.preset=this.value}),e.appendChild(a),e.appendChild(r),e.appendChild(n),e.appendChild(i),e.appendChild(s),Ot){var o=document.getElementById("dg-local-explain"),u=document.getElementById("dg-local-storage"),c=document.getElementById("dg-save-locally");c.style.display="block",localStorage.getItem(lt(t,"isLocal"))==="true"&&u.setAttribute("checked","checked"),ea(t,o),b.bind(u,"change",function(){t.useLocalStorage=!t.useLocalStorage,ea(t,o)})}var l=document.getElementById("dg-new-constructor");b.bind(l,"keydown",function(d){d.metaKey&&(d.which===67||d.keyCode===67)&&Bt.hide()}),b.bind(r,"click",function(){l.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),Bt.show(),l.focus(),l.select()}),b.bind(n,"click",function(){t.save()}),b.bind(i,"click",function(){var d=prompt("Enter a new preset name.");d&&t.saveAs(d)}),b.bind(s,"click",function(){t.revert()})}function am(t){var e=void 0;t.__resize_handle=document.createElement("div"),k.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function r(s){return s.preventDefault(),t.width+=e-s.clientX,t.onResize(),e=s.clientX,!1}function n(){b.removeClass(t.__closeButton,$.CLASS_DRAG),b.unbind(window,"mousemove",r),b.unbind(window,"mouseup",n)}function i(s){return s.preventDefault(),e=s.clientX,b.addClass(t.__closeButton,$.CLASS_DRAG),b.bind(window,"mousemove",r),b.bind(window,"mouseup",n),!1}b.bind(t.__resize_handle,"mousedown",i),b.bind(t.__closeButton,"mousedown",i),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function sn(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function rr(t,e){var r={};return k.each(t.__rememberedObjects,function(n,i){var s={},a=t.__rememberedObjectIndecesToControllers[i];k.each(a,function(o,u){s[u]=e?o.initialValue:o.getValue()}),r[i]=s}),r}function om(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}function ta(t){t.length!==0&&tm.call(window,function(){ta(t)}),k.each(t,function(e){e.updateDisplay()})}var um=$;const le=class le{getBufferView(){return{dir:this.dir??Z.zero(),pos:this.pos??Z.zero(),color:this.color,flux:this.flux,ltype:this.type}}};w(le,"defs"),w(le,"view"),w(le,"getViewSize"),w(le,"elementByteSize"),(()=>{try{le.defs=Ht(vi),le.elementByteSize=wl(le.defs.storages[et]).size,le.getViewSize=e=>le.defs.storages[et].size+e*le.elementByteSize,le.view=e=>vt(le.defs.storages[et],new ArrayBuffer(le.getViewSize(e)))}catch{}})();let Je=le;class cm extends Je{constructor(r,n,i){super();w(this,"type",1);this.dir=r,this.color=n,this.flux=i}}class lm extends Je{constructor(r,n,i){super();w(this,"type",2);this.pos=r,this.color=n,this.flux=i}}async function dm(t,e){const r=navigator.gpu;if(!r)throw new Error("Web GPU not available");const n=await r.requestAdapter(t);if(!n)throw new Error("Can not request Web GPU Adapter");e!=null&&e.requiredFeatures&&(e.requiredFeatures=e.requiredFeatures.filter(s=>n.features.has(s)));const i=await n.requestDevice(e);if(!i)throw new Error("Can not request Web GPU Device");return{gpu:r,adapter:n,device:i,format:r.getPreferredCanvasFormat()}}function an(t,e,r,n,i){var g;const s=typeof t=="object"&&typeof e=="object";if(!s&&!(typeof t!="object"&&typeof e!="object"))throw new Error("");const a=document.createElement("canvas");a.id="webgpu-canvas",n&&(a.className=n);const{scale:o=!0,virtual:u=!1}=r||{},c=s?t.width:t,l=s?t.height:e;if(a.style.width=typeof c=="number"?`${c}px`:c,a.style.height=typeof l=="number"?`${l}px`:l,u){if(typeof c!="number"||typeof l!="number")throw new Error("virtual canvas width and height must be number")}else(g=i?document.getElementById(i):document.body)==null||g.appendChild(a);const d=u?c:a.clientWidth,p=u?l:a.clientHeight,f=s?e.width:d,y=s?e.height:p;a.width=f*(o?window.devicePixelRatio:1),a.height=y*(o?window.devicePixelRatio:1);const v=a.getContext("webgpu");if(!v)throw new Error("webgpu context for canvas not available");return r&&v.configure(r),{canvas:a,ctx:v,width:d,height:p,aspect:d/p}}function ra(t,e,r){return e.createComputePipeline({layout:"auto",compute:{module:e.createShaderModule({code:t}),entryPoint:"main",...r==null?void 0:r.compute},...r})}function na(t,e,r,n,i,s){return r.createRenderPipeline({vertex:{module:r.createShaderModule({code:t}),entryPoint:"main",buffers:i},fragment:{module:r.createShaderModule({code:e}),entryPoint:"main",targets:[{format:n}]},primitive:{topology:"triangle-list",...s==null?void 0:s.primitive},layout:"auto",...s})}const ia=(t=!1)=>`
  struct VaryStruct {
    @builtin(position) position: vec4f,
    @location(0) tc: vec2f,
    @location(1) pos: vec4f,
  }

  @vertex
  fn main(@builtin(vertex_index) vertexIndex: u32) -> VaryStruct {
    let pos = array<vec2f, 3>(
      vec2f(-1., -1.),
      vec2f(-1., 3.),
      vec2f(3., -1.),
    );

    var o: VaryStruct;
    o.position = vec4f(pos[vertexIndex], 1.0, 1.0); 
    o.tc = pos[vertexIndex] * vec2f(0.5, ${t?-.5:.5}) + 0.5;
    o.pos = o.position;
    return o;
  }
`,hm=t=>`
@group(0) @binding(0) var _sampler: sampler;
@group(0) @binding(1) var texture: texture_2d<f32>;

@fragment
fn main(@location(0) uv: vec2f) -> @location(0) vec4f {
  return textureSampleLevel(texture, _sampler, uv, f32(${t}));
}
`;function sa(t,e,r,n){return t.createTexture({label:(n==null?void 0:n.label)??"",mipLevelCount:(n==null?void 0:n.mipLevelCount)??1,usage:((n==null?void 0:n.usage)??0)|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC,format:e,size:r,dimension:"2d"})}const pm={rgba8unorm:{renderable:!0,multisample:!0,storage:!0,sampleType:"float"},"rgba8unorm-srgb":{renderable:!0,multisample:!0,storage:!1,sampleType:"float"},rgba8snorm:{renderable:!1,multisample:!1,storage:!1,sampleType:"float"},rgba8uint:{renderable:!0,multisample:!0,storage:!0,sampleType:"uint"},rgba8sint:{renderable:!0,multisample:!0,storage:!0,sampleType:"sint"},bgra8unorm:{renderable:!0,multisample:!0,storage:!1,sampleType:"float"},"bgra8unorm-srgb":{renderable:!0,multisample:!0,storage:!1,sampleType:"float"},rgba16uint:{renderable:!0,multisample:!0,storage:!0,sampleType:"uint"},rgba16sint:{renderable:!0,multisample:!0,storage:!0,sampleType:"sint"},rgba16float:{renderable:!0,multisample:!0,storage:!0,sampleType:"float"},rgba32uint:{renderable:!0,multisample:!1,storage:!0,sampleType:"uint"},rgba32sint:{renderable:!0,multisample:!1,storage:!0,sampleType:"sint"},rgba32float:{renderable:!0,multisample:!1,storage:!0,sampleType:"unfilterable-float"}},aa=["rgba8unorm","bgra8unorm"];class fm{constructor(e,r){w(this,"bindGroupLayoutCache",new Map);w(this,"samplerCache",new Map);w(this,"renderPipelineCache",new Map);this.device=e,this.encoder=r}getFromCache(e,r,n){const i=JSON.stringify(r);return e.has(i)?e.get(i):n.apply(this,[r])}createBindGroupLayout(e){const r=JSON.stringify(e),n=this.device.createBindGroupLayout({entries:e});return this.bindGroupLayoutCache.set(r,n),n}createSampler(e){const r=JSON.stringify(e??{}),n=this.device.createSampler(e);return this.samplerCache.set(r,n),n}createRenderPipeline(e,r){const n=JSON.stringify(e),{vertex:i,fragment:s,format:a}=e,o=na(i,s,this.device,a,[null],{layout:r});return this.renderPipelineCache.set(n,o),o}render(e,r,n,i){var d;const{className:s,parentID:a,flipY:o=!1}=i??{},u=[e.width,e.height];let c=e.format,l;if(c in aa){l=(i==null?void 0:i.canvasReturn)??an({width:(n==null?void 0:n.width)??u[0],height:(n==null?void 0:n.height)??u[1]},{width:u[0],height:u[1]},{format:c,scale:!1,device:this.device,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST},s,a);const{ctx:p}=l;this.encoder.copyTextureToTexture({texture:e},{texture:p.getCurrentTexture()},u)}else{const p=aa[0],f=((d=pm[c])==null?void 0:d.sampleType)??"float",y=f.includes("unfilterable")?"non-filtering":"filtering";l=(i==null?void 0:i.canvasReturn)??an({width:(n==null?void 0:n.width)??u[0],height:(n==null?void 0:n.height)??u[1]},{width:u[0],height:u[1]},{format:p,scale:!1,device:this.device},s,a);const{ctx:v}=l,g=[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:y}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:f}}],S=this.getFromCache(this.bindGroupLayoutCache,g,this.createBindGroupLayout),T=this.getFromCache(this.samplerCache,{},this.createSampler),E=this.device.createBindGroup({layout:S,entries:[{binding:0,resource:T},{binding:1,resource:e.createView(r??{})}]}),M=this.device.createPipelineLayout({bindGroupLayouts:[S]}),A=ia(o),L=hm(0),P=this.getFromCache(this.renderPipelineCache,{vertex:A,fragment:L,format:p,entries:g},D=>this.createRenderPipeline(D,M)),B=this.encoder.beginRenderPass({colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store",view:v.getCurrentTexture().createView()}]});B.setPipeline(P),B.setBindGroup(0,E),B.draw(3),B.end()}return l}}function mm(t){const e={data:t,offset:0};return{header:oa(e),stream:e}}function _m(t,e){let r,n;return t instanceof DataView?(r={data:t,offset:0},n=oa(r)):(r=t.stream,n=t.header),{width:n.width,height:n.height,exposure:n.exposure,gamma:n.gamma,data:gm(r,n,e)}}function oa(t){let e=on(t);const r={colorCorr:[1,1,1],exposure:1,gamma:1,width:0,height:0,flipX:!1,flipY:!1};if(e!=="#?RADIANCE"&&e!=="#?RGBE")throw new Error("Incorrect file format!");for(;e!=="";){e=on(t);const i=e.split("=");switch(i[0]){case"GAMMA":r.gamma=parseFloat(i[1]);break;case"FORMAT":if(i[1]!=="32-bit_rle_rgbe"&&i[1]!=="32-bit_rle_xyze")throw new Error("Incorrect encoding format!");break;case"EXPOSURE":r.exposure=parseFloat(i[1]);break;case"COLORCORR":r.colorCorr=i[1].replace(/^\s+|\s+$/g,"").split(" ").map(s=>parseFloat(s));break}}e=on(t);const n=e.split(" ");return ua(n[0],parseInt(n[1]),r),ua(n[2],parseInt(n[3]),r),r}function ua(t,e,r){switch(t){case"+X":r.width=e;break;case"-X":r.width=e,r.flipX=!0,console.warn("Flipping horizontal orientation not currently supported");break;case"-Y":r.height=e;break;case"+Y":r.height=e,r.flipY=!0;break}}function on(t){let e,r="";for(;(e=t.data.getUint8(t.offset++))!==10;)r+=String.fromCharCode(e);return r}function gm(t,e,r){let n=t.data.getUint16(t.offset),i;if(n===514){const s=r!=null&&r.alpha?4:3;i=vm(t,e,s,r),e.flipX&&i&&un(i,e,s),e.flipY&&i&&nr(i,e,s)}else throw new Error("Obsolete HDR file version!");return i}function vm(t,e,r=3,n){const{alpha:i=!1,useReturn:s=!0,onPixel:a}=n??{},{width:o,height:u,colorCorr:c}=e,l=s?new Float32Array(o*u*r):null;let d=0,{offset:p,data:f}=t;for(let y=0;y<u;++y){if(f.getUint16(p)!==514)throw new Error("Incorrect scanline start hash");if(f.getUint16(p+2)!==o)throw new Error("Scanline doesn't match picture dimension!");p+=4;const v=o*4,g=[];let S=0;for(;S<v;){let T=f.getUint8(p++);if(T>128){const E=T-128;T=f.getUint8(p++);for(let M=0;M<E;++M)g[S++]=T}else for(let E=0;E<T;++E)g[S++]=f.getUint8(p++)}for(S=0;S<o;++S){let T=g[S],E=g[S+o],M=g[S+o*2],A=g[S+o*3];A=A?Math.pow(2,A-136):0,T*=A*c[0],E*=A*c[1],M*=A*c[2],a&&a(T,E,M),s?(l[d++]=T,l[d++]=E,l[d++]=M,i&&(l[d++]=1)):d+=r}}return l}function ca(t,e,r,n=3){e*=n,r*=n;for(let i=0;i<n;++i){const s=t[e+i];t[e+i]=t[r+i],t[r+i]=s}}function un(t,e,r=3){const{width:n,height:i}=e,s=n>>1;for(let a=0;a<i;++a){const o=a*n;for(let u=0;u<s;++u){const c=o+u,l=o+n-1-u;ca(t,c,l,r)}}}function nr(t,e,r=3){const{width:n,height:i}=e,s=i>>1;for(let a=0;a<s;++a){const o=a*n,u=(i-1-a)*n;for(let c=0;c<n;++c)ca(t,o+c,u+c,r)}}class ym{async load(e,r){const{onProgress:n,sRGB:i=!0,exposure:s=1,returnGray:a=!1,returnRowAvgGray:o=!1,uint8:u=!1}=r||{},c=await(await Wi(e,B=>{n&&n("downloading",.2*B)})).arrayBuffer(),{header:l,stream:d}=mm(new DataView(c)),{width:p,height:f}=l,y=p*f,v=u?new Uint8ClampedArray(y*4):new Float32Array(y*4),g=a?u?new Uint8ClampedArray(y*4):new Float32Array(y*4):null,S=o?u?new Uint8ClampedArray(f*4):new Float32Array(f*4):null,T=i?1/2.2:1,E=u?255:1;let M=0,A=0,L=0,P=0;return _m({header:l,stream:d},{useReturn:!1,alpha:!0,onPixel(B,D,O){B*=s,D*=s,O*=s,v[P]=Math.pow(B,T)*E,v[P+1]=Math.pow(D,T)*E,v[P+2]=Math.pow(O,T)*E,v[P+3]=E;let H=B*.2126+D*.7152+O*.0722;if(M+=H/y,L+=H/p,a&&(g[P]=Math.pow(H,T)*E,g[P+1]=Math.pow(H,T)*E,g[P+2]=Math.pow(H,T)*E,g[P+3]=E),(A+1)%p==0){if(o){const W=4*(parseInt((A+1)/p+"")-1);S[W]=Math.pow(L,T)*E,S[W+1]=Math.pow(L,T)*E,S[W+2]=Math.pow(L,T)*E,S[W+3]=E}L=0}P+=4,A++}}),l.flipX&&(un(v,l,4),a&&un(g,l,4)),l.flipY&&(nr(v,l,4),a&&nr(g,l,4),o&&nr(S,{...l,width:1},4)),{color:u?new Uint8Array(v):v,gray:u&&a?new Uint8Array(g):g,row_avg:u&&o?new Uint8Array(S):S,width:p,height:f,avg_gray:M}}}function la(t){for(var e=0,r=t.length,n=[];e<r;)n.push(e++);return n}function da(t){return Array.isArray(t)}function ha(t,n,r){if(!da(t))return[];var n=da(n)?n:[];function i(a,o,u){for(var c=0;c+2*u-1<o;c+=u*2)s(a,c,c+u-1,c+2*u-1);c+u-1<o-1&&s(a,c,c+u-1,o-1)}function s(a,o,u,c){for(var l=o,d=u+1,p=[],f=[],y=(r+"").toLowerCase()==="desc";l<=u&&d<=c;)!y&&a[l]<=a[d]||y&&a[l]>=a[d]?(p.push(a[l]),f.push(n[l++])):(p.push(a[d]),f.push(n[d++]));for(;l<=u;)p.push(a[l]),f.push(n[l++]);for(;d<=c;)p.push(a[d]),f.push(n[d++]);var v=p.length,g;for(g=0;g<v;g++)a[o+g]=p[g],n[o+g]=f[g]}return function(a){var o=a.length;if(o<=0)return a;for(var u=1;u<o;u*=2)i(a,o,u)}(t)}function pa(t,e){const r=new Array(t.length);return e.forEach((n,i)=>r[n]=t[i]),r}function bm(t,e){const r=[];let n=0;for(let s=0;s<e;s++){const a=Math.floor(t/e);r.push(a),n+=a}const i=t-n;for(let s=0;s<i;s++)r[s]+=1;return r}function fa(t,e,r){const n=Math.floor(Math.log2(r)),i=la(e);ha(e,i,"desc");const s=e.map(l=>Math.floor(Math.log2(l))),a=[1,1,1],o=[1,1,1],u=t.length,c=bm(n,u);if(u===0)throw new Error("target length must greater than 1");if(u>=1&&u<=3)for(let l=0;l<u;l++){a[l]=Math.min(t[l],Math.pow(2,Math.min(s[l],c[l])));const d=c[l]-Math.ceil(Math.log2(a[l]));c[l+1]+=d,o[l]=Math.ceil(t[l]/a[l])}else throw new Error("target length must less than 3");return{chunkSize:pa(a,i),dispatchSize:pa(o,i),order:i}}const dt=["x","y","z"];function wm(t,e,r,n,i,s){const a=la(i);ha(i,a,"desc");const o=new Array(3).fill(1),u=new Array(3).fill(1),c=a[0];if(o[c]=Math.min(Math.min(n,s),Math.min(e,i[0])),u[c]=Math.ceil(e/o[c]),r){const l=fa(t,[i[1],i[2]],Math.floor(s/o[c]));o[a[1]]=l.chunkSize[l.order[0]],o[a[2]]=l.chunkSize[l.order[1]],u[a[1]]=l.dispatchSize[l.order[0]],u[a[2]]=l.dispatchSize[l.order[1]]}else u[a[1]]=t[0],u[a[2]]=t[1];return{chunkSize:o,dispatchSize:u,order:[a[1],a[2],a[0]]}}class Lt{static limit(e){const r=[e.limits.maxComputeWorkgroupSizeX,e.limits.maxComputeWorkgroupSizeY,e.limits.maxComputeWorkgroupSizeZ],n=e.limits.maxComputeInvocationsPerWorkgroup;return{maxComputeWorkgroupLimits:r,maxComputeInvocationsPerWorkgroup:n}}static dispatch(e,r){const{maxComputeWorkgroupLimits:n,maxComputeInvocationsPerWorkgroup:i}=Lt.limit(e);return fa(r,n,i)}static dispatchImageAndSampler(e,r,n,i=!1,s){const{maxComputeWorkgroupLimits:a,maxComputeInvocationsPerWorkgroup:o}=Lt.limit(e);return wm(r,n,i,s??o,a,o)}}function xm(t,e=ht,r,n){const i=n===de.I32?"i32":n===de.U32?"u32":"f32",s=n===de.F16,a=e===ht&&!["f32","f16"].includes(i)?e.replace("* 0.25","/ 4"):e,o=Array(r).fill(0).map((c,l)=>`@group(0) @binding(${l+1}) var dst_mip_${l+1}: texture_storage_2d_array<${t}, write>;`).join(`
`),u=`fn store_dst_mip(value: vec4<SPDScalar>, uv: vec2<u32>, slice: u32, mip: u32) {
${Array(r).fill(0).map((c,l)=>l==5&&r>6?` else if mip == 6 {
                    textureStore(dst_mip_6, uv, slice, ${s?`vec4<${i}>(value)`:"value"});
                    mip_dst_6_buffer[slice][uv.y][uv.x] = value;
                }`:`${l===0?"":" else "}if mip == ${l+1} {
                textureStore(dst_mip_${l+1}, uv, slice, ${s?`vec4<${i}>(value)`:"value"});
            }`).join("")}
}`;return`
    // This file is part of the FidelityFX SDK.
//
// Copyright (C) 2023 Advanced Micro Devices, Inc.
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy 
// of this software and associated documentation files(the \u201CSoftware\u201D), to deal 
// in the Software without restriction, including without limitation the rights 
// to use, copy, modify, merge, publish, distribute, sublicense, and /or sell 
// copies of the Software, and to permit persons to whom the Software is 
// furnished to do so, subject to the following conditions :
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED \u201CAS IS\u201D, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.


// Definitions --------------------------------------------------------------------------------------------------------

${s?"enable f16;":""}
alias SPDScalar = ${n};

// Helpers ------------------------------------------------------------------------------------------------------------

/**
 * A helper function performing a remap 64x1 to 8x8 remapping which is necessary for 2D wave reductions.
 * 
 * The 64-wide lane indices to 8x8 remapping is performed as follows:
 *     00 01 08 09 10 11 18 19
 *      02 03 0a 0b 12 13 1a 1b
 *      04 05 0c 0d 14 15 1c 1d
 *      06 07 0e 0f 16 17 1e 1f
 *      20 21 28 29 30 31 38 39
 *      22 23 2a 2b 32 33 3a 3b
 *      24 25 2c 2d 34 35 3c 3d
 *      26 27 2e 2f 36 37 3e 3f
 * 
 * @param a: The input 1D coordinate to remap.
 *
 * @returns The remapped 2D coordinates.
 */
fn remap_for_wave_reduction(a: u32) -> vec2<u32> {
    return vec2<u32>(
        insertBits(extractBits(a, 2u, 3u), a, 0u, 1u),
        insertBits(extractBits(a, 3u, 3u), extractBits(a, 1u, 2u), 0u, 2u)
    );
}

fn map_to_xy(local_invocation_index: u32) -> vec2<u32> {
    let sub_xy: vec2<u32> = remap_for_wave_reduction(local_invocation_index % 64);
    return vec2<u32>(
        sub_xy.x + 8 * ((local_invocation_index >> 6) % 2),
        sub_xy.y + 8 * ((local_invocation_index >> 7))
    );
}

/*
 * Compute a linear value from a SRGB value.
 * 
 * @param value: The value to convert to linear from SRGB.
 * 
 *  @returns A value in SRGB space.
 */
/*
fn srgb_to_linear(value: SPDScalar) -> SPDScalar {
    let j = vec3<SPDScalar>(0.0031308 * 12.92, 12.92, 1.0 / 2.4);
    let k = vec2<SPDScalar>(1.055, -0.055);
    return clamp(j.x, value * j.y, pow(value, j.z) * k.x + k.y);
}
*/

// Resources & Accessors -----------------------------------------------------------------------------------------------
struct DownsamplePassMeta {
    work_group_offset: vec2<u32>,
    num_work_groups: u32,
    mips: u32,
}

// In the original version dst_mip_i is an image2Darray [SPD_MAX_MIP_LEVELS+1], i.e., 12+1, but WGSL doesn't support arrays of textures yet
// Also these are read_write because for mips 7-13, the workgroup reads from mip level 6 - since most formats don't support read_write access in WGSL yet, we use a single read_write buffer in such cases instead
@group(0) @binding(0) var src_mip_0: texture_2d_array<${i}>;
${o}

@group(1) @binding(0) var<uniform> downsample_pass_meta : DownsamplePassMeta;
@group(1) @binding(1) var<storage, read_write> spd_global_counter: array<atomic<u32>>;
@group(1) @binding(2) var<storage, read_write> mip_dst_6_buffer: array<array<array<vec4<f32>, 64>, 64>>;

fn get_mips() -> u32 {
    return downsample_pass_meta.mips;
}

fn get_num_work_groups() -> u32 {
    return downsample_pass_meta.num_work_groups;
}

fn get_work_group_offset() -> vec2<u32> {
    return downsample_pass_meta.work_group_offset;
}

fn load_src_image(uv: vec2<u32>, slice: u32) -> vec4<SPDScalar> {
    return vec4<SPDScalar>(textureLoad(src_mip_0, uv, slice, 0));
}

fn load_mid_mip_image(uv: vec2<u32>, slice: u32) -> vec4<SPDScalar> {
    ${r>6?"return mip_dst_6_buffer[slice][uv.y][uv.x];":"return vec4<SPDScalar>();"}
}

${u}

// Workgroup -----------------------------------------------------------------------------------------------------------

var<workgroup> spd_intermediate: array<array<vec4<SPDScalar>, 16>, 16>;
var<workgroup> spd_counter: atomic<u32>;

fn spd_increase_atomic_counter(slice: u32) {
    atomicStore(&spd_counter, atomicAdd(&spd_global_counter[slice], 1));
}

fn spd_get_atomic_counter() -> u32 {
    return atomicLoad(&spd_counter);
}

fn spd_reset_atomic_counter(slice: u32) {
    atomicStore(&spd_global_counter[slice], 0);
}

// Cotnrol flow --------------------------------------------------------------------------------------------------------

fn spd_barrier() {
    // in glsl this does: groupMemoryBarrier(); barrier();
    workgroupBarrier();
}

// Only last active workgroup should proceed
fn spd_exit_workgroup(num_work_groups: u32, local_invocation_index: u32, slice: u32) -> bool {
    // global atomic counter
    if (local_invocation_index == 0) {
        spd_increase_atomic_counter(slice);
    }
    spd_barrier();
    return spd_get_atomic_counter() != (num_work_groups - 1);
}

// Pixel access --------------------------------------------------------------------------------------------------------

${a}

fn spd_store(pix: vec2<u32>, out_value: vec4<SPDScalar>, mip: u32, slice: u32) {
    store_dst_mip(out_value, pix, slice, mip + 1);
}

fn spd_load_intermediate(x: u32, y: u32) -> vec4<SPDScalar> {
    return spd_intermediate[x][y];
}

fn spd_store_intermediate(x: u32, y: u32, value: vec4<SPDScalar>) {
    spd_intermediate[x][y] = value;
}

fn spd_reduce_intermediate(i0: vec2<u32>, i1: vec2<u32>, i2: vec2<u32>, i3: vec2<u32>) -> vec4<SPDScalar> {
    let v0 = spd_load_intermediate(i0.x, i0.y);
    let v1 = spd_load_intermediate(i1.x, i1.y);
    let v2 = spd_load_intermediate(i2.x, i2.y);
    let v3 = spd_load_intermediate(i3.x, i3.y);
    return spd_reduce_4(v0, v1, v2, v3);
}

fn spd_reduce_load_4(base: vec2<u32>, slice: u32) -> vec4<SPDScalar> {
    let v0 = load_src_image(base + vec2<u32>(0, 0), slice);
    let v1 = load_src_image(base + vec2<u32>(0, 1), slice);
    let v2 = load_src_image(base + vec2<u32>(1, 0), slice);
    let v3 = load_src_image(base + vec2<u32>(1, 1), slice);
    return spd_reduce_4(v0, v1, v2, v3);
}

fn spd_reduce_load_mid_mip_4(base: vec2<u32>, slice: u32) -> vec4<SPDScalar> {
    let v0 = load_mid_mip_image(base + vec2<u32>(0, 0), slice);
    let v1 = load_mid_mip_image(base + vec2<u32>(0, 1), slice);
    let v2 = load_mid_mip_image(base + vec2<u32>(1, 0), slice);
    let v3 = load_mid_mip_image(base + vec2<u32>(1, 1), slice);
    return spd_reduce_4(v0, v1, v2, v3);
}

// Main logic ---------------------------------------------------------------------------------------------------------

fn spd_downsample_mips_0_1(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, mip: u32, slice: u32) {
    var v: array<vec4<SPDScalar>, 4>;

    let workgroup64 = workgroup_id.xy * 64;
    let workgroup32 = workgroup_id.xy * 32;
    let workgroup16 = workgroup_id.xy * 16;

    var tex = workgroup64 + vec2<u32>(x * 2, y * 2);
    var pix = workgroup32 + vec2<u32>(x, y);
    v[0] = spd_reduce_load_4(tex, slice);
    spd_store(pix, v[0], 0, slice);

    tex = workgroup64 + vec2<u32>(x * 2 + 32, y * 2);
    pix = workgroup32 + vec2<u32>(x + 16, y);
    v[1] = spd_reduce_load_4(tex, slice);
    spd_store(pix, v[1], 0, slice);

    tex = workgroup64 + vec2<u32>(x * 2, y * 2 + 32);
    pix = workgroup32 + vec2<u32>(x, y + 16);
    v[2] = spd_reduce_load_4(tex, slice);
    spd_store(pix, v[2], 0, slice);

    tex = workgroup64 + vec2<u32>(x * 2 + 32, y * 2 + 32);
    pix = workgroup32 + vec2<u32>(x + 16, y + 16);
    v[3] = spd_reduce_load_4(tex, slice);
    spd_store(pix, v[3], 0, slice);

    if mip <= 1 {
        return;
    }

    for (var i = 0u; i < 4u; i++) {
        spd_store_intermediate(x, y, v[i]);
        spd_barrier();
        if local_invocation_index < 64 {
            v[i] = spd_reduce_intermediate(
                vec2<u32>(x * 2 + 0, y * 2 + 0),
                vec2<u32>(x * 2 + 1, y * 2 + 0),
                vec2<u32>(x * 2 + 0, y * 2 + 1),
                vec2<u32>(x * 2 + 1, y * 2 + 1)
            );
            spd_store(workgroup16 + vec2<u32>(x + (i % 2) * 8, y + (i / 2) * 8), v[i], 1, slice);
        }
        spd_barrier();
    }

    if local_invocation_index < 64 {
        spd_store_intermediate(x + 0, y + 0, v[0]);
        spd_store_intermediate(x + 8, y + 0, v[1]);
        spd_store_intermediate(x + 0, y + 8, v[2]);
        spd_store_intermediate(x + 8, y + 8, v[3]);
    }
}

fn spd_downsample_mip_2(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, mip: u32, slice: u32) {
    if local_invocation_index < 64u {
        let v = spd_reduce_intermediate(
            vec2<u32>(x * 2 + 0, y * 2 + 0),
            vec2<u32>(x * 2 + 1, y * 2 + 0),
            vec2<u32>(x * 2 + 0, y * 2 + 1),
            vec2<u32>(x * 2 + 1, y * 2 + 1)
        );
        spd_store(workgroup_id.xy * 8 + vec2<u32>(x, y), v, mip, slice);
        // store to LDS, try to reduce bank conflicts
        // x 0 x 0 x 0 x 0 x 0 x 0 x 0 x 0
        // 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
        // 0 x 0 x 0 x 0 x 0 x 0 x 0 x 0 x
        // 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
        // x 0 x 0 x 0 x 0 x 0 x 0 x 0 x 0
        // ...
        // x 0 x 0 x 0 x 0 x 0 x 0 x 0 x 0
        spd_store_intermediate(x * 2 + y % 2, y * 2, v);
    }
}

fn spd_downsample_mip_3(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, mip: u32, slice: u32) {
    if local_invocation_index < 16u {
        // x 0 x 0
        // 0 0 0 0
        // 0 x 0 x
        // 0 0 0 0
        let v = spd_reduce_intermediate(
            vec2<u32>(x * 4 + 0 + 0, y * 4 + 0),
            vec2<u32>(x * 4 + 2 + 0, y * 4 + 0),
            vec2<u32>(x * 4 + 0 + 1, y * 4 + 2),
            vec2<u32>(x * 4 + 2 + 1, y * 4 + 2)
        );
        spd_store(workgroup_id.xy * 4 + vec2<u32>(x, y), v, mip, slice);
        // store to LDS
        // x 0 0 0 x 0 0 0 x 0 0 0 x 0 0 0
        // 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
        // 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
        // 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
        // 0 x 0 0 0 x 0 0 0 x 0 0 0 x 0 0
        // ...
        // 0 0 x 0 0 0 x 0 0 0 x 0 0 0 x 0
        // ...
        // 0 0 0 x 0 0 0 x 0 0 0 x 0 0 0 x
        // ...
        spd_store_intermediate(x * 4 + y, y * 4, v);
    }
}

fn spd_downsample_mip_4(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, mip: u32, slice: u32) {
    if local_invocation_index < 4u {
        // x 0 0 0 x 0 0 0
        // ...
        // 0 x 0 0 0 x 0 0
        let v = spd_reduce_intermediate(
            vec2<u32>(x * 8 + 0 + 0 + y * 2, y * 8 + 0),
            vec2<u32>(x * 8 + 4 + 0 + y * 2, y * 8 + 0),
            vec2<u32>(x * 8 + 0 + 1 + y * 2, y * 8 + 4),
            vec2<u32>(x * 8 + 4 + 1 + y * 2, y * 8 + 4)
        );
        spd_store(workgroup_id.xy * 2 + vec2<u32>(x, y), v, mip, slice);
        // store to LDS
        // x x x x 0 ...
        // 0 ...
        spd_store_intermediate(x + y * 2, 0, v);
    }
}

fn spd_downsample_mip_5(workgroup_id: vec2<u32>, local_invocation_index: u32, mip: u32, slice: u32) {
    if local_invocation_index < 1u {
        // x x x x 0 ...
        // 0 ...
        let v = spd_reduce_intermediate(vec2<u32>(0, 0), vec2<u32>(1, 0), vec2<u32>(2, 0), vec2<u32>(3, 0));
        spd_store(workgroup_id.xy, v, mip, slice);
    }
}

fn spd_downsample_next_four(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, base_mip: u32, mips: u32, slice: u32) {
    if mips <= base_mip {
        return;
    }
    spd_barrier();
    spd_downsample_mip_2(x, y, workgroup_id, local_invocation_index, base_mip, slice);

    if mips <= base_mip + 1 {
        return;
    }
    spd_barrier();
    spd_downsample_mip_3(x, y, workgroup_id, local_invocation_index, base_mip + 1, slice);

    if mips <= base_mip + 2 {
        return;
    }
    spd_barrier();
    spd_downsample_mip_4(x, y, workgroup_id, local_invocation_index, base_mip + 2, slice);

    if mips <= base_mip + 3 {
        return;
    }
    spd_barrier();
    spd_downsample_mip_5(workgroup_id, local_invocation_index, base_mip + 3, slice);
}

fn spd_downsample_last_four(x: u32, y: u32, workgroup_id: vec2<u32>, local_invocation_index: u32, base_mip: u32, mips: u32, slice: u32, exit: bool) {
    if mips <= base_mip {
        return;
    }
    spd_barrier();
    if !exit {
        spd_downsample_mip_2(x, y, workgroup_id, local_invocation_index, base_mip, slice);
    }

    if mips <= base_mip + 1 {
        return;
    }
    spd_barrier();
    if !exit {
        spd_downsample_mip_3(x, y, workgroup_id, local_invocation_index, base_mip + 1, slice);
    }

    if mips <= base_mip + 2 {
        return;
    }
    spd_barrier();
    if !exit {
        spd_downsample_mip_4(x, y, workgroup_id, local_invocation_index, base_mip + 2, slice);
    }

    if mips <= base_mip + 3 {
        return;
    }
    spd_barrier();
    if !exit {
        spd_downsample_mip_5(workgroup_id, local_invocation_index, base_mip + 3, slice);
    }
}

fn spd_downsample_mips_6_7(x: u32, y: u32, mips: u32, slice: u32) {
    var tex = vec2<u32>(x * 4 + 0, y * 4 + 0);
    var pix = vec2<u32>(x * 2 + 0, y * 2 + 0);
    let v0 = spd_reduce_load_mid_mip_4(tex, slice);
    spd_store(pix, v0, 6, slice);

    tex = vec2<u32>(x * 4 + 2, y * 4 + 0);
    pix = vec2<u32>(x * 2 + 1, y * 2 + 0);
    let v1 = spd_reduce_load_mid_mip_4(tex, slice);
    spd_store(pix, v1, 6, slice);

    tex = vec2<u32>(x * 4 + 0, y * 4 + 2);
    pix = vec2<u32>(x * 2 + 0, y * 2 + 1);
    let v2 = spd_reduce_load_mid_mip_4(tex, slice);
    spd_store(pix, v2, 6, slice);

    tex = vec2<u32>(x * 4 + 2, y * 4 + 2);
    pix = vec2<u32>(x * 2 + 1, y * 2 + 1);
    let v3 = spd_reduce_load_mid_mip_4(tex, slice);
    spd_store(pix, v3, 6, slice);

    if mips <= 7 {
        return;
    }
    // no barrier needed, working on values only from the same thread

    let v = spd_reduce_4(v0, v1, v2, v3);
    spd_store(vec2<u32>(x, y), v, 7, slice);
    spd_store_intermediate(x, y, v);
}

fn spd_downsample_last_6(x: u32, y: u32, local_invocation_index: u32, mips: u32, num_work_groups: u32, slice: u32) {
    if mips <= 6 {
        return;
    }

    // increase the global atomic counter for the given slice and check if it's the last remaining thread group:
    // terminate if not, continue if yes.
    let exit = spd_exit_workgroup(num_work_groups, local_invocation_index, slice);

    // can't exit directly because subsequent barrier calls break uniform control flow...
    if !exit {
        // reset the global atomic counter back to 0 for the next spd dispatch
        spd_reset_atomic_counter(slice);

        // After mip 5 there is only a single workgroup left that downsamples the remaining up to 64x64 texels.
        // compute MIP level 6 and 7
        spd_downsample_mips_6_7(x, y, mips, slice);
    }

    // compute MIP level 8, 9, 10, 11
    spd_downsample_last_four(x, y, vec2<u32>(0, 0), local_invocation_index, 8, mips, slice, exit);
}

/// Downsamples a 64x64 tile based on the work group id.
/// If after downsampling it's the last active thread group, computes the remaining MIP levels.
///
/// @param [in] workGroupID             index of the work group / thread group
/// @param [in] localInvocationIndex    index of the thread within the thread group in 1D
/// @param [in] mips                    the number of total MIP levels to compute for the input texture
/// @param [in] numWorkGroups           the total number of dispatched work groups / thread groups for this slice
/// @param [in] slice                   the slice of the input texture
fn spd_downsample(workgroup_id: vec2<u32>, local_invocation_index: u32, mips: u32, num_work_groups: u32, slice: u32) {
    let xy = map_to_xy(local_invocation_index);
    spd_downsample_mips_0_1(xy.x, xy.y, workgroup_id, local_invocation_index, mips, slice);
    spd_downsample_next_four(xy.x, xy.y, workgroup_id, local_invocation_index, 2, mips, slice);
    ${r>6?"spd_downsample_last_6(xy.x, xy.y, local_invocation_index, mips, num_work_groups, slice);":""}
}

// Entry points -------------------------------------------------------------------------------------------------------

@compute
@workgroup_size(256, 1, 1)
fn downsample(@builtin(local_invocation_index) local_invocation_index: u32, @builtin(workgroup_id) workgroup_id: vec3<u32>) {
    spd_downsample(
        workgroup_id.xy + get_work_group_offset(),
        local_invocation_index,
        get_mips(),
        get_num_work_groups(),
        workgroup_id.z
    );
}
    `}const ht=`
fn spd_reduce_4(v0: vec4<SPDScalar>, v1: vec4<SPDScalar>, v2: vec4<SPDScalar>, v3: vec4<SPDScalar>) -> vec4<SPDScalar> {
    return (v0 + v1 + v2 + v3) * 0.25;
}
`,km=`
fn spd_reduce_4(v0: vec4<SPDScalar>, v1: vec4<SPDScalar>, v2: vec4<SPDScalar>, v3: vec4<SPDScalar>) -> vec4<SPDScalar> {
    return min(min(v0, v1), min(v2, v3));
}
`,Sm=`
fn spd_reduce_4(v0: vec4<SPDScalar>, v1: vec4<SPDScalar>, v2: vec4<SPDScalar>, v3: vec4<SPDScalar>) -> vec4<SPDScalar> {
    return max(max(v0, v1), max(v2, v3));
}
`,ma=`
fn spd_reduce_4(v0: vec4<SPDScalar>, v1: vec4<SPDScalar>, v2: vec4<SPDScalar>, v3: vec4<SPDScalar>) -> vec4<SPDScalar> {
    let max4 = max(max(v0.xy, v1.xy), max(v2.xy, v3.xy));
    return vec4<SPDScalar>(min(min(v0.x, v1.x), min(v2.x, v3.x)), max(max4.x, max4.y), 0, 0);
}
`;var Ke;(function(t){t.Average="average",t.Min="min",t.Max="max",t.MinMax="minmax"})(Ke||(Ke={}));class Tm{constructor(e,r,n){w(this,"pipeline");w(this,"bindGroups");w(this,"dispatchDimensions");this.pipeline=e,this.bindGroups=r,this.dispatchDimensions=n}encode(e){e.setPipeline(this.pipeline),this.bindGroups.forEach((r,n)=>{e.setBindGroup(n,r)}),e.dispatchWorkgroups(...this.dispatchDimensions)}}class Em{constructor(e,r){w(this,"passes");w(this,"target");this.passes=e,this.target=r}encode(e){return this.passes.forEach(r=>r.encode(e)),e.setBindGroup(0,null),e.setBindGroup(1,null),e}get numPasses(){return this.passes.length}}var de;(function(t){t.F32="f32",t.F16="f16",t.I32="i32",t.U32="u32"})(de||(de={}));class Mm{constructor(e,r){w(this,"mipsLayout");w(this,"pipelines");this.mipsLayout=e,this.pipelines=r}}function _a(t,e,r){const n=e.toLocaleLowerCase().includes("sint")?de.I32:e.toLocaleLowerCase().includes("uint")?de.U32:de.F32;return r&&!t.features.has("shader-f16")&&console.warn("[sanitizeScalarType]: half precision requested but the device feature 'shader-f16' is not enabled, falling back to full precision"),r&&n!==de.F32&&console.warn(`[sanitizeScalarType]: half precision requested for non-float format (${e}, uses ${n}), falling back to full precision`),r===!0&&!t.features.has("shader-f16")&&n===de.F32?de.F16:n}class Am{constructor(e,r,n){w(this,"device");w(this,"maxMipsPerPass");w(this,"maxArrayLayers");w(this,"internalResourcesBindGroupLayout");w(this,"internalResourcesBindGroupLayout12");w(this,"atomicCounters");w(this,"midMipBuffers");w(this,"pipelines");this.device=new WeakRef(e),this.maxMipsPerPass=Math.min(e.limits.maxStorageTexturesPerShaderStage,n??12),this.maxArrayLayers=Math.min(e.limits.maxTextureArrayLayers,r??e.limits.maxTextureArrayLayers),this.pipelines=new Map,this.atomicCounters=new Map,this.midMipBuffers=new Map,this.internalResourcesBindGroupLayout=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:16}}]}),this.maxMipsPerPass>6&&(this.internalResourcesBindGroupLayout12=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:16}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage",hasDynamicOffset:!1,minBindingSize:4}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage",hasDynamicOffset:!1,minBindingSize:16*64*64}}]}))}preparePipelines(e){const r=this.device.deref();r&&(e==null||e.forEach(n=>{const i=_a(r,n.format,n.halfPrecision??!1);Array.from(n.filters??[ht]).map(s=>{for(let a=0;a<this.maxMipsPerPass;++a)this.getOrCreatePipeline(n.format,s,a+1,i)})}))}createPipeline(e,r,n,i){const s=this.device.deref();if(!s)return;const a=s.createBindGroupLayout({entries:Array(Math.min(n,this.maxMipsPerPass)+1).fill(0).map((o,u)=>{const c={binding:u,visibility:GPUShaderStage.COMPUTE};return u===0?c.texture={sampleType:i===de.I32?"sint":i===de.U32?"uint":"unfilterable-float",viewDimension:"2d-array",multisampled:!1}:c.storageTexture={access:"write-only",format:e,viewDimension:"2d-array"},c})});return new Mm(a,s.createComputePipeline({compute:{module:s.createShaderModule({code:xm(e,r,Math.min(n,this.maxMipsPerPass),i)}),entryPoint:"downsample"},layout:s.createPipelineLayout({bindGroupLayouts:[a,n>6?this.internalResourcesBindGroupLayout12:this.internalResourcesBindGroupLayout]})}))}getOrCreatePipeline(e,r,n,i){var s,a,o,u,c,l,d,p,f,y,v,g,S,T,E;if(this.pipelines.has(e)||this.pipelines.set(e,new Map),(s=this.pipelines.get(e))!=null&&s.has(i)||((a=this.pipelines.get(e))==null||a.set(i,new Map)),(u=(o=this.pipelines.get(e))==null?void 0:o.get(i))!=null&&u.has(r)||((l=(c=this.pipelines.get(e))==null?void 0:c.get(i))==null||l.set(r,new Map)),!((f=(p=(d=this.pipelines.get(e))==null?void 0:d.get(i))==null?void 0:p.get(r))!=null&&f.has(n))){const M=this.createPipeline(e,r,n,i);M&&((g=(v=(y=this.pipelines.get(e))==null?void 0:y.get(i))==null?void 0:v.get(r))==null||g.set(n,M))}return(E=(T=(S=this.pipelines.get(e))==null?void 0:S.get(i))==null?void 0:T.get(r))==null?void 0:E.get(n)}getOrCreateAtomicCountersBuffer(e,r){if(!this.atomicCounters.has(r)){const n=e.createBuffer({size:4*r,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(n,0,new Uint32Array(Array(r).fill(0))),this.atomicCounters.set(r,n)}return this.atomicCounters.get(r)}getOrCreateMidMipBuffer(e,r){return this.midMipBuffers.has(r)||this.midMipBuffers.set(r,e.createBuffer({size:16*64*64*r,usage:GPUBufferUsage.STORAGE})),this.midMipBuffers.get(r)}createMetaBindGroup(e,r,n){const i=e.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});if(e.queue.writeBuffer(i,0,new Uint32Array([...r.workgroupOffset,r.numWorkGroups,r.numMips])),r.numMips>6){const s=n?Math.ceil(r.numArrayLayers/2):r.numArrayLayers;return e.createBindGroup({layout:this.internalResourcesBindGroupLayout12,entries:[{binding:0,resource:{buffer:i}},{binding:1,resource:{buffer:this.getOrCreateAtomicCountersBuffer(e,s)}},{binding:2,resource:{buffer:this.getOrCreateMidMipBuffer(e,s)}}]})}else return e.createBindGroup({layout:this.internalResourcesBindGroupLayout,entries:[{binding:0,resource:{buffer:i}}]})}preparePass(e,r,n,i,s,a,o){const u=this.device.deref();if(!u)return;const c=[];for(let l=0;l<this.maxArrayLayers-1;l+=this.maxArrayLayers){const d=Math.min(r.depthOrArrayLayers-l,this.maxArrayLayers);for(let p=0;p<a-1;p+=this.maxMipsPerPass){const f=Math.min(a-1-p,this.maxMipsPerPass),y=i.map(P=>Math.trunc(P/Math.pow(2,p))),v=s.map(P=>Math.max(Math.trunc(P/Math.pow(2,p)),1)),g=y.map(P=>Math.trunc(P/64)),S=y.map((P,B)=>Math.trunc((P+v[B]-1)/64)+1-g[B]),T=S.reduce((P,B)=>B*P,1),E=this.createMetaBindGroup(u,{workgroupOffset:g,numWorkGroups:T,numMips:f,numArrayLayers:d},o===de.F16),M=this.getOrCreatePipeline(r.format,n,f,o),A=Array(f+1).fill(0).map((P,B)=>{if(p===0&&B===0)return e.createView({dimension:"2d-array",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l,arrayLayerCount:d});{const D=p+B;return r.createView({dimension:"2d-array",baseMipLevel:e===r?D:D-1,mipLevelCount:1,baseArrayLayer:l,arrayLayerCount:d})}}),L=u.createBindGroup({layout:M.mipsLayout,entries:A.map((P,B)=>({binding:B,resource:P}))});c.push(new Tm(M.pipelines,[L,E],[...S,d]))}}return new Em(c,r)}}function ga(...t){return 1+Math.trunc(Math.log2(Math.max(0,...t)))}class Cm{constructor(e){w(this,"filters");w(this,"devicePipelines");w(this,"supportedFormats",new Set(["rgba8unorm","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","rgba16uint","rgba16sint","rgba16float","r32uint","r32sint","r32float","rg32uint","rg32sint","rg32float","rgba32uint","rgba32sint","rgba32float"]));this.filters=new Map([[Ke.Average,ht],[Ke.Min,km],[Ke.Max,Sm],[Ke.MinMax,ma]]),this.devicePipelines=new Map,e&&this.prepareDeviceResources(e)}static setPreferredLimits(e,r){e||(e={});const n=Math.min((r==null?void 0:r.limits.maxStorageTexturesPerShaderStage)??6,6);return e.maxStorageTexturesPerShaderStage=Math.max(e.maxStorageTexturesPerShaderStage??n,n),e}prepareDeviceResources(e){var r,n;(n=this.getOrCreateDevicePipelines(e.device,e.maxArrayLayersPerPass,e.maxMipsPerPass))==null||n.preparePipelines((r=e==null?void 0:e.formats)==null?void 0:r.map(i=>({...i,filters:new Set(Array.from(i.filters??[]).map(s=>this.filters.get(s)??ht))})))}getOrCreateDevicePipelines(e,r,n){return this.devicePipelines.has(e)||this.devicePipelines.set(e,new Am(e,r,n)),this.devicePipelines.get(e)}deregisterDevice(e){this.devicePipelines.delete(e)}registerFilter(e,r){this.filters.has(e)&&console.warn(`[WebGPUSinglePassDownsampler::registerFilter]: overriding existing filter '${e}'. Previously generated pipelines are not affected.`),this.filters.set(e,r)}preparePass(e,r,n){var d;const i=(n==null?void 0:n.target)??r,s=(n==null?void 0:n.filter)??Ke.Average,a=((n==null?void 0:n.offset)??[0,0]).map((p,f)=>Math.max(0,Math.min(p,(f===0?r.width:r.height)-1))),o=((n==null?void 0:n.size)??[r.width,r.height]).map((p,f)=>Math.max(0,Math.min(p,(f===0?r.width:r.height)-a[f]))),u=Math.min(Math.max((n==null?void 0:n.numMips)??i.mipLevelCount,0),ga(...o));if(u<2){console.warn(`[WebGPUSinglePassDownsampler::prepare]: no mips to create (numMips = ${u})`);return}if(!this.supportedFormats.has(i.format))throw new Error(`[WebGPUSinglePassDownsampler::prepare]: format ${i.format} not supported. (Supported formats: ${this.supportedFormats})`);if(i.format==="bgra8unorm"&&!e.features.has("bgra8unorm-storage"))throw new Error(`[WebGPUSinglePassDownsampler::prepare]: format ${i.format} not supported without feature 'bgra8unorm-storage' enabled`);if(i.width<Math.max(1,Math.floor(o[0]/2))||i.height<Math.max(1,Math.floor(o[1]/2)))throw new Error(`[WebGPUSinglePassDownsampler::prepare]: target too small (${[i.width,i.height]}) for input size ${o}`);if(i.dimension!=="2d"||r.dimension!=="2d")throw new Error("[WebGPUSinglePassDownsampler::prepare]: texture or target is not a 2d texture");this.filters.has(s)||console.warn(`[WebGPUSinglePassDownsampler::prepare]: unknown filter ${s}, falling back to average`),s===ma&&i.format.includes("r32")&&console.warn(`[WebGPUSinglePassDownsampler::prepare]: filter ${s} makes no sense for one-component target format ${i.format}`);const c=this.filters.get(s)??ht,l=_a(e,i.format,(n==null?void 0:n.halfPrecision)??!1);return(d=this.getOrCreateDevicePipelines(e))==null?void 0:d.preparePass(r,i,c,a,o,u,l)}generateMipmaps(e,r,n){const i=this.preparePass(e,r,n);if(i){const s=e.createCommandEncoder();return i==null||i.encode(s.beginComputePass()).end(),e.queue.submit([s.finish()]),!0}else return!1}}const Pm=(t,e,r,n)=>{let i=`const mipLevels = array<u32, ${n.length}>(`;n.forEach(u=>{i+=`
    ${u},`}),i+=`
);
`;const[s,a,o]=r;return`
@group(0) @binding(0) var inputTexture: texture_2d<f32>; 
@group(0) @binding(1) var filteredTexture: texture_storage_2d_array<${t}, write>;  

${i}
${$i}

fn biFilter(left_bottom: vec4f, left_top: vec4f, right_bottom: vec4f, right_top: vec4f, gap: vec2f) -> vec4f {
  let a = mix(left_bottom, left_top, gap.y);
  let b = mix(right_bottom, right_top, gap.y);
  return mix(a, b, gap.x);
}

@compute @workgroup_size(${e.join(",")})
fn main(
  @builtin(global_invocation_id) id: vec3u,
  @builtin(workgroup_id) workgroup_id : vec3<u32>,
) {
  let pos = id.${dt[s]}${dt[a]};
  let size = textureDimensions(inputTexture, 0u);
  let tc = textureUV(pos, size);

  let m_idx = workgroup_id.${dt[o]};
  let mipLevel = mipLevels[m_idx];

  // remap to mip size
  let mip_size = textureDimensions(inputTexture, mipLevel);
  let grid = textureGrid(tc, mip_size);
  let left_bottom = vec2u(grid.xy);
  let left_top = left_bottom + vec2u(0u, 1u);  // \u4F1A\u81EA\u52A8\u622A\u65AD\uFF0C\u6216\u8005\u8FD4\u56DE 0\uFF0C\u56E0\u6B64\u4E0D\u9700\u8981\u624B\u52A8\u622A\u65AD
  let right_bottom = left_bottom + vec2u(1u, 0u); 
  let right_top = left_bottom + vec2u(1u, 1u); 
  let gap = grid.zw;

  let res1 = textureLoad(inputTexture, left_bottom, mipLevel);
  let res2 = textureLoad(inputTexture, left_top, mipLevel);
  let res3 = textureLoad(inputTexture, right_bottom, mipLevel);
  let res4 = textureLoad(inputTexture, right_top, mipLevel);
  
  let res = biFilter(res1, res2, res3, res4, gap);
  textureStore(filteredTexture, pos, m_idx, res);
}
`};function va(t,e){return t.map(r=>Math.max(1,Math.floor(r/2**e)))}class Om{constructor(e,r){w(this,"computePass");w(this,"needEndPass");w(this,"downsampler");w(this,"commandEncoder");this.device=e,r?(this.computePass=r,this.needEndPass=!1):(this.commandEncoder=e.createCommandEncoder(),this.computePass=this.commandEncoder.beginComputePass(),this.needEndPass=!0),this.downsampler=new Cm}generateMipmaps(e,r){const n=this.downsampler.preparePass(this.device,e,r);return n?(n==null||n.encode(this.computePass),this.tryEnd(),!0):!1}tryEnd(){this.needEndPass&&(this.computePass.end(),this.device.queue.submit([this.commandEncoder.finish()]))}extractMipmap(e,r){const n=[e.width,e.height],i=e.format;if(i!==r.texture.format)throw new Error("extractMipmap target format must same with src texture format");if(n[0]!==r.texture.width||n[1]!==r.texture.height)throw new Error("extractMipmap target size must same with src texture size");const s=r.mipLevels,{chunkSize:a,dispatchSize:o,order:u}=Lt.dispatch(this.device,n),c=ra(Pm(i,a,u,s),this.device);o[u[2]]=s.length;const l=this.device.createBindGroup({layout:c.getBindGroupLayout(0),entries:[{binding:0,resource:e.createView()},{binding:1,resource:r.texture.createView({dimension:"2d-array"})}]});this.computePass.setPipeline(c),this.computePass.setBindGroup(0,l),this.computePass.dispatchWorkgroups(o[0],o[1],o[2]),this.tryEnd()}}const Bm=(t,e,r,n,i,s,a=1e4,o=1e4)=>{const[u,c,l]=s,d=dt[l],p=n[l];console.log(`N: u32(${p})*${i}`);let f=`const mipLevels: array<f32, ${r.length}> = array(`;return r.forEach(y=>f+=`${y},`),f+=");",Rt`

@group(0) @binding(0) var envMap: texture_2d<f32>;
@group(0) @binding(1) var diffuseMap: texture_storage_2d<${e}, write>;
@group(0) @binding(2) var specularMap: texture_storage_2d<${e}, write>;
@group(0) @binding(3) var _sampler: sampler;
@group(0) @binding(4) var<uniform> roughness: f32;

var<workgroup> diffuse_radiance: array<atomic<u32>, 3>;
var<workgroup> specular_radiance: array<atomic<u32>, 3>;

const PI = 3.141592653589793;
const DIFFUSE_INT: f32 = ${a};
const SPECULAR_INT: f32 = ${o};
${f}

fn roughness2shininess(roughness: f32) -> f32 {
  return pow(1000.0, 1.-roughness);
}

${$i}
${Hi}
${Td}
${Ed}

${Gr(t,"_sampler")}

fn diffuse_sample(random: vec2f, TBN: mat3x3f) -> vec3f {
  let phi = 2.0*PI*random.x;
  let theta = asin(sqrt(random.y));
  let pos = TBN * SphereCoord2Dir(phi, theta);
  let uv = Dir2SphereTexCoord(pos);
  let radiance = texture(envMap, uv, mipLevels[0]).rgb;
  return radiance;
}

fn specular_sample(random: vec2f, TBN: mat3x3f, shininess: f32) -> vec3f {
  let phi = 2.0*PI*random.x;
  let theta = acos( pow(1.0-random.y, 1.0/(1.0+shininess)) );
  let pos = TBN * SphereCoord2Dir(phi, theta);
  let uv = Dir2SphereTexCoord(pos);
  let radiance = texture(envMap, uv, mipLevels[1]).rgb;
  return radiance;
}

fn add_radiance(diffuse_dispatch_rad: vec3f, specular_dispatch_rad: vec3f){
  atomicAdd(&diffuse_radiance[0], u32(diffuse_dispatch_rad.x*DIFFUSE_INT));
  atomicAdd(&diffuse_radiance[1], u32(diffuse_dispatch_rad.y*DIFFUSE_INT));
  atomicAdd(&diffuse_radiance[2], u32(diffuse_dispatch_rad.z*DIFFUSE_INT));

  atomicAdd(&specular_radiance[0], u32(specular_dispatch_rad.x*SPECULAR_INT));
  atomicAdd(&specular_radiance[1], u32(specular_dispatch_rad.y*SPECULAR_INT));
  atomicAdd(&specular_radiance[2], u32(specular_dispatch_rad.z*SPECULAR_INT));
}

fn read_radiance() -> array<vec3f,2> {
  let fin_diffuse_radiance = vec3f(
          f32(atomicLoad(&diffuse_radiance[0])),
          f32(atomicLoad(&diffuse_radiance[1])),
          f32(atomicLoad(&diffuse_radiance[2])));
  let fin_specular_radiance = vec3f(
        f32(atomicLoad(&specular_radiance[0])),
        f32(atomicLoad(&specular_radiance[1])),
        f32(atomicLoad(&specular_radiance[2])));
  return array(fin_diffuse_radiance / DIFFUSE_INT, fin_specular_radiance / SPECULAR_INT);
}


@compute @workgroup_size(${n.join(",")})
fn main(
  @builtin(workgroup_id) id: vec3u,
  @builtin(local_invocation_id) local_invocation_id: vec3u,
) {
  let pixel = id.${dt[u]}${dt[c]};
  let size = textureDimensions(specularMap);
  let tc = textureUV(pixel, size);

  let normal = SphereTexCoord2Dir(tc);
  let TBN = getNormalSpace(normal);

  let N = u32(${p})*${i};
  var diffuse_dispatch_rad = vec3f(0.0);
  var specular_dispatch_rad = vec3f(0.0);

  let shininess = roughness2shininess(roughness);

  for(var j=0u; j<${i}; j++){
    let i = local_invocation_id.${d} + j*${p};
    let random = hammersley(i, N);
    diffuse_dispatch_rad += diffuse_sample(random, TBN);
    specular_dispatch_rad += specular_sample(random, TBN, shininess);
  }

  add_radiance(diffuse_dispatch_rad, specular_dispatch_rad);
  workgroupBarrier();
  let fin_radiance = read_radiance();

  var fin_diffuse_radiance = fin_radiance[0];
  fin_diffuse_radiance /= f32(N);

  var fin_specular_radiance = fin_radiance[1];
  fin_specular_radiance /= (f32(N)*(1.0+shininess)/(2.0+shininess));

  if(roughness<=0.0){
    textureStore(diffuseMap, pixel, vec4f(fin_diffuse_radiance,1.0));
  }
  textureStore(specularMap, pixel, vec4f(fin_specular_radiance,1.0));
}
`},Nm=t=>Rt`

const PI = 3.141592653589793;

struct Uniforms {
  viewDirectionProjectionInverse: mat4x4f,
}

@group(0) @binding(0) var<uniform> uni: Uniforms;
@group(0) @binding(1) var ourSampler: sampler;
@group(0) @binding(2) var ourTexture: texture_2d<f32>;

fn Dir2SphereCoord(dir: vec3f) -> vec2f {
  let theta = acos(dir.y);
  let phi = atan2(dir.z, dir.x);
  return vec2f(phi, theta);
}

fn Dir2SphereTexCoord(dir: vec3f) -> vec2f {
  let angle = Dir2SphereCoord(dir);
  let s = 0.5 - angle.x / (2.0*PI);
  let t = 1.0 - angle.y / PI;
  return vec2f(s, t);
}

${Gr(t,"ourSampler")}

@fragment
fn main(@location(1) pos: vec4f) -> @location(0) vec4f {
  let t = uni.viewDirectionProjectionInverse * pos;
  let n_t  = normalize(t.xyz / t.w) * vec3f(1.0, -1.0, 1.0);
  return texture(ourTexture, Dir2SphereTexCoord(n_t), 0.0);
}
`;function cn(t){const e=!t;return{sampleType:e?"float":"unfilterable-float",type:e?"filtering":"non-filtering"}}function ya(t,e){return t?e.get({}):e.default}const Ge=class Ge{constructor(e,r){this.hdrReturn=e,this.options=r}build({device:e,format:r,depthFormat:n=je.depthFormat,cached:i}){var p,f;const{color:s,width:a,height:o}=this.hdrReturn,{mipmaps:u=!0}=this.options??{},c="rgba32float";this.polyfill=!e.features.has("float32-filterable"),this.sampler=ya(this.polyfill,i.sampler),this.texture=e.createTexture({format:c,mipLevelCount:u?ga(a,o):1,size:[a,o],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),e.queue.writeTexture({texture:this.texture},s,{bytesPerRow:a*16},{width:a,height:o}),this.diffuseTexure=sa(e,c,[a,o]),this.specularTexure=sa(e,c,[a,o],{mipLevelCount:Math.min(this.texture.mipLevelCount,((f=(p=this.options)==null?void 0:p.specular)==null?void 0:f.roughnessDetail)??5)});const{sampleType:l,type:d}=cn(this.polyfill);this.renderPipeline=na(ia(),Nm(this.polyfill),e,r,[null],{layout:e.createPipelineLayout({bindGroupLayouts:[e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:d}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:l}}]})]}),depthStencil:{format:n,depthWriteEnabled:!0,depthCompare:"less-equal"}}),this.uniformBuffer=e.createBuffer({size:4*4*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.bindGroup=e.createBindGroup({layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:this.sampler},{binding:2,resource:this.texture.createView()}]})}getBufferView(){var e,r,n,i;return{diffuseColor:((e=this.options)==null?void 0:e.diffuseColor)??[1,1,1,1],specularColor:((r=this.options)==null?void 0:r.specularColor)??[1,1,1,1],diffuseFactor:((n=this.options)==null?void 0:n.diffuseFactor)??[.2,.2,.2],specularFactor:((i=this.options)==null?void 0:i.specularFactor)??[.2,.2,.2],specularDetails:this.specularTexure.mipLevelCount}}render(e,r,n){const i=j.inverse(j.multiply(n.matrix,n.viewMatrix)),s=new Float32Array(4*4);s.set(i),r.queue.writeBuffer(this.uniformBuffer,0,s),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroup),e.draw(3)}};w(Ge,"features",["float32-filterable"]),w(Ge,"defs"),w(Ge,"view"),(()=>{try{Ge.defs=Ht(yi),Ge.view=vt(Ge.defs.uniforms[Fe])}catch{}})();let Ue=Ge;class Lm extends Ue{constructor(r,n){super(r,n);w(this,"hasGeneratedMips",!1)}done(){this.doned||(this.doned=!0)}compute(r,n){var c,l,d,p;this.hasGeneratedMips||(new Om(n,r).generateMipmaps(this.texture),this.hasGeneratedMips=!0);const i=[((l=(c=this.options)==null?void 0:c.diffuse)==null?void 0:l.mipLevel)??6,((p=(d=this.options)==null?void 0:d.specular)==null?void 0:p.mipLevel)??4],{pipeline:s,createBindGroup:a,dispatchSize:o,roughnesses:u}=this.build_IBL_BRDF_IS_ComputePass(n,i);r.setPipeline(s);for(let f=0;f<u.length;f++){r.setBindGroup(0,a(f));const y=va([o[1],o[2]],f);r.dispatchWorkgroups(1,y[0],y[1])}}generateRoughness(r){const n=[];for(let i=0;i<r;i++)n.push(i/(r-1));return n}build_IBL_BRDF_IS_ComputePass(r,n){var g,S,T,E,M;const i=this.specularTexure.mipLevelCount;console.log(`roughness details: ${i}`);const{width:s,height:a,format:o}=this.texture,u=this.generateRoughness(i),c=((g=this.options)==null?void 0:g.samplers)??512,{chunkSize:l,dispatchSize:d,order:p}=Lt.dispatchImageAndSampler(r,[s,a],c);console.log(`sample chunk size: ${l}, sample dispatch size: ${d}, order: ${p}`);const{sampleType:f,type:y}=cn(this.polyfill);console.log(`float32-filterable ${this.polyfill?"not":""} supported`,f,y,this.polyfill?"use polyfill":"");const v=ra(Bm(this.polyfill,o,n,l,d[p[2]],p,((T=(S=this.options)==null?void 0:S.diffuse)==null?void 0:T.INT)??1e4,((M=(E=this.options)==null?void 0:E.specular)==null?void 0:M.INT)??1e4),r,{layout:r.createPipelineLayout({bindGroupLayouts:[r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:f}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:o}},{binding:2,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:o}},{binding:3,visibility:GPUShaderStage.COMPUTE,sampler:{type:y}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]})]})});return{pipeline:v,createBindGroup:A=>{const L=r.createBuffer({size:4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});return r.queue.writeBuffer(L,0,new Float32Array([u[A]])),r.createBindGroup({layout:v.getBindGroupLayout(0),entries:[{binding:0,resource:this.texture.createView()},{binding:1,resource:this.diffuseTexure.createView()},{binding:2,resource:this.specularTexure.createView({mipLevelCount:1,baseMipLevel:A})},{binding:3,resource:this.sampler},{binding:4,resource:{buffer:L}}]})},dispatchSize:d,roughnesses:u}}}class Im{async load(e,r){const n=await new ym().load(e,{sRGB:!1,uint8:!1});return new Lm(n,r)}}class zm{}class ba extends zm{constructor(r){super();w(this,"cached",new Map);this.device=r}get(r){const n=Cd.filter(this.cached.keys(),i=>Ms(JSON.parse(i),r));if(n.length==0){const i=this.create(r);return this.cached.set(JSON.stringify(r),i),i}else{if(n.length==1)return this.cached.get(n[0]);throw new Error("The key is duplicated")}}clear(){this.cached.clear()}delete(r){return this.cached.delete(JSON.stringify(r))}get default(){return this.get(this._default)}}class Um extends ba{constructor(){super(...arguments);w(this,"_default",{addressModeU:"repeat",addressModeV:"repeat",minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"})}create(r){return this.device.createSampler(r)}}const Gm={opaqueWhiteTexture:[1,1,1,1],transparentBlackTexture:[0,0,0,0],defaultNormalTexture:[.5,.5,1,1]};class Fm extends ba{constructor(){super(...arguments);w(this,"_default",{format:je.renderFormat.split("-")[0],type:"transparentBlackTexture"})}create({format:r,type:n}){console.log("creat texture",r,n);const i=new Uint8Array(Gm[n].map(a=>a*255)),s=this.device.createTexture({size:[1,1],format:r,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.device.queue.writeTexture({texture:s},i,{},{width:1,height:1}),s}}class Ae{static getClassName(e){return e.constructor.name}static is(e,r){return Reflect.has(e,r)}static isRenderable(e){return Ae.is(e,"render")}static isBuildable(e){return Ae.is(e,"build")}static isUpdatable(e){return Ae.is(e,"update")}static isComputable(e){return Ae.is(e,"compute")}}class Rm{constructor(e,r){w(this,"polyfill");w(this,"options");w(this,"device");w(this,"buildOptions");w(this,"bindGroupLayout");w(this,"bindGroup");w(this,"cameras",[]);w(this,"mainCamera",null);w(this,"lights",[]);w(this,"buffers",[]);w(this,"children",[]);w(this,"updates",[]);w(this,"needUpdateLightBuffer",!0);w(this,"maxLight",50);w(this,"lightCount",0);var o,u;this.renderer=e,this.options={showEnvMap:!0,...r},this.device=e.device,this.buildOptions={device:this.device,format:this.renderer.format,depthFormat:this.renderer.depthFormat,scene:this,cached:{sampler:new Um(this.device),solidColorTexture:new Fm(this.device)}};const n=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}],i=!!this.options.envMap;i&&!((o=this.options.envMap)!=null&&o.doned)&&((u=this.options.envMap)==null||u.build(this.buildOptions)),this.polyfill=!this.device.features.has(Ue.features[0]);const{sampleType:s,type:a}=cn(this.polyfill);n.push({binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:s}}),n.push({binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:s}}),n.push({binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}),n.push({binding:5,visibility:GPUShaderStage.FRAGMENT,sampler:{type:a}}),this.buffers[2]=i?this.options.envMap.diffuseTexure.createView():this.buildOptions.cached.solidColorTexture.default.createView(),this.buffers[3]=i?this.options.envMap.specularTexure.createView():this.buildOptions.cached.solidColorTexture.default.createView(),this.buffers[4]=this.device.createBuffer({size:Ue.view.arrayBuffer.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.buffers[5]=ya(this.polyfill,this.buildOptions.cached.sampler),this.bindGroupLayout=this.device.createBindGroupLayout({entries:n}),this.buffers[0]=this.device.createBuffer({size:We.view.arrayBuffer.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.makeBindGroup(1)}add(e){if(Ae.isBuildable(e)&&e.build(this.buildOptions),e instanceof We)this.cameras.push(e),this.mainCamera=e;else if(e instanceof Je)this.lights.push(e),this.lightCount++,this.lightCount>1&&this.lightCount%this.maxLight==1&&this.makeBindGroup(Math.floor(this.lightCount/this.maxLight)+1);else if(Ae.isUpdatable(e))e instanceof Us&&this.add(e.camera),this.updates.push(e);else if(Ae.isRenderable(e))this.children.push(e);else throw new Error(`Unsupported object type: ${Ae.getClassName(e)}`)}makeBindGroup(e){this.buffers[1]=this.device.createBuffer({size:Je.getViewSize(this.maxLight*e),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE}),this.bindGroup=this.device.createBindGroup({layout:this.bindGroupLayout,entries:this.buffers.map((r,n)=>r instanceof GPUBuffer?{binding:n,resource:{buffer:r}}:{binding:n,resource:r})})}setBuffers(){var r,n;We.view.set(this.mainCamera.getBufferView()),this.device.queue.writeBuffer(this.buffers[0],0,We.view.arrayBuffer);const e=Je.view(this.lights.length);e.set({lightNums:this.lights.length,lights:this.lights.map(i=>i.getBufferView())}),this.device.queue.writeBuffer(this.buffers[1],0,e.arrayBuffer,0,e.arrayBuffer.byteLength),Ue.view.set((n=(r=this.options)==null?void 0:r.envMap)==null?void 0:n.getBufferView()),this.device.queue.writeBuffer(this.buffers[4],0,Ue.view.arrayBuffer)}set hasEnvMap(e){e!=this.options.showEnvMap&&(this.options.showEnvMap=e,this.buffers[2]=e?this.options.envMap.diffuseTexure.createView():this.buildOptions.cached.solidColorTexture.default.createView(),this.buffers[3]=e?this.options.envMap.specularTexure.createView():this.buildOptions.cached.solidColorTexture.default.createView(),this.makeBindGroup(1))}render(e){var r;if(!e)this.renderer.render(this);else{if(!this.mainCamera)return;this.updates.forEach(n=>n.update()),this.options.showEnvMap&&((r=this.options.envMap)==null||r.render(e,this.device,this.mainCamera)),this.setBuffers(),e.setBindGroup(0,this.bindGroup),this.children.forEach(n=>n.render(e,this.device))}}}const zt=class zt{constructor(e){w(this,"className");w(this,"parentID");this.className=e==null?void 0:e.className,this.parentID=e==null?void 0:e.parentID}static __collectDeviceFeatures(){return[...zt.features,...Ue.features]}static requestDeviceFeatures(...e){e.push(...e)}async checkSupport(){const e=await dm({},{requiredFeatures:zt.__collectDeviceFeatures()}),{device:r,format:n}=e,i=an(500,500,{device:r,format:n},this.className,this.parentID);return Object.assign(this,{...e,...i,depthFormat:je.depthFormat}),this}render(e){var u,c;const r=this.device.createCommandEncoder(),n=((u=e.options)==null?void 0:u.realtime)??!1,i=(c=e.options)==null?void 0:c.envMap;if(i&&(!n&&!i.doned||n)){const l=r.beginComputePass();i.compute(l,this.device),l.end()}const s=this.ctx.getCurrentTexture(),a=je.createDepthTexture(this.device,[s.width,s.height]),o=r.beginRenderPass({colorAttachments:[{loadOp:"clear",storeOp:"store",view:s.createView()}],depthStencilAttachment:{depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",view:a.createView()}});if(e.render(o),o.end(),i&&!i.doned){const l=new fm(this.device,r),d=[i.specularTexure.width,i.specularTexure.height];l.render(i.diffuseTexure,{});for(let p=0;p<i.specularTexure.mipLevelCount;p++){const f=va(d,p);l.render(i.specularTexure,{baseMipLevel:p,mipLevelCount:1},{width:f[0],height:f[1]})}}this.device.queue.submit([r.finish()]),!n&&i&&i.done()}};w(zt,"features",[]);let ln=zt;const sr=class sr{constructor(e){w(this,"root");w(this,"bar");w(this,"text");w(this,"canHidden",!1);w(this,"transitionDuration",.1);this.root=document.createElement("div"),this.root.className="loading-bar",this.root.innerHTML=sr.html,(e??document.body).appendChild(this.root),this.bar=document.querySelector(".bar-container .progress"),this.text=document.querySelector(".bar-container .tip"),new MutationObserver(r=>{r.forEach(n=>{n.type=="attributes"&&n.attributeName=="style"&&n.target.style.width=="100%"&&(this.canHidden=!0)})}).observe(this.bar,{attributes:!0})}setPercentage(e,r,n){this.bar.style.setProperty("width",`${e*100}%`),this.text.textContent=`${r}: ${e*100}%`}showLoading(){this.root.classList.toggle("show")}async hiddenLoading(){this.nextTick(()=>{this.root.classList.toggle("show"),this.bar.style.setProperty("width","0")})}async nextTick(e){await Ad(10,()=>this.canHidden),setTimeout(e)}};w(sr,"html",`
    <div class="bar-container">
      <div class="bar">
        <div class="progress"></div>
      </div>
      <div class="tip">dd</div>
    </div>
  `);let dn=sr;const xe=location.href,wa={avocado:{path:`${xe}gltf/Avocado.glb`,near:.01,far:1e3,eye:[0,0,.2],zoomSpeed:.5},cylinder_engine:{path:`${xe}gltf/2CylinderEngine.glb`,near:.01,far:1e3,eye:[0,0,700],zoomSpeed:70},stone_demon:{path:`${xe}gltf/stone_demon.glb`,near:.01,far:1e3,eye:[0,3,3],zoomSpeed:5},antique_camera:{path:`${xe}glTF-Sample-Models/2.0/AntiqueCamera/glTF-Binary/AntiqueCamera-Interleaved.glb`,near:.01,far:100,eye:[0,10,5],target:[0,4,0],zoomSpeed:5},buggy:{path:`${xe}glTF-Sample-Models/2.0/Buggy/glTF-Binary/Buggy.glb`,near:.01,far:1e3,eye:[100,200,0],target:[0,0,0],zoomSpeed:30},corset:{path:`${xe}glTF-Sample-Models/2.0/Corset/glTF-Binary/Corset.glb`,near:.01,far:1e3,eye:[.1,.1,0],target:[0,.01,0],zoomSpeed:1},damaged_helmet:{path:`${xe}glTF-Sample-Models/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb`,near:.01,far:100,eye:[0,0,5],target:[0,0,0],zoomSpeed:30},flight_helmet:{path:`${xe}glTF-Sample-Models/2.0/FlightHelmet/glTF-Binary/FlightHelmet.glb`,near:.01,far:100,eye:[1,1,0],target:[0,.5,0],zoomSpeed:5},sponza:{path:`${xe}glTF-Sample-Models/2.0/Sponza/glTF-Binary/Sponza.glb`,near:.01,far:100,eye:[5,10,0],target:[0,3,0],zoomSpeed:10}};let hn=!0;const ce={model_name:"stone_demon",flux:10,posLightY:2.2,mips:!1,hasEnvMap:!0,useEnvMap:!0},pt=new um;pt.add(ce,"model_name",Object.keys(wa)).onChange(()=>hn=!0),pt.add(ce,"flux",1,40),pt.add(ce,"posLightY",0,5).name("\u70B9\u5149\u6E90 Y \u4F4D\u7F6E"),pt.add(ce,"mips"),pt.add(ce,"hasEnvMap"),pt.add(ce,"useEnvMap");const ir=document.createElement("div");ir.id="canvas-parent",document.body.appendChild(ir);const pn=new dn(ir),fn=await new ln({parentID:ir.id}).checkSupport().catch(({message:t})=>{const e=document.createElement("div");throw e.innerText=t,document.body.appendChild(e),new Error(t)}),xa=new cm([-1,-1,-1],[1,1,1,1],10),ka=new lm([0,2.2,0],[1,0,0,1],100),Dm=`${xe}image_imageBlaubeurenNight1k.hdr`,Vm=await new Im().load(Dm);async function jm(){const t=wa[ce.model_name],e=new Rm(fn,{envMap:ce.hasEnvMap?Vm:void 0});e.add(xa),e.add(ka);const r=new Rf(ke(75),fn.aspect,t.near,t.far);r.lookAt(t.eye,t.target);const n=new Us(r,fn.canvas,{zoomSpeed:t.zoomSpeed});e.add(n);const i=new Mf;pn.showLoading();const s=await i.load(t.path,{mips:ce.mips,useEnvMap:ce.useEnvMap,onProgress:(a,o)=>{console.log(a,o),pn.setPercentage(o,a)}});return pn.hiddenLoading(),e.add(s),{scene:e,model:s}}let Sa=document.createElement("div");Sa.className="record",document.body.appendChild(Sa);let mn,_n;async function Ta(){if(hn){const t=await jm();mn=t.scene,_n=t.model}xa.flux=ce.flux,ka.pos[1]=ce.posLightY,_n.mips=ce.mips,_n.useEnvMap=ce.useEnvMap,mn.hasEnvMap=ce.hasEnvMap,mn.render(),hn=!1,requestAnimationFrame(Ta)}requestAnimationFrame(Ta)})()});export default Ym();
